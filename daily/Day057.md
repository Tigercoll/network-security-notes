---
title: Day057ï¼šå†…ç½‘åŸºç¡€ - AD/åŸŸåŸºç¡€ä¸é£é™©é¢
tags:
  - ç½‘ç»œ
  - å®‰å…¨
  - å­¦ä¹ è®¡åˆ’
categories:
  - ç½‘ç»œå®‰å…¨
abbrlink: 927deba5
date: 2026-02-19 00:00:00
updated: 2026-02-19 00:00:00

---
# Day057ï¼šå†…ç½‘åŸºç¡€ - AD/åŸŸåŸºç¡€ä¸é£é™©é¢

- æ—¥æœŸï¼š2026-02-19
- å‘¨æ¬¡ï¼šç¬¬9å‘¨

## å­¦ä¹ ç›®æ ‡

ä»Šå¤©ä½ å°†æŒæ¡å†…ç½‘å®‰å…¨ä¸ Active Directory çš„æ ¸å¿ƒçŸ¥è¯†ï¼š

- **ç†è§£åŸŸæ¶æ„**ï¼šæŒæ¡ Active Directory çš„ç»“æ„ã€ç»„ä»¶å’Œæ ¸å¿ƒæ¦‚å¿µ
- **è¯†åˆ«é£é™©é¢**ï¼šèƒ½è¯†åˆ«å†…ç½‘ç¯å¢ƒä¸­çš„å¸¸è§å®‰å…¨é£é™©å’Œæ”»å‡»é¢
- **æŒæ¡èº«ä»½è®¤è¯**ï¼šç†è§£ Kerberosã€NTLM ç­‰è®¤è¯åè®®çš„å·¥ä½œåŸç†
- **ç†è§£ç»„ç­–ç•¥**ï¼šæŒæ¡ç»„ç­–ç•¥çš„ä½œç”¨ã€é…ç½®å’Œå®‰å…¨ç®¡ç†
- **æœ€å°æƒé™åŸåˆ™**ï¼šç†è§£æœ€å°æƒé™åœ¨å†…ç½‘å®‰å…¨ä¸­çš„é‡è¦æ€§

---

<!--more-->

## å­¦ä¹ å†…å®¹

### 1ï¸âƒ£ Active Directory æ¶æ„

#### 1.1 AD æ ¸å¿ƒæ¦‚å¿µ

```python
#!/usr/bin/env python3
"""
Active Directory æ¶æ„è¯´æ˜
"""
from __future__ import annotations
from dataclasses import dataclass, field
from datetime import datetime
from enum import Enum
from typing import Optional, list


class ObjectClass(Enum):
    """AD å¯¹è±¡ç±»å‹"""
    USER = "user"
    COMPUTER = "computer"
    GROUP = "group"
    OU = "organizationalUnit"
    DOMAIN = "domain"
    TRUST = "trust"


class GroupScope(Enum):
    """ç»„ä½œç”¨åŸŸ"""
    DOMAIN_LOCAL = "Domain Local"
    GLOBAL = "Global"
    UNIVERSAL = "Universal"


class GroupType(Enum):
    """ç»„ç±»å‹"""
    SECURITY = "Security"
    DISTRIBUTION = "Distribution"


@dataclass
class ADUser:
    """AD ç”¨æˆ·"""
    cn: str                          # Common Name
    sAMAccountName: str              # ç™»å½•å
    userPrincipalName: str           # UPN
    distinguishedName: str           # DN
    memberOf: list[str] = field(default_factory=list)
    primaryGroupID: str = ""
    department: str = ""
    title: str = ""
    mail: str = ""
    enabled: bool = True
    passwordLastSet: Optional[datetime] = None
    lastLogon: Optional[datetime] = None
    badPwdCount: int = 0


@dataclass
class ADGroup:
    """AD ç»„"""
    cn: str
    sAMAccountName: str
    distinguishedName: str
    groupScope: GroupScope
    groupType: GroupType
    memberOf: list[str] = field(default_factory=list)
    members: list[str] = field(default_factory=list)
    description: str = ""


@dataclass
class ADComputer:
    """AD è®¡ç®—æœº"""
    cn: str
    dNSHostName: str
    distinguishedName: str
    operatingSystem: str = ""
    operatingSystemVersion: str = ""
    servicePack: str = ""
    lastLogon: Optional[datetime] = None
    enabled: bool = True


@dataclass
class ADOrganizationalUnit:
    """AD ç»„ç»‡å•ä½"""
    name: str
    distinguishedName: str
    description: str = ""
    users: list[ADUser] = field(default_factory=list)
    computers: list[ADComputer] = field(default_factory=list)
    childOUs: list[str] = field(default_factory=list)


class ActiveDirectoryStructure:
    """AD ç»“æ„ç®¡ç†"""
    
    def __init__(self, domain_name: str):
        self.domain_name = domain_name
        self.domain_dn = self._domain_to_dn(domain_name)
        self.users: list[ADUser] = []
        self.groups: list[ADGroup] = []
        self.computers: list[ADComputer] = []
        self.ous: list[ADOrganizationalUnit] = []
    
    def _domain_to_dn(self, domain: str) -> str:
        """åŸŸåè½¬ DN"""
        return ",".join([f"DC={part}" for part in domain.split(".")])
    
    def create_user(
        self,
        username: str,
        department: str = "",
        title: str = ""
    ) -> ADUser:
        """åˆ›å»º AD ç”¨æˆ·"""
        user = ADUser(
            cn=username,
            sAMAccountName=username,
            userPrincipalName=f"{username}@{self.domain_name}",
            distinguishedName=f"CN={username},OU=Users,{self.domain_dn}",
            department=department,
            title=title
        )
        self.users.append(user)
        return user
    
    def create_group(
        self,
        name: str,
        scope: GroupScope,
        gtype: GroupType = GroupType.SECURITY
    ) -> ADGroup:
        """åˆ›å»º AD ç»„"""
        group = ADGroup(
            cn=name,
            sAMAccountName=name,
            distinguishedName=f"CN={name},OU=Groups,{self.domain_dn}",
            groupScope=scope,
            groupType=gtype
        )
        self.groups.append(group)
        return group
    
    def add_user_to_group(self, user: ADUser, group: ADGroup) -> None:
        """å°†ç”¨æˆ·æ·»åŠ åˆ°ç»„"""
        user.memberOf.append(group.distinguishedName)
        group.members.append(user.distinguishedName)
    
    def get_privileged_users(self) -> list[ADUser]:
        """è·å–ç‰¹æƒç”¨æˆ·ï¼ˆå±äºç‰¹æƒç»„çš„ç”¨æˆ·ï¼‰"""
        privileged_groups = [
            "Domain Admins",
            "Enterprise Admins",
            "Schema Admins",
            "Administrators"
        ]
        
        privileged = []
        for user in self.users:
            for group_dn in user.memberOf:
                for pg in privileged_groups:
                    if pg.lower() in group_dn.lower():
                        privileged.append(user)
                        break
        
        return privileged
    
    def get_ou_tree(self) -> dict:
        """è·å– OU æ ‘ç»“æ„"""
        return {
            "domain": self.domain_name,
            "ous": [
                {
                    "name": ou.name,
                    "dn": ou.distinguishedName,
                    "users": len(ou.users),
                    "computers": len(ou.computers)
                }
                for ou in self.ous
            ],
            "total_users": len(self.users),
            "total_computers": len(self.computers),
            "total_groups": len(self.groups)
        }
```

#### 1.2 AD ç»„ä»¶è¯¦è§£

```markdown
## Active Directory æ ¸å¿ƒç»„ä»¶

### 1. åŸŸæ§åˆ¶å™¨ (Domain Controller)
- å­˜å‚¨ AD æ•°æ®åº“
- å¤„ç†èº«ä»½è®¤è¯
- å¤åˆ¶ç›®å½•æ•°æ®
- åº”ç”¨ç»„ç­–ç•¥

### 2. ç›®å½•æ•°æ®åº“ (NTDS.DIT)
- å­˜å‚¨æ‰€æœ‰ AD å¯¹è±¡
- å­˜å‚¨å¯†ç å“ˆå¸Œ
- åŒ…å«é…ç½®ä¿¡æ¯
- æ”¯æŒå¤šä¸»å¤åˆ¶

### 3. DNS é›†æˆ
- AD ä½¿ç”¨ DNS å®šä½åŸŸæ§åˆ¶å™¨
- SRV è®°å½•æŒ‡å‘æœåŠ¡ä½ç½®
- åŠ¨æ€æ›´æ–°æ”¯æŒ
- é›†æˆåŒºåŸŸä¼ è¾“

### 4. ä¿¡ä»»å…³ç³» (Trust Relationships)
- åŸŸé—´ä¿¡ä»»
- æ—é—´ä¿¡ä»»
- å¤–éƒ¨ä¿¡ä»»
- å¿«æ·ä¿¡ä»»
```

---

### 2ï¸âƒ£ èº«ä»½è®¤è¯åè®®

#### 2.1 Kerberos è®¤è¯

```python
#!/usr/bin/env python3
"""
Kerberos è®¤è¯æµç¨‹è¯´æ˜
"""
from __future__ import annotations
from dataclasses import dataclass
from datetime import datetime, timedelta
from typing import Optional
import hashlib
import base64


@dataclass
class Principal:
    """Kerberos ä¸»ä½“"""
    name: str          # ç”¨æˆ·å
    realm: str         # åŸŸ
    type: str          # ç”¨æˆ·/æœåŠ¡/è®¡ç®—æœº


@dataclass
class TicketGrantingTicket:
    """TGT ç¥¨æ®"""
    client: Principal
    realm: str
    start_time: datetime
    end_time: datetime
    session_key: bytes
    encrypted_tgt: bytes


@dataclass
class ServiceTicket:
    """æœåŠ¡ç¥¨æ®"""
    client: Principal
    service: Principal
    start_time: datetime
    end_time: datetime
    session_key: bytes
    encrypted_st: bytes


class KerberosSimulation:
    """Kerberos è®¤è¯æ¨¡æ‹Ÿ"""
    
    def __init__(self, realm: str = "CORP.LOCAL"):
        self.realm = realm
        self.kdc_key = b"kdc_secret_key"
    
    def generate_kdc_request(self, client: Principal, service: Principal) -> dict:
        """ç”Ÿæˆ KDC è¯·æ±‚"""
        return {
            "request_type": "KRB_TGS_REQ",
            "client": client.name,
            "service": service.name,
            "timestamp": datetime.now().isoformat()
        }
    
    def issue_tgt(self, client: Principal) -> TicketGrantingTicket:
        """ç­¾å‘ TGT"""
        now = datetime.now()
        session_key = hashlib.sha256(f"{client.name}_session".encode()).digest()[:16]
        
        # æ¨¡æ‹Ÿ TGT æ•°æ®
        tgt_data = {
            "client": client.name,
            "realm": self.realm,
            "start_time": now.isoformat(),
            "end_time": (now + timedelta(hours=10)).isoformat(),
            "session_key": base64.b64encode(session_key).decode()
        }
        
        # æ¨¡æ‹ŸåŠ å¯†ï¼ˆå®é™…ä½¿ç”¨å®¢æˆ·ç«¯å¯†é’¥åŠ å¯†ï¼‰
        encrypted_tgt = base64.b64encode(str(tgt_data).encode()).decode()
        
        return TicketGrantingTicket(
            client=client,
            realm=self.realm,
            start_time=now,
            end_time=now + timedelta(hours=10),
            session_key=session_key,
            encrypted_tgt=encrypted_tgt
        )
    
    def issue_service_ticket(
        self,
        tgt: TicketGrantingTicket,
        service: Principal
    ) -> ServiceTicket:
        """ç­¾å‘æœåŠ¡ç¥¨æ®"""
        now = datetime.now()
        session_key = hashlib.sha256(f"{service.name}_session".encode()).digest()[:16]
        
        st_data = {
            "client": tgt.client.name,
            "service": service.name,
            "start_time": now.isoformat(),
            "end_time": (now + timedelta(hours=8)).isoformat(),
            "session_key": base64.b64encode(session_key).decode()
        }
        
        encrypted_st = base64.b64encode(str(st_data).encode()).decode()
        
        return ServiceTicket(
            client=tgt.client,
            service=service,
            start_time=now,
            end_time=now + timedelta(hours=8),
            session_key=session_key,
            encrypted_st=encrypted_st
        )
    
    def describe_authentication_flow(self) -> str:
        """æè¿°è®¤è¯æµç¨‹"""
        return """
# Kerberos è®¤è¯æµç¨‹

## æ­¥éª¤ 1: å®¢æˆ·ç«¯è®¤è¯è¯·æ±‚
å®¢æˆ·ç«¯å‘ KDC å‘é€ AS-REQï¼ˆè®¤è¯æœåŠ¡è¯·æ±‚ï¼‰
åŒ…å«: å®¢æˆ·ç«¯ IDã€æ—¶é—´æˆ³ã€åŠ å¯†ç±»å‹

## æ­¥éª¤ 2: KDC è¿”å› TGT
KDC éªŒè¯å®¢æˆ·ç«¯èº«ä»½åï¼Œè¿”å› AS-REP
åŒ…å«: åŠ å¯†çš„ TGTã€ä¼šè¯å¯†é’¥

## æ­¥éª¤ 3: å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç¥¨æ®
å®¢æˆ·ç«¯ä½¿ç”¨ TGT å‘ KDC å‘é€ TGS-REQ
åŒ…å«: TGTã€å®¢æˆ·ç«¯ IDã€æœåŠ¡å

## æ­¥éª¤ 4: KDC è¿”å›æœåŠ¡ç¥¨æ®
KDC éªŒè¯ TGT åï¼Œè¿”å› TGS-REP
åŒ…å«: åŠ å¯†çš„æœåŠ¡ç¥¨æ®ã€ä¼šè¯å¯†é’¥

## æ­¥éª¤ 5: å®¢æˆ·ç«¯è®¿é—®æœåŠ¡
å®¢æˆ·ç«¯å‘æœåŠ¡å‘é€ AP-REQ
åŒ…å«: æœåŠ¡ç¥¨æ®ã€è®¤è¯å­åè®®

## æ­¥éª¤ 6: æœåŠ¡éªŒè¯å¹¶å“åº”
æœåŠ¡éªŒè¯ç¥¨æ®åï¼Œå»ºç«‹å®‰å…¨ä¼šè¯
"""
```

#### 2.2 NTLM è®¤è¯

```python
#!/usr/bin/env python3
"""
NTLM è®¤è¯è¯´æ˜
"""
from __future__ import annotations
import hashlib


class NTLMAuthentication:
    """NTLM è®¤è¯"""
    
    @staticmethod
    def lm_hash(password: str) -> bytes:
        """è®¡ç®— LM Hash"""
        # LM Hash ç®—æ³•ï¼ˆå·²åºŸå¼ƒï¼Œä¸å®‰å…¨ï¼‰
        password = password.upper()
        password_bytes = password.encode('utf-8')
        
        # å¡«å……åˆ° 14 å­—èŠ‚
        password_bytes = password_bytes.ljust(14, b'\x00')
        
        # ä¸¤æ¬¡ DES åŠ å¯†
        key1 = password_bytes[:7]
        key2 = password_bytes[7:]
        
        magic = b"KGS!@#$%"
        lm_hash = hashlib.new('md4', key1).digest()
        lm_hash = hashlib.new('md4', lm_hash + key2).digest()
        lm_hash = hashlib.new('md4', lm_hash + magic).digest()
        
        return lm_hash
    
    @staticmethod
    def ntlm_v2_hash(password: str, username: str, domain: str) -> bytes:
        """è®¡ç®— NTLMv2 Hash"""
        password = password.encode('utf-16le')
        username = username.upper().encode('utf-16le')
        domain = domain.upper().encode('utf-16le')
        
        # NTLM å¯†ç å“ˆå¸Œ
        ntlm_hash = hashlib.new('md4', password).digest()
        
        # ç»„åˆæ•°æ®
        data = username + domain
        
        # è®¡ç®— NTLMv2 å“åº”
        response = hashlib.new('md5', ntlm_hash + b"ClientChallenge" * 10).digest()
        
        return response
    
    @staticmethod
    def describe_ntlm_flow() -> str:
        """æè¿° NTLM è®¤è¯æµç¨‹"""
        return """
# NTLM è®¤è¯æµç¨‹

## æ­¥éª¤ 1: å®¢æˆ·ç«¯åå•†
å®¢æˆ·ç«¯å‘é€ NEGOTIATE æ¶ˆæ¯
åŒ…å«: æ”¯æŒçš„åŠŸèƒ½æ ‡å¿—

## æ­¥éª¤ 2: æœåŠ¡å™¨æŒ‘æˆ˜
æœåŠ¡å™¨å‘é€ CHALLENGE æ¶ˆæ¯
åŒ…å«: æœåŠ¡å™¨éšæœºæŒ‘æˆ˜

## æ­¥éª¤ 3: å®¢æˆ·ç«¯å“åº”
å®¢æˆ·ç«¯å‘é€ AUTHENTICATE æ¶ˆæ¯
åŒ…å«: ç”¨æˆ·åã€æŒ‘æˆ˜å“åº”

## æ­¥éª¤ 4: æœåŠ¡å™¨éªŒè¯
æœåŠ¡å™¨éªŒè¯å“åº”å¹¶å†³å®šæ˜¯å¦è®¤è¯æˆåŠŸ

## å®‰å…¨é—®é¢˜
1. å¯†ç å“ˆå¸Œå¯è¢«æš´åŠ›ç ´è§£
2. ä¸­é—´äººæ”»å‡»é£é™©
3. ä¸æ”¯æŒç›¸äº’è®¤è¯
4. å®¹æ˜“è¢«ä¸­ç»§æ”»å‡»
"""
```

---

### 3ï¸âƒ£ ç»„ç­–ç•¥ç®¡ç†

#### 3.1 ç»„ç­–ç•¥åŸºç¡€

```python
#!/usr/bin/env python3
"""
ç»„ç­–ç•¥ç®¡ç†ç³»ç»Ÿ
"""
from __future__ import annotations
from dataclasses import dataclass, field
from datetime import datetime
from enum import Enum
from typing import list, Optional


class PolicyType(Enum):
    """ç­–ç•¥ç±»å‹"""
    COMPUTER_CONFIG = "è®¡ç®—æœºé…ç½®"
    USER_CONFIG = "ç”¨æˆ·é…ç½®"


class PolicySetting:
    """ç­–ç•¥è®¾ç½®"""
    
    def __init__(
        self,
        name: str,
        category: str,
        value: any,
        description: str = ""
    ):
        self.name = name
        self.category = category
        self.value = value
        self.description = description
        self.enabled = True
    
    def to_dict(self) -> dict:
        return {
            "name": self.name,
            "category": self.category,
            "value": self.value,
            "description": self.description,
            "enabled": self.enabled
        }


@dataclass
class GroupPolicyObject:
    """ç»„ç­–ç•¥å¯¹è±¡"""
    gpo_id: str
    name: str
    created_date: datetime
    modified_date: datetime
    computer_settings: list[PolicySetting] = field(default_factory=list)
    user_settings: list[PolicySetting] = field(default_factory=list)
    linked_ous: list[str] = field(default_factory=list)
    enabled: bool = True


class GroupPolicyManager:
    """ç»„ç­–ç•¥ç®¡ç†å™¨"""
    
    # å¸¸è§å®‰å…¨ç­–ç•¥è®¾ç½®
    SECURITY_SETTINGS = {
        "å¯†ç ç­–ç•¥": [
            PolicySetting("Minimum password length", "Account Policies", 12),
            PolicySetting("Password complexity requirements", "Account Policies", True),
            PolicySetting("Maximum password age", "Account Policies", 90),
            PolicySetting("Minimum password age", "Account Policies", 1),
            PolicySetting("Enforce password history", "Account Policies", 12),
        ],
        "è´¦æˆ·é”å®šç­–ç•¥": [
            PolicySetting("Account lockout duration", "Account Policies", 30),
            PolicySetting("Account lockout threshold", "Account Policies", 5),
            PolicySetting("Reset account lockout counter", "Account Policies", 30),
        ],
        "å®¡è®¡ç­–ç•¥": [
            PolicySetting("Audit account logon events", "Advanced Audit", "Success, Failure"),
            PolicySetting("Audit account management", "Advanced Audit", "Success, Failure"),
            PolicySetting("Audit directory service access", "Advanced Audit", "Success"),
            PolicySetting("Audit logon events", "Advanced Audit", "Success, Failure"),
        ],
        "å®‰å…¨é€‰é¡¹": [
            PolicySetting("Accounts: Administrator account status", "Security Options", "Disabled"),
            PolicySetting("Network security: LAN Manager authentication level", "Security Options", "Send NTLMv2 response only"),
            PolicySetting("User Account Control: Behavior of the elevation prompt", "Security Options", "Prompt for consent"),
        ],
        "Windows é˜²ç«å¢™": [
            PolicySetting("Domain: Firewall state", "Windows Firewall", "On"),
            PolicySetting("Domain: Inbound connections", "Windows Firewall", "Block all"),
            PolicySetting("Domain: Outbound connections", "Windows Firewall", "Allow"),
        ]
    }
    
    def create_gpo(self, name: str) -> GroupPolicyObject:
        """åˆ›å»º GPO"""
        import uuid
        gpo_id = str(uuid.uuid4())[:8].upper()
        
        gpo = GroupPolicyObject(
            gpo_id=f"GPO-{gpo_id}",
            name=name,
            created_date=datetime.now(),
            modified_date=datetime.now()
        )
        
        return gpo
    
    def add_security_settings(self, gpo: GroupPolicyObject) -> None:
        """æ·»åŠ å®‰å…¨è®¾ç½®"""
        for category, settings in self.SECURITY_SETTINGS.items():
            for setting in settings:
                gpo.computer_settings.append(setting)
    
    def link_gpo_to_ou(self, gpo: GroupPolicyObject, ou_dn: str) -> None:
        """å°† GPO é“¾æ¥åˆ° OU"""
        gpo.linked_ous.append(ou_dn)
        gpo.modified_date = datetime.now()
    
    def generate_policy_report(self, gpo: GroupPolicyObject) -> str:
        """ç”Ÿæˆç­–ç•¥æŠ¥å‘Š"""
        report = f"""
# ç»„ç­–ç•¥æŠ¥å‘Š: {gpo.name}

## åŸºæœ¬ä¿¡æ¯
- **GPO ID**: {gpo.gpo_id}
- **åˆ›å»ºæ—¶é—´**: {gpo.created_date.strftime('%Y-%m-%d %H:%M')}
- **ä¿®æ”¹æ—¶é—´**: {gpo.modified_date.strftime('%Y-%m-%d %H:%M')}
- **çŠ¶æ€**: {'å¯ç”¨' if gpo.enabled else 'ç¦ç”¨'}
- **é“¾æ¥ OU æ•°**: {len(gpo.linked_ous)}

## é“¾æ¥çš„ OU
"""
        for ou in gpo.linked_ous:
            report += f"- {ou}\n"
        
        report += f"""
## è®¡ç®—æœºé…ç½®è®¾ç½® ({len(gpo.computer_settings)} é¡¹)
"""
        categories = {}
        for setting in gpo.computer_settings:
            if setting.category not in categories:
                categories[setting.category] = []
            categories[setting.category].append(setting)
        
        for category, settings in categories.items():
            report += f"\n### {category}\n"
            for setting in settings:
                report += f"- **{setting.name}**: {setting.value}\n"
        
        return report
    
    def analyze_gpo_risks(self, gpo: GroupPolicyObject) -> list[dict]:
        """åˆ†æ GPO å®‰å…¨é£é™©"""
        risks = []
        
        for setting in gpo.computer_settings:
            # æ£€æŸ¥å±é™©è®¾ç½®
            if "Disabled" in setting.name and "Antivirus" in setting.name:
                risks.append({
                    "setting": setting.name,
                    "risk": "High",
                    "description": "ç¦ç”¨é˜²ç—…æ¯’è½¯ä»¶ä¼šæ˜¾è‘—å¢åŠ å®‰å…¨é£é™©",
                    "recommendation": "å¯ç”¨é˜²ç—…æ¯’è½¯ä»¶ä¿æŠ¤"
                })
            
            if "LAN Manager" in setting.name and "Send LM" in setting.value:
                risks.append({
                    "setting": setting.name,
                    "risk": "High",
                    "description": "ä½¿ç”¨ä¸å®‰å…¨çš„ LM è®¤è¯åè®®",
                    "recommendation": "å‡çº§åˆ° NTLMv2 æˆ– Kerberos"
                })
            
            if "password length" in setting.name and setting.value < 12:
                risks.append({
                    "setting": setting.name,
                    "risk": "Medium",
                    "description": "å¯†ç é•¿åº¦ä¸è¶³å¢åŠ æš´åŠ›ç ´è§£é£é™©",
                    "recommendation": "å°†æœ€å°å¯†ç é•¿åº¦è®¾ç½®ä¸º 12 æˆ–æ›´é•¿"
                })
        
        return risks
```

---

### 4ï¸âƒ£ å†…ç½‘é£é™©é¢åˆ†æ

#### 4.1 å¸¸è§é£é™©ç‚¹

```python
#!/usr/bin/env python3
"""
å†…ç½‘å®‰å…¨é£é™©è¯„ä¼°
"""
from __future__ import annotations
from dataclasses import dataclass
from enum import Enum
from typing import list


class RiskLevel(Enum):
    """é£é™©ç­‰çº§"""
    CRITICAL = 5
    HIGH = 4
    MEDIUM = 3
    LOW = 2
    INFO = 1


@dataclass
class SecurityRisk:
    """å®‰å…¨é£é™©"""
    name: str
    description: str
    category: str
    risk_level: RiskLevel
    affected_systems: list[str]
    exploitation_difficulty: str
    impact: str
    mitigation: str


class InternalNetworkRisks:
    """å†…ç½‘å®‰å…¨é£é™©åº“"""
    
    RISKS = [
        SecurityRisk(
            name="åŸŸç®¡ç†å‘˜æƒé™æ»¥ç”¨",
            description="æ”»å‡»è€…è·å–åŸŸç®¡ç†å‘˜å‡­æ®åå¯å®Œå…¨æ§åˆ¶åŸŸå†…æ‰€æœ‰èµ„æº",
            category="èº«ä»½å®‰å…¨",
            risk_level=RiskLevel.CRITICAL,
            affected_systems=["æ‰€æœ‰åŸŸæˆå‘˜æœåŠ¡å™¨", "æ‰€æœ‰åŸŸæˆå‘˜å·¥ä½œç«™"],
            exploitation_difficulty="Medium",
            impact="å®Œå…¨æ§åˆ¶åŸŸç¯å¢ƒ",
            mitigation="å®æ–½ç‰¹æƒè®¿é—®ç®¡ç†ã€å¯ç”¨ MFAã€å®šæœŸè½®æ¢å¯†ç "
        ),
        SecurityRisk(
            name="Kerberoasting æ”»å‡»",
            description="æ”»å‡»è€…è¯·æ±‚æœåŠ¡ç¥¨æ®å¹¶ç¦»çº¿ç ´è§£æœåŠ¡è´¦æˆ·å¯†ç ",
            category="èº«ä»½å®‰å…¨",
            risk_level=RiskLevel.HIGH,
            affected_systems=["è¿è¡ŒæœåŠ¡çš„åŸŸæˆå‘˜æœåŠ¡å™¨"],
            exploitation_difficulty="Easy",
            impact="è·å–æœåŠ¡è´¦æˆ·æƒé™",
            mitigation="ä½¿ç”¨é•¿å¤æ‚å¯†ç ã€é¿å…ä½¿ç”¨ SPNã€ç›‘æ§ TGS è¯·æ±‚"
        ),
        SecurityRisk(
            name="AS-REP Roasting æ”»å‡»",
            description="é’ˆå¯¹ä¸å¯ç”¨é¢„èº«ä»½éªŒè¯çš„ç”¨æˆ·è´¦æˆ·ï¼Œç¦»çº¿ç ´è§£å¯†ç ",
            category="èº«ä»½å®‰å…¨",
            risk_level=RiskLevel.HIGH,
            affected_systems=["åŸŸæ§åˆ¶å™¨"],
            exploitation_difficulty="Easy",
            impact="è·å–ç”¨æˆ·è´¦æˆ·æƒé™",
            mitigation="ç¡®ä¿æ‰€æœ‰ç”¨æˆ·å¯ç”¨é¢„èº«ä»½éªŒè¯"
        ),
        SecurityRisk(
            name="é»„é‡‘ç¥¨æ®æ”»å‡»",
            description="æ”»å‡»è€…ä¼ªé€  TGT ç¥¨æ®ï¼Œè·å–åŸŸç®¡ç†å‘˜æƒé™",
            category="èº«ä»½å®‰å…¨",
            risk_level=RiskLevel.CRITICAL,
            affected_systems=["æ‰€æœ‰åŸŸæˆå‘˜"],
            exploitation_difficulty="Hard",
            impact="å®Œå…¨æ§åˆ¶åŸŸç¯å¢ƒ",
            mitigation="ä¿æŠ¤ krbtgt è´¦æˆ·ã€å®šæœŸé‡ç½® krbtgt å¯†ç "
        ),
        SecurityRisk(
            name="ç™½é“¶ç¥¨æ®æ”»å‡»",
            description="ä¼ªé€ æœåŠ¡ç¥¨æ®ï¼Œå†’å……ç‰¹å®šæœåŠ¡",
            category="èº«ä»½å®‰å…¨",
            risk_level=RiskLevel.HIGH,
            affected_systems=["è¿è¡Œç‰¹å®šæœåŠ¡çš„æœåŠ¡å™¨"],
            exploitation_difficulty="Medium",
            impact="å†’å……ç‰¹å®šæœåŠ¡è·å–æ•°æ®",
            mitigation="ä½¿ç”¨å—é™å§”æ´¾ã€ç›‘æ§å¼‚å¸¸ç¥¨æ®è¯·æ±‚"
        ),
        SecurityRisk(
            name="ç»„ç­–ç•¥æƒé™æ»¥ç”¨",
            description="æ”»å‡»è€…ä¿®æ”¹ç»„ç­–ç•¥å®æ–½æ¶æ„è®¾ç½®",
            category="é…ç½®å®‰å…¨",
            risk_level=RiskLevel.CRITICAL,
            affected_systems=["æ‰€æœ‰åº”ç”¨ç»„ç­–ç•¥çš„ç”¨æˆ·/è®¡ç®—æœº"],
            exploitation_difficulty="Medium",
            impact="å¤§è§„æ¨¡éƒ¨ç½²æ¶æ„é…ç½®",
            mitigation="é™åˆ¶ç»„ç­–ç•¥ä¿®æ”¹æƒé™ã€å¯ç”¨ GPO å®¡è®¡"
        ),
        SecurityRisk(
            name="ä¿¡ä»»å…³ç³»æ”»å‡»",
            description="æ”»å‡»è€…åˆ©ç”¨åŸŸé—´ä¿¡ä»»å…³ç³»æ¨ªå‘ç§»åŠ¨",
            category="ä¿¡ä»»å®‰å…¨",
            risk_level=RiskLevel.HIGH,
            affected_systems=["ä¿¡ä»»åŸŸä¸­çš„æ‰€æœ‰ç³»ç»Ÿ"],
            exploitation_difficulty="Medium",
            impact="è·¨åŸŸæ¨ªå‘ç§»åŠ¨",
            mitigation="æœ€å°åŒ–ä¿¡ä»»å…³ç³»ã€ç›‘æ§è·¨åŸŸè®¿é—®"
        ),
        SecurityRisk(
            name="å‡­è¯è½¬å‚¨æ”»å‡»",
            description="æ”»å‡»è€…è½¬å‚¨ LSASS è¿›ç¨‹è·å–å‡­è¯",
            category="å‡­è¯å®‰å…¨",
            risk_level=RiskLevel.CRITICAL,
            affected_systems=["åŸŸæ§åˆ¶å™¨", "ç®¡ç†å‘˜å·¥ä½œç«™"],
            exploitation_difficulty="Medium",
            impact="è·å–æ˜æ–‡å¯†ç æˆ– NTLM å“ˆå¸Œ",
            mitigation="å¯ç”¨ LSA ä¿æŠ¤ã€é™åˆ¶æœ¬åœ°ç®¡ç†å‘˜æƒé™"
        ),
        SecurityRisk(
            name="Pass-the-Hash æ”»å‡»",
            description="ä½¿ç”¨ NTLM å“ˆå¸Œè¿›è¡Œèº«ä»½è®¤è¯",
            category="å‡­è¯å®‰å…¨",
            risk_level=RiskLevel.HIGH,
            affected_systems=["æ”¯æŒ NTLM è®¤è¯çš„ç³»ç»Ÿ"],
            exploitation_difficulty="Easy",
            impact="æ¨ªå‘ç§»åŠ¨",
            mitigation="ç¦ç”¨ NTLMã€ä½¿ç”¨ Kerberosã€å¯ç”¨ PPL"
        ),
        SecurityRisk(
            name="DCSync æ”»å‡»",
            description="æ”»å‡»è€…æ¨¡æ‹ŸåŸŸæ§åˆ¶å™¨åŒæ­¥è¯·æ±‚è·å–æ‰€æœ‰å¯†ç å“ˆå¸Œ",
            category="å‡­è¯å®‰å…¨",
            risk_level=RiskLevel.CRITICAL,
            affected_systems=["åŸŸæ§åˆ¶å™¨"],
            exploitation_difficulty="Hard",
            impact="è·å–æ‰€æœ‰åŸŸç”¨æˆ·å¯†ç å“ˆå¸Œ",
            mitigation="é™åˆ¶å¤åˆ¶æƒé™ã€ç›‘æ§å¼‚å¸¸å¤åˆ¶è¯·æ±‚"
        )
    ]
    
    def get_risks_by_category(self) -> dict:
        """æŒ‰ç±»åˆ«è·å–é£é™©"""
        by_category = {}
        for risk in self.RISKS:
            if risk.category not in by_category:
                by_category[risk.category] = []
            by_category[risk.category].append(risk)
        return by_category
    
    def get_high_risks(self) -> list[SecurityRisk]:
        """è·å–é«˜é£é™©"""
        return [r for r in self.RISKS if r.risk_level in [
            RiskLevel.CRITICAL, RiskLevel.HIGH
        ]]
    
    def generate_risk_report(self) -> str:
        """ç”Ÿæˆé£é™©æŠ¥å‘Š"""
        report = "# å†…ç½‘å®‰å…¨é£é™©è¯„ä¼°æŠ¥å‘Š\n\n"
        
        # é£é™©ç»Ÿè®¡
        by_level = {}
        for risk in self.RISKS:
            level = risk.risk_level.name
            by_level[level] = by_level.get(level, 0) + 1
        
        report += "## é£é™©æ¦‚è§ˆ\n\n"
        report += "| é£é™©ç­‰çº§ | æ•°é‡ |\n"
        report += "|----------|------|\n"
        for level in ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO"]:
            count = by_level.get(level, 0)
            report += f"| {level} | {count} |\n"
        
        # è¯¦ç»†é£é™©åˆ—è¡¨
        report += "\n## è¯¦ç»†é£é™©\n\n"
        
        for category, risks in self.get_risks_by_category().items():
            report += f"### {category}\n\n"
            
            for risk in sorted(risks, key=lambda x: -x.risk_level.value):
                report += f"#### {risk.name}\n"
                report += f"- **é£é™©ç­‰çº§**: {risk.risk_level.name}\n"
                report += f"- **æè¿°**: {risk.description}\n"
                report += f"- **å½±å“ç³»ç»Ÿ**: {', '.join(risk.affected_systems)}\n"
                report += f"- **åˆ©ç”¨éš¾åº¦**: {risk.exploitation_difficulty}\n"
                report += f"- **å®‰å…¨å½±å“**: {risk.impact}\n"
                report += f"- **ç¼“è§£æªæ–½**: {risk.mitigation}\n\n"
        
        return report
```

#### 4.2 æœ€å°æƒé™åŸåˆ™

```python
#!/usr/bin/env python3
"""
æœ€å°æƒé™å®æ–½æŒ‡å—
"""
from __future__ import annotations
from dataclasses import dataclass
from typing import list


@dataclass
class Privilege:
    """æƒé™"""
    name: str
    description: str
    required_by: list[str]
    risk_level: str


class LeastPrivilegeGuide:
    """æœ€å°æƒé™æŒ‡å—"""
    
    PRIVILEGES = [
        Privilege(
            name="SeDebugPrivilege",
            description="è°ƒè¯•è¿›ç¨‹",
            required_by=["ç³»ç»Ÿç®¡ç†å‘˜", "å®‰å…¨å®¡è®¡å‘˜"],
            risk_level="High"
        ),
        Privilege(
            name="SeLoadDriverPrivilege",
            description="åŠ è½½/å¸è½½è®¾å¤‡é©±åŠ¨",
            required_by=["ç³»ç»Ÿç®¡ç†å‘˜"],
            risk_level="Critical"
        ),
        Privilege(
            name="SeBackupPrivilege",
            description="å¤‡ä»½æ–‡ä»¶å’Œç›®å½•",
            required_by=["å¤‡ä»½æ“ä½œå‘˜"],
            risk_level="Medium"
        ),
        Privilege(
            name="SeRestorePrivilege",
            description="æ¢å¤æ–‡ä»¶å’Œç›®å½•",
            required_by=["å¤‡ä»½æ“ä½œå‘˜"],
            risk_level="Medium"
        ),
        Privilege(
            name="SeTakeOwnershipPrivilege",
            description="è·å–å¯¹è±¡æ‰€æœ‰æƒ",
            required_by=["ç³»ç»Ÿç®¡ç†å‘˜"],
            risk_level="High"
        )
    ]
    
    @staticmethod
    def generate_privilege_review_guide() -> str:
        """ç”Ÿæˆæƒé™å®¡æŸ¥æŒ‡å—"""
        return """
# æœ€å°æƒé™åŸåˆ™å®æ–½æŒ‡å—

## 1. æƒé™å®¡æŸ¥æµç¨‹

### æ­¥éª¤ 1: æƒé™æ¸…å•
- åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·å’Œç»„
- è¯†åˆ«ç‰¹æƒè´¦æˆ·
- è®°å½•å½“å‰æƒé™åˆ†é…

### æ­¥éª¤ 2: éœ€æ±‚åˆ†æ
- ä¸ä¸šåŠ¡éƒ¨é—¨æ²Ÿé€š
- ç¡®è®¤æ¯ä¸ªç”¨æˆ·çš„å®é™…éœ€æ±‚
- è¯†åˆ«è¿‡åº¦æƒé™åˆ†é…

### æ­¥éª¤ 3: æƒé™æ¸…ç†
- ç§»é™¤ä¸å¿…è¦çš„æƒé™
- å®æ–½æœ€å°æƒé™åŸåˆ™
- è®°å½•æ‰€æœ‰å˜æ›´

### æ­¥éª¤ 4: æŒç»­ç›‘æ§
- å®šæœŸå®¡æŸ¥æƒé™
- ç›‘æ§å¼‚å¸¸è®¿é—®
- åŠæ—¶å“åº”æƒé™æ»¥ç”¨

## 2. ç‰¹æƒè´¦æˆ·ç®¡ç†

### 2.1 ç‰¹æƒè´¦æˆ·åˆ†ç±»
- **æ°¸ä¹…ç‰¹æƒè´¦æˆ·**: éœ€è¦é•¿æœŸæŒæœ‰çš„ç®¡ç†å‘˜è´¦æˆ·
- **å³æ—¶ç‰¹æƒè´¦æˆ·**: éœ€è¦æ—¶ä¸´æ—¶è·å–çš„ç®¡ç†æƒé™
- **æœåŠ¡è´¦æˆ·**: è¿è¡ŒæœåŠ¡ä½¿ç”¨çš„è´¦æˆ·

### 2.2 ç‰¹æƒè´¦æˆ·å®‰å…¨è¦æ±‚
- ä½¿ç”¨å¼ºå¯†ç ï¼ˆé•¿åº¦â‰¥20ï¼‰
- å¯ç”¨å¤šå› ç´ è®¤è¯
- å®šæœŸè½®æ¢å¯†ç 
- é™åˆ¶ç™»å½•æ—¶é—´
- é™åˆ¶ç™»å½•ä½ç½®
- è¯¦ç»†å®¡è®¡æ—¥å¿—

## 3. å®æ–½å»ºè®®

### 3.1 ç”¨æˆ·æƒé™
- æ™®é€šç”¨æˆ·ä¸åº”æ˜¯æœ¬åœ°ç®¡ç†å‘˜
- ä¸åº”å…±äº«è´¦æˆ·
- å®šæœŸå®¡æŸ¥ç¦»èŒäººå‘˜è´¦æˆ·

### 3.2 æœåŠ¡è´¦æˆ·
- ä½¿ç”¨æ‰˜ç®¡æœåŠ¡è´¦æˆ·
- é¿å…ä½¿ç”¨åŸŸç®¡ç†å‘˜è´¦æˆ·è¿è¡ŒæœåŠ¡
- å®šæœŸæ›´æ¢æœåŠ¡è´¦æˆ·å¯†ç 

### 3.3 åº”ç”¨ç¨‹åºæƒé™
- åº”ç”¨ç¨‹åºåº”ä½¿ç”¨æœ€å°æƒé™è¿è¡Œ
- é¿å…ä»¥ SYSTEM æƒé™è¿è¡Œ
- ä½¿ç”¨åº”ç”¨æ± éš”ç¦»
"""
```

---

## å®è·µä»»åŠ¡ï¼ˆåˆæ³•æˆæƒèŒƒå›´å†…ï¼‰

> **æ³¨æ„**ï¼šä»¥ä¸‹ä»»åŠ¡è¯·åœ¨ä½ è‡ªå·±çš„æµ‹è¯•ç¯å¢ƒã€è™šæ‹Ÿæœºæˆ–æˆæƒé¶åœºä¸­æ‰§è¡Œã€‚

---

### ä»»åŠ¡ 1ï¼ˆå¿…åšï¼‰ï¼šåˆ†æ AD ç¯å¢ƒ

**ç›®æ ‡**ï¼šåœ¨å®éªŒç¯å¢ƒä¸­åˆ†æ Active Directory ç»“æ„ã€‚

**æ­¥éª¤**ï¼š

```powershell
# PowerShell è„šæœ¬

# 1. è·å–åŸŸä¿¡æ¯
Get-ADDomain | Format-List

# 2. è·å–åŸŸæ§åˆ¶å™¨
Get-ADDomainController | Format-Table

# 3. è·å–ç»„ç»‡å•ä½ç»“æ„
Get-ADOrganizationalUnit -Filter * | Format-Table Name, DistinguishedName

# 4. è·å–ç”¨æˆ·åˆ—è¡¨
Get-ADUser -Filter * | Select-Object Name, SamAccountName, Department | Format-Table

# 5. è·å–ç»„åˆ—è¡¨
Get-ADGroup -Filter * | Select-Object Name, GroupScope, GroupCategory | Format-Table

# 6. è·å–ç‰¹æƒç»„æˆå‘˜
Get-ADGroupMember "Domain Admins" | Select-Object Name, SamAccountName

# 7. è·å–è®¡ç®—æœºåˆ—è¡¨
Get-ADComputer -Filter * | Select-Object Name, OperatingSystem | Format-Table
```

---

### ä»»åŠ¡ 2ï¼ˆå¿…åšï¼‰ï¼šåˆ†æç»„ç­–ç•¥

**ç›®æ ‡**ï¼šæŸ¥çœ‹å’Œåˆ†æç»„ç­–ç•¥é…ç½®ã€‚

**æ­¥éª¤**ï¼š

```powershell
# PowerShell è„šæœ¬

# 1. è·å–æ‰€æœ‰ GPO
Get-GPO -All | Select-Object DisplayName, Id, CreationTime, ModificationTime | Format-Table

# 2. è·å– GPO é“¾æ¥çŠ¶æ€
Get-ADOrganizationalUnit -Filter * | ForEach-Object {
    $ou = $_.Name
    $gpos = Get-GPInheritance -Target $_.DistinguishedName -ErrorAction SilentlyContinue
    Write-Host "OU: $ou"
    $gpos.GpoLinks | Format-Table
}

# 3. å¯¼å‡ºå®‰å…¨è®¾ç½®
Get-GPO -All | ForEach-Object {
    $gpo = $_
    $report = Get-GPOReport -Name $_.DisplayName -ReportType Html
    $report | Out-File "GPO_$($_.DisplayName).html"
}

# 4. æ£€æŸ¥å¯†ç ç­–ç•¥
net accounts
```

---

### ä»»åŠ¡ 3ï¼ˆå¿…åšï¼‰ï¼šé£é™©è¯„ä¼°

**ç›®æ ‡**ï¼šè¯†åˆ«å†…ç½‘ç¯å¢ƒä¸­çš„å®‰å…¨é£é™©ã€‚

**æ­¥éª¤**ï¼š

```python
#!/usr/bin/env python3

from internal_network_risks import InternalNetworkRisks

# åˆ›å»ºé£é™©è¯„ä¼°å™¨
risks = InternalNetworkRisks()

# ç”Ÿæˆé£é™©æŠ¥å‘Š
report = risks.generate_risk_report()
print(report)

# è·å–é«˜é£é™©åˆ—è¡¨
high_risks = risks.get_high_risks()
print(f"\né«˜é£é™©æ•°é‡: {len(high_risks)}")

for risk in high_risks[:5]:
    print(f"- {risk.name} ({risk.risk_level.name})")
```

---

### ä»»åŠ¡ 4ï¼ˆè¿›é˜¶ï¼‰ï¼šåŠ å›ºå»ºè®®

**ç›®æ ‡**ï¼šåˆ¶å®šåŸŸç¯å¢ƒåŠ å›ºå»ºè®®ã€‚

**æ­¥éª¤**ï¼š

```markdown
# åŸŸç¯å¢ƒåŠ å›ºå»ºè®®

## 1. èº«ä»½è®¤è¯åŠ å›º

### å¯†ç ç­–ç•¥
- æœ€å°å¯†ç é•¿åº¦: 14
- å¯†ç å¤æ‚åº¦: å¯ç”¨
- å¯†ç å†å²: 24
- æœ€é•¿ä½¿ç”¨æœŸé™: 90å¤©

### è´¦æˆ·é”å®šç­–ç•¥
- é”å®šé˜ˆå€¼: 5æ¬¡å¤±è´¥ç™»å½•
- é”å®šæ—¶é—´: 30åˆ†é’Ÿ
- é‡ç½®è®¡æ•°: 30åˆ†é’Ÿ

### Kerberos ç­–ç•¥
- æœåŠ¡ç¥¨æ®æœ€é•¿å¯¿å‘½: 10å°æ—¶
- ç”¨æˆ·ç¥¨æ®æœ€é•¿å¯¿å‘½: 10å°æ—¶
- å¼ºåˆ¶ç”¨æˆ·ç™»å½•é™åˆ¶: å¯ç”¨

## 2. ç»„ç­–ç•¥åŠ å›º

### å®‰å…¨é€‰é¡¹
- ç½‘ç»œå®‰å…¨: LAN Manager èº«ä»½éªŒè¯çº§åˆ«: åªå‘é€ NTLMv2 å“åº”
- ç”¨æˆ·è´¦æˆ·æ§åˆ¶: ä»¥ç®¡ç†å‘˜æ‰¹å‡†æ¨¡å¼è¿è¡Œæ‰€æœ‰ç®¡ç†å‘˜: å¯ç”¨

### å®¡è®¡ç­–ç•¥
- å®¡æ ¸è´¦æˆ·ç™»å½•äº‹ä»¶: æˆåŠŸ, å¤±è´¥
- å®¡æ ¸è´¦æˆ·ç®¡ç†: æˆåŠŸ, å¤±è´¥
- å®¡æ ¸ç›®å½•æœåŠ¡è®¿é—®: æˆåŠŸ

## 3. è®¿é—®æ§åˆ¶

### ç”¨æˆ·æƒé™åˆ†é…
- ä½œä¸ºæ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†: åˆ é™¤æ‰€æœ‰ç”¨æˆ·
- å¤‡ä»½æ–‡ä»¶å’Œç›®å½•: åªåˆ†é…ç»™å¤‡ä»½æ“ä½œå‘˜
- è¿˜åŸæ–‡ä»¶å’Œç›®å½•: åªåˆ†é…ç»™å¤‡ä»½æ“ä½œå‘˜

### é«˜çº§å®‰å…¨è®¾ç½®
- ç¦æ­¢åŒ¿åæšä¸¾ SAM è´¦æˆ·: å¯ç”¨
- ç¦æ­¢åŒ¿åæšä¸¾ SAM è´¦æˆ·å’Œå…±äº«: å¯ç”¨
```

---

## å·©å›ºç»ƒä¹ ï¼ˆé¢˜ä¸å¤ç›˜ï¼‰

---

### ç»ƒä¹  1ï¼šæœ€å°æƒé™é‡è¦æ€§

**é—®é¢˜**ï¼šä¸ºä»€ä¹ˆæœ€å°æƒé™åŸåˆ™åœ¨å†…ç½‘å®‰å…¨ä¸­è‡³å…³é‡è¦ï¼Ÿ

**æ€è·¯æç¤º**ï¼š

| æ–¹é¢ | è¯´æ˜ |
|------|------|
| **æ”»å‡»é¢å‡å°** | æƒé™è¶Šå°‘ï¼Œæ”»å‡»è€…èƒ½åšçš„äº‹æƒ…è¶Šå°‘ |
| **é™åˆ¶æ¨ªå‘ç§»åŠ¨** | æ”»å‡»è€…éš¾ä»¥åˆ©ç”¨ä½æƒé™è´¦æˆ·æ‰©å±•æ”»å‡» |
| **å‡å°‘è¯¯æ“ä½œ** | æƒé™é™åˆ¶å¯ä»¥é˜²æ­¢ç®¡ç†å‘˜è¯¯æ“ä½œ |
| **åˆè§„è¦æ±‚** | ç­‰ä¿ã€ISO27001 ç­‰è¦æ±‚æœ€å°æƒé™ |
| **è´£ä»»åˆ†ç¦»** | ä¸åŒæƒé™åˆ†é…ç»™ä¸åŒäººå‘˜ï¼Œé¿å…å•ç‚¹é£é™© |

---

### ç»ƒä¹  2ï¼šåŸŸåŠ å›ºå»ºè®®

**é—®é¢˜**ï¼šæå‡º 5 æ¡åŸŸç¯å¢ƒåŠ å›ºå»ºè®®ã€‚

**ç¤ºä¾‹ç­”æ¡ˆ**ï¼š

```python
# åŸŸåŠ å›ºå»ºè®®
DOMAIN_HARDENING = [
    {
        "å»ºè®®": "ç¦ç”¨ SMBv1",
        "åŸå› ": "SMBv1 å­˜åœ¨å¤šä¸ªä¸¥é‡æ¼æ´",
        "å®æ–½": "ç»„ç­–ç•¥ç¦ç”¨ SMBv1 åè®®"
    },
    {
        "å»ºè®®": "å¯ç”¨ LDAP ç­¾å",
        "åŸå› ": "é˜²æ­¢ LDAP ä¸­ç»§æ”»å‡»",
        "å®æ–½": "åŸŸæ§åˆ¶å™¨ä¸Šå¯ç”¨ LDAP ç­¾åè¦æ±‚"
    },
    {
        "å»ºè®®": "é™åˆ¶åŸŸç®¡ç†å‘˜ç™»å½•",
        "åŸå› ": "å‡å°‘å‡­è¯æ³„éœ²é£é™©",
        "å®æ–½": "é€šè¿‡ GPO é™åˆ¶åŸŸç®¡ç†å‘˜ç™»å½•åˆ°ç‰¹å®šè®¡ç®—æœº"
    },
    {
        "å»ºè®®": "ç›‘æ§ç‰¹æƒç»„å˜æ›´",
        "åŸå› ": "åŠæ—¶å‘ç°å¼‚å¸¸æƒé™æå‡",
        "å®æ–½": "å¯ç”¨å®‰å…¨å®¡æ ¸ï¼Œç›‘æ§ç‰¹æƒç»„å˜æ›´"
    },
    {
        "å»ºè®®": "å®šæœŸè½®æ¢ krbtgt å¯†ç ",
        "åŸå› ": "é˜²æ­¢ Golden Ticket æ”»å‡»",
        "å®æ–½": "æ¯ 180 å¤©è½®æ¢ krbtgt å¯†ç ä¸¤æ¬¡"
    }
]
```

---

### ç»ƒä¹  3ï¼šé£é™©ä¼˜å…ˆçº§æ’åº

**é—®é¢˜**ï¼šå¦‚ä½•å¯¹å†…ç½‘å®‰å…¨é£é™©è¿›è¡Œä¼˜å…ˆçº§æ’åºï¼Ÿ

**ç¤ºä¾‹ç­”æ¡ˆ**ï¼š

```python
# é£é™©ä¼˜å…ˆçº§çŸ©é˜µ
RISK_PRIORITIZATION = {
    "P1 - ç«‹å³å¤„ç†": [
        "Golden Ticket æ”»å‡»æ¼æ´",
        "åŸŸç®¡ç†å‘˜å‡­è¯æ³„éœ²",
        "å…³é”®ç³»ç»Ÿæœªæ‰“è¡¥ä¸"
    ],
    "P2 - æœ¬å‘¨å¤„ç†": [
        "Kerberoasting é£é™©",
        "ç»„ç­–ç•¥é…ç½®ä¸å½“",
        "æœåŠ¡è´¦æˆ·å¼±å¯†ç "
    ],
    "P3 - ä¸¤å‘¨å¤„ç†": [
        "ä¸å¿…è¦çš„ä¿¡ä»»å…³ç³»",
        "è¿‡åº¦æ–‡ä»¶å…±äº«æƒé™",
        "æ—§ç³»ç»Ÿæœªé€€å½¹"
    ],
    "P4 - è®¡åˆ’å¤„ç†": [
        "éå…³é”®ç³»ç»Ÿé…ç½®ä¼˜åŒ–",
        "æ—¥å¿—ä¿ç•™ç­–ç•¥æ”¹è¿›",
        "æ–‡æ¡£å®Œå–„"
    ]
}

# ä¼˜å…ˆçº§åˆ¤æ–­æ ‡å‡†
PRIORITIZATION_CRITERIA = [
    "CVSS è¯„åˆ† >= 9.0 â†’ P1",
    "CVSS è¯„åˆ† 7.0-8.9 â†’ P2",
    "CVSS è¯„åˆ† 4.0-6.9 â†’ P3",
    "CVSS è¯„åˆ† < 4.0 â†’ P4",
    "å·²è¢«åˆ©ç”¨çš„æ¼æ´ â†’ æå‡ä¸€çº§",
    "å½±å“æ ¸å¿ƒç³»ç»Ÿ â†’ æå‡ä¸€çº§"
]
```

---

## è¯„ä¼°æ ‡å‡†ï¼ˆè¾¾æˆåˆ¤å®šï¼‰

- âœ… èƒ½è§£é‡Š Active Directory çš„åŸºæœ¬æ¶æ„å’Œæ ¸å¿ƒæ¦‚å¿µ
- âœ… èƒ½æè¿° Kerberos å’Œ NTLM è®¤è¯æµç¨‹
- âœ… èƒ½è¯†åˆ«å†…ç½‘ç¯å¢ƒä¸­çš„å¸¸è§å®‰å…¨é£é™©
- âœ… èƒ½ç†è§£ç»„ç­–ç•¥çš„ä½œç”¨å’Œç®¡ç†æ–¹æ³•
- âœ… èƒ½è¯´æ˜æœ€å°æƒé™åŸåˆ™çš„é‡è¦æ€§

---

## å­¦ä¹ æˆæœè¾¾æˆæƒ…å†µï¼ˆç”±å­¦ä¹ è€…å¡«å†™ï¼‰

### æˆªå›¾ä¸è¯æ®

- [ ] AD åŸŸç»“æ„æˆªå›¾
- [ ] ç»„ç­–ç•¥é…ç½®æˆªå›¾
- [ ] é£é™©è¯„ä¼°æŠ¥å‘Šæˆªå›¾
- [ ] åŠ å›ºå»ºè®®æ–‡æ¡£æˆªå›¾

### å…³é”®å‘½ä»¤ä¸è¾“å‡º

**AD ç»“æ„æŸ¥è¯¢**ï¼š
```powershell
Get-ADDomain

DistinguishedName : DC=corp,DC=local
DomainMode        : Windows2016Domain
ParentDomain      : 
Children          : {CORP-SRV01, CORP-SRV02}
ReplicaDirectoryServers : {CORP-DC01, CORP-DC02}
```

**ç»„ç­–ç•¥åˆ†æ**ï¼š
```powershell
Get-GPO -All | Select-Object DisplayName, ModificationTime

DisplayName                    ModificationTime
-----------                    ----------------
Default Domain Policy          2024-01-15 10:30:00
Domain Controllers Policy      2024-01-10 08:00:00
```

### ç»“è®ºä¸åæ€

**æˆ‘ä»Šå¤©ææ¸…æ¥šäº†**ï¼š

- Active Directory çš„æ¶æ„å’Œæ ¸å¿ƒç»„ä»¶
- Kerberos è®¤è¯çš„å·¥ä½œåŸç†
- ç»„ç­–ç•¥çš„é…ç½®å’Œç®¡ç†æ–¹æ³•
- å†…ç½‘ç¯å¢ƒä¸­çš„ä¸»è¦å®‰å…¨é£é™©
- æœ€å°æƒé™åŸåˆ™çš„å®æ–½æ–¹æ³•

**æˆ‘å·®ç‚¹ææ··çš„æ˜¯**ï¼š

- Kerberos ä¸­ TGT å’ŒæœåŠ¡ç¥¨æ®çš„åŒºåˆ«
- ä¸åŒç»„ç­–ç•¥ä½œç”¨åŸŸçš„ç»§æ‰¿å…³ç³»
- Domain Localã€Globalã€Universal ç»„çš„åŒºåˆ«

**æ˜å¤©æˆ‘è¦ç»§ç»­è¡¥çš„æ˜¯**ï¼š

- æ¨ªå‘ç§»åŠ¨æŠ€æœ¯
- æƒé™æå‡æ–¹æ³•
- æŒä¹…åŒ–æœºåˆ¶

**æœ¬æ¬¡å­¦ä¹ è€—æ—¶**ï¼šçº¦ 4 å°æ—¶

**æŒæ¡ç¨‹åº¦è‡ªè¯„**ï¼š

- [ ] ğŸ˜• ç†è§£äº†åŸºæœ¬æ¦‚å¿µï¼Œä½†å®è·µä¸ç†Ÿç»ƒ
- [ ] ğŸ™‚ å®Œæˆäº†åŸºç¡€ä»»åŠ¡
- [ ] ğŸ˜ƒ å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡å¹¶ç†è§£åŸç†
- [ ] ğŸ¤© é¢å¤–è®¾è®¡äº†å®Œæ•´çš„åŸŸåŠ å›ºæ–¹æ¡ˆ


## å­¦ä¹ æˆæœç¤ºä¾‹å¡«å†™ï¼ˆå¯ç…§æŠ„ï¼‰

> å¯å°†"ç¤ºä¾‹"å†…å®¹æ›¿æ¢ä¸ºä½ è‡ªå·±çš„æ—¶é—´ä¸æˆªå›¾æ–‡ä»¶åã€‚

### æˆªå›¾ä¸è¯æ®ï¼ˆç¤ºä¾‹ï¼‰

- ä»»åŠ¡ 1ï¼š`images/dayXXX_task1.png`

### å…³é”®å‘½ä»¤ä¸è¾“å‡ºï¼ˆç¤ºä¾‹ï¼‰

```
å‘½ä»¤ç¤ºä¾‹ï¼š
è¾“å‡ºç¤ºä¾‹ï¼š
```

### ç»“è®ºä¸åæ€ï¼ˆç¤ºä¾‹ï¼‰

**æˆ‘ä»Šå¤©ææ¸…æ¥šäº†**ï¼š
- ï¼ˆç¤ºä¾‹ï¼‰ç†è§£äº†æ ¸å¿ƒæ¦‚å¿µ

**æˆ‘å·®ç‚¹ææ··çš„æ˜¯**ï¼š
- ï¼ˆç¤ºä¾‹ï¼‰æŸä¸ªæ˜“æ··æ·†ç‚¹

**æ˜å¤©æˆ‘è¦ç»§ç»­è¡¥çš„æ˜¯**ï¼š
- ï¼ˆç¤ºä¾‹ï¼‰ä¸‹ä¸€æ­¥æ·±å…¥æ–¹å‘

**æœ¬æ¬¡å­¦ä¹ è€—æ—¶**ï¼šçº¦ 2 å°æ—¶

**æŒæ¡ç¨‹åº¦è‡ªè¯„**ï¼š
- [x] ğŸ˜ƒ å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡å¹¶ç†è§£åŸç†
