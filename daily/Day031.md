---
title: Day031ï¼šæ—¥å¿—ä¸å¯è§‚æµ‹æ€§ - å­˜å‚¨ä¸æŸ¥è¯¢ï¼šElastic/OpenSearch æ¦‚è§ˆ
tags:
  - ç½‘ç»œ
  - å®‰å…¨
  - å­¦ä¹ è®¡åˆ’
categories:
  - ç½‘ç»œå®‰å…¨
abbrlink: c8dac04f
date: 2026-01-24 00:00:00
updated: 2026-01-24 00:00:00

---
# Day031ï¼šæ—¥å¿—ä¸å¯è§‚æµ‹æ€§ - å­˜å‚¨ä¸æŸ¥è¯¢ï¼šElastic/OpenSearch æ¦‚è§ˆ

- æ—¥æœŸï¼š2026-01-24
- å‘¨æ¬¡ï¼šç¬¬5å‘¨

## å­¦ä¹ ç›®æ ‡

ä»Šå¤©ä½ å°†æŒæ¡ Elasticsearch çš„åŸºç¡€çŸ¥è¯†ï¼š

- **ç†è§£ç´¢å¼•ä¸æ˜ å°„**ï¼šæŒæ¡ ES çš„æ ¸å¿ƒæ¦‚å¿µï¼ˆIndexã€Typeã€Documentã€Mappingï¼‰
- **å­¦ä¼šç´¢å¼•è®¾è®¡**ï¼šç†è§£åˆ†ç‰‡ã€å‰¯æœ¬å¯¹æ€§èƒ½çš„å½±å“
- **æŒæ¡åŸºç¡€æŸ¥è¯¢**ï¼šèƒ½ä½¿ç”¨ DSL æ‰§è¡Œæœç´¢å’Œèšåˆ
- **äº†è§£æ•°æ®å»ºæ¨¡**ï¼šèƒ½ä¸ºæ—¥å¿—æ•°æ®è®¾è®¡åˆç†çš„ Mapping

---

<!--more-->

## å­¦ä¹ å†…å®¹

### 1ï¸âƒ£ Elasticsearch åŸºç¡€æ¦‚å¿µ

#### 1.1 æ ¸å¿ƒæ¦‚å¿µ

```
Elasticsearch æ¦‚å¿µä½“ç³»
â”‚
â”œâ”€ ç´¢å¼•
â”‚  â”œâ”€ ç›¸å½“äºå…³ç³»æ•°æ®åº“çš„"è¡¨"
â”‚  â””â”€ ä¸€ç»„å…·æœ‰ç›¸ä¼¼ç»“æ„çš„æ–‡æ¡£é›†åˆ
â”‚
â”œâ”€ ç±»å‹
â”‚  â”œâ”€ ç›¸å½“äºå…³ç³»æ•°æ®åº“çš„"schema"
â”‚  â””â”€ ES 7.x+ å·²åºŸå¼ƒï¼Œæ¯ä¸ªç´¢å¼•åªæœ‰ä¸€ä¸ªç±»å‹
â”‚
â”œâ”€ æ–‡æ¡£
â”‚  â”œâ”€ ç›¸å½“äºå…³ç³»æ•°æ®åº“çš„"è¡Œ"
â”‚  â””â”€ æœ€å°æ•°æ®å•å…ƒï¼ŒJSON æ ¼å¼
â”‚
â”œâ”€ å­—æ®µ
â”‚  â”œâ”€ ç›¸å½“äºå…³ç³»æ•°æ®åº“çš„"åˆ—"
â”‚  â””â”€ æ–‡æ¡£ä¸­çš„é”®å€¼å¯¹
â”‚
â”œâ”€ åˆ†ç‰‡
â”‚  â””â”€ å°†ç´¢å¼•åˆ†å‰²æˆå¤šä¸ªåˆ†ç‰‡ï¼Œåˆ†å¸ƒå¼å­˜å‚¨
â”‚
â””â”€ å‰¯æœ¬
   â””â”€ åˆ†ç‰‡çš„å†—ä½™å¤‡ä»½ï¼Œæé«˜å¯ç”¨æ€§
```

---

#### 1.2 ä¸å…³ç³»æ•°æ®åº“å¯¹æ¯”

| Elasticsearch | å…³ç³»æ•°æ®åº“ | è¯´æ˜ |
|-------------|-----------|------|
| ç´¢å¼• | æ•°æ®åº“/è¡¨ | æ–‡æ¡£é›†åˆ |
| ç±»å‹ | è¡¨ç»“æ„ | ES 7.x+ å·²åºŸå¼ƒ |
| æ–‡æ¡£ | è¡Œ | æœ€å°æ•°æ®å•å…ƒ |
| å­—æ®µ | åˆ— | æ•°æ®å±æ€§ |
| æ˜ å°„ | Schema | å­—æ®µç±»å‹å’Œå±æ€§ |
| åˆ†ç‰‡ | åˆ†åŒº | æ•°æ®åˆ†å‰² |
| å‰¯æœ¬ | å¤‡ä»½ | æ•°æ®å†—ä½™ |

---

### 2ï¸âƒ£ ç´¢å¼•è®¾è®¡ä¸ Mapping

#### 2.1 Mapping åŸºç¡€

**Mapping å®šä¹‰**ï¼šç´¢å¼•ä¸­å­—æ®µçš„ç±»å‹å’Œå±æ€§

**å¸¸è§å­—æ®µç±»å‹**ï¼š

| ç±»å‹ | ES ç±»å‹ | ç¤ºä¾‹ | è¯´æ˜ |
|------|---------|------|------|
| **æ–‡æœ¬** | text | "hello world" | å…¨æ–‡æœç´¢ï¼Œåˆ†è¯ |
| **å…³é”®å­—** | keyword | "nginx" | ç²¾ç¡®åŒ¹é…ï¼Œä¸åˆ†è¯ |
| **æ•°å€¼** | integer, long, float, double | 123, 3.14 | æ•°å€¼ç±»å‹ |
| **å¸ƒå°”** | boolean | true/false | å¸ƒå°”å€¼ |
| **æ—¥æœŸ** | date | "2026-01-23" | æ—¥æœŸæ—¶é—´ |
| **IP åœ°å€** | ip | "192.168.1.10" | IP åœ°å€ |
| **å¯¹è±¡** | object | {"name": "..."} | åµŒå¥—å¯¹è±¡ |
| **åœ°ç†åæ ‡** | geo_point | {"lat": 39.9, "lon": 116.4} | ç»çº¬åº¦ |

---

#### 2.2 text vs keyword åŒºåˆ«

| ç‰¹æ€§ | text | keyword |
|------|------|---------|
| **åˆ†è¯** | âœ… æ”¯æŒåˆ†è¯ | âŒ ä¸åˆ†è¯ |
| **æœç´¢** | å…¨æ–‡æœç´¢ | ç²¾ç¡®åŒ¹é… |
| **èšåˆ** | ä¸é€‚åˆ | é€‚åˆ |
| **æ’åº** | ä¸é€‚åˆ | é€‚åˆ |
| **ç¤ºä¾‹ç”¨é€”** | æ—¥å¿—æ¶ˆæ¯ã€æ–‡ç« å†…å®¹ | çŠ¶æ€ç ã€ç”¨æˆ· IDã€æ ‡ç­¾ |

**ç¤ºä¾‹**ï¼š

```json
{
  "message": "User admin logged in successfully",
  "level": "INFO",
  "status_code": 200
}
```

**Mapping**ï¼š

```json
{
  "properties": {
    "message": {
      "type": "text",      // å…¨æ–‡æœç´¢
      "fields": {
        "keyword": {
          "type": "keyword",  // åŒæ—¶åˆ›å»º keyword ç±»å‹ç”¨äºèšåˆå’Œæ’åº
          "ignore_above": 256
        }
      }
    },
    "level": {
      "type": "keyword"    // ç²¾ç¡®åŒ¹é…ï¼Œé€‚åˆèšåˆ
    },
    "status_code": {
      "type": "integer"    // æ•°å€¼ç±»å‹ï¼Œé€‚åˆèŒƒå›´æŸ¥è¯¢
    }
  }
}
```

---

#### 2.3 åˆ†ç‰‡ä¸å‰¯æœ¬

**åˆ†ç‰‡**ï¼šå°†ç´¢å¼•åˆ†å‰²æˆå¤šä¸ªåˆ†ç‰‡ï¼Œå®ç°åˆ†å¸ƒå¼å­˜å‚¨

**å‰¯æœ¬**ï¼šåˆ†ç‰‡çš„å†—ä½™å¤‡ä»½ï¼Œæé«˜å¯ç”¨æ€§å’ŒæŸ¥è¯¢æ€§èƒ½

**åˆ†ç‰‡ç­–ç•¥**ï¼š

```
åˆ†ç‰‡æ•° = (é¢„è®¡æ•°æ®é‡ / å•åˆ†ç‰‡å¤§å°)

è§„åˆ™ï¼š
- å•åˆ†ç‰‡å»ºè®®å¤§å°ï¼š10GB - 50GB
- åˆ†ç‰‡æ•°è¿‡å¤šï¼šå½±å“é›†ç¾¤æ€§èƒ½
- åˆ†ç‰‡æ•°è¿‡å°‘ï¼šå•ä¸ªåˆ†ç‰‡è¿‡å¤§

ç¤ºä¾‹ï¼š
- é¢„è®¡æ•°æ®é‡ï¼š100GB
- å•åˆ†ç‰‡å¤§å°ï¼š20GB
- åˆ†ç‰‡æ•°ï¼š100GB / 20GB = 5 ä¸ªä¸»åˆ†ç‰‡
```

**å‰¯æœ¬ç­–ç•¥**ï¼š

```
å‰¯æœ¬æ•° = (å¯ç”¨æ€§è¦æ±‚ - 1)

ç¤ºä¾‹ï¼š
- 1 ä¸ªå‰¯æœ¬ï¼š2 ä¸ªå‰¯æœ¬ï¼ˆ1 ä¸» + 1 å‰¯ï¼‰
  - æœ€å¤š 1 ä¸ªèŠ‚ç‚¹æ•…éšœ
  
- 2 ä¸ªå‰¯æœ¬ï¼š3 ä¸ªå‰¯æœ¬ï¼ˆ1 ä¸» + 2 å‰¯ï¼‰
  - æœ€å¤š 2 ä¸ªèŠ‚ç‚¹æ•…éšœ

- ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼š1 ä¸ªå‰¯æœ¬ä»¥ä¸Š
```

---

#### 2.4 ç´¢å¼•åˆ›å»ºç¤ºä¾‹

**åˆ›å»ºæ—¥å¿—ç´¢å¼•**ï¼š

```json
PUT /logs-2026-01-23
{
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1,
    "refresh_interval": "1s"
  },
  "mappings": {
    "properties": {
      "timestamp": {
        "type": "date",
        "format": "strict_date_optional_time||epoch_millis"
      },
      "level": {
        "type": "keyword"
      },
      "hostname": {
        "type": "keyword"
      },
      "service": {
        "type": "keyword"
      },
      "event_type": {
        "type": "keyword"
      },
      "ip_address": {
        "type": "ip"
      },
      "user_id": {
        "type": "keyword"
      },
      "http": {
        "properties": {
          "method": {
            "type": "keyword"
          },
          "path": {
            "type": "keyword"
          },
          "status_code": {
            "type": "integer"
          },
          "response_size": {
            "type": "long"
          },
          "duration_ms": {
            "type": "integer"
          }
        }
      },
      "context": {
        "properties": {
          "user_agent": {
            "type": "text",
            "fields": {
              "keyword": {
                "type": "keyword",
                "ignore_above": 512
              }
            }
          },
          "referer": {
            "type": "keyword"
          }
        }
      }
    }
  }
}
```

---

### 3ï¸âƒ£ åŸºç¡€æŸ¥è¯¢ DSL

#### 3.1 æŸ¥è¯¢åŸºæœ¬ç»“æ„

```json
{
  "query": {
    // æŸ¥è¯¢æ¡ä»¶
  },
  "sort": [
    // æ’åºè§„åˆ™
  ],
  "from": 0,
  "size": 10,
  "_source": ["field1", "field2"],
  "aggs": {
    // èšåˆ
  }
}
```

---

#### 3.2 å¸¸ç”¨æŸ¥è¯¢ç±»å‹

**1. match_allï¼ˆæŸ¥è¯¢æ‰€æœ‰ï¼‰**

```json
GET /logs-*/_search
{
  "query": {
    "match_all": {}
  },
  "size": 10
}
```

**2. matchï¼ˆå…¨æ–‡æœç´¢ï¼‰**

```json
GET /logs-*/_search
{
  "query": {
    "match": {
      "message": "error"
    }
  }
}
```

**3. termï¼ˆç²¾ç¡®åŒ¹é…ï¼‰**

```json
GET /logs-*/_search
{
  "query": {
    "term": {
      "level": "ERROR"
    }
  }
}
```

**4. termsï¼ˆå¤šå€¼ç²¾ç¡®åŒ¹é…ï¼‰**

```json
GET /logs-*/_search
{
  "query": {
    "terms": {
      "level": ["ERROR", "CRITICAL"]
    }
  }
}
```

**5. rangeï¼ˆèŒƒå›´æŸ¥è¯¢ï¼‰**

```json
GET /logs-*/_search
{
  "query": {
    "range": {
      "timestamp": {
        "gte": "now-1h",
        "lte": "now"
      }
    }
  }
}
```

**6. boolï¼ˆå¸ƒå°”ç»„åˆï¼‰**

```json
GET /logs-*/_search
{
  "query": {
    "bool": {
      "must": [
        { "term": { "level": "ERROR" } },
        { "range": { "http.status_code": { "gte": 500 } } }
      ],
      "must_not": [
        { "term": { "service": "health-check" } }
      ],
      "should": [
        { "match": { "message": "timeout" } },
        { "match": { "message": "connection refused" } }
      ],
      "minimum_should_match": 1
    }
  }
}
```

---

#### 3.3 èšåˆæŸ¥è¯¢

**1. terms èšåˆï¼ˆåˆ†ç»„ç»Ÿè®¡ï¼‰**

```json
GET /logs-*/_search
{
  "size": 0,
  "aggs": {
    "by_level": {
      "terms": {
        "field": "level",
        "size": 10
      }
    }
  }
}
```

**2. date_histogramï¼ˆæ—¶é—´ç›´æ–¹å›¾ï¼‰**

```json
GET /logs-*/_search
{
  "size": 0,
  "aggs": {
    "logs_over_time": {
      "date_histogram": {
        "field": "timestamp",
        "calendar_interval": "hour"
      }
    }
  }
}
```

**3. stats ç»Ÿè®¡**

```json
GET /logs-*/_search
{
  "size": 0,
  "aggs": {
    "response_time_stats": {
      "stats": {
        "field": "http.duration_ms"
      }
    }
  }
}
```

**4. bucket_sort + top_hitsï¼ˆåˆ†ç»„å– Top Nï¼‰**

```json
GET /logs-*/_search
{
  "size": 0,
  "aggs": {
    "by_host": {
      "terms": {
        "field": "hostname",
        "size": 5
      },
      "aggs": {
        "top_errors": {
          "top_hits": {
            "sort": [
              { "timestamp": { "order": "desc" } }
            ],
            "size": 5
          }
        }
      }
    }
  }
}
```

---

### 4ï¸âƒ£ Kibana å¯è§†åŒ–

#### 4.1 Kibana ç®€ä»‹

**Kibana** æ˜¯ Elastic Stack çš„å¯è§†åŒ–å¹³å°ï¼Œæä¾›ï¼š

- **Discover**ï¼šæœç´¢å’ŒæŸ¥çœ‹æ—¥å¿—
- **Visualize**ï¼šåˆ›å»ºå¯è§†åŒ–å›¾è¡¨
- **Dashboard**ï¼šæ„å»ºä»ªè¡¨ç›˜
- **Alerting**ï¼šé…ç½®å‘Šè­¦è§„åˆ™

---

#### 4.2 åˆ›å»ºå¯è§†åŒ–

**1. æ¡å½¢å›¾ï¼ˆBar Chartï¼‰**

```
æ•°æ®æºï¼šlogs-*
èšåˆï¼šTerms Aggregation
å­—æ®µï¼šlevel
æ’åºï¼šCount é™åº
```

**2. æŠ˜çº¿å›¾ï¼ˆLine Chartï¼‰**

```
æ•°æ®æºï¼šlogs-*
X è½´ï¼šDate Histogram (timestamp)
Y è½´ï¼šCount
```

**3. é¥¼å›¾ï¼ˆPie Chartï¼‰**

```
æ•°æ®æºï¼šlogs-*
èšåˆï¼šTerms Aggregation
å­—æ®µï¼šservice
```

**4. æ•°æ®è¡¨æ ¼ï¼ˆData Tableï¼‰**

```
æ•°æ®æºï¼šlogs-*
åˆ—ï¼štimestamp, hostname, service, level, message
æ’åºï¼štimestamp é™åº
```

---

#### 4.3 æ„å»ºä»ªè¡¨ç›˜

1. **è¿›å…¥ Dashboard**ï¼šKibana â†’ Dashboard â†’ Create Dashboard
2. **æ·»åŠ å¯è§†åŒ–**ï¼šAdd from library æˆ– Create new
3. **è°ƒæ•´å¸ƒå±€**ï¼šæ‹–æ‹½è°ƒæ•´å›¾è¡¨ä½ç½®
4. **ä¿å­˜ä»ªè¡¨ç›˜**ï¼šä¿å­˜å¹¶å‘½å

---

### 5ï¸âƒ£ æ€§èƒ½ä¼˜åŒ–

#### 5.1 Mapping ä¼˜åŒ–

**1. å­—æ®µç±»å‹é€‰æ‹©**

```json
// ä¸æ¨èï¼štext ç±»å‹ä¸é€‚åˆèšåˆå’Œæ’åº
{
  "level": {
    "type": "text"
  }
}

// æ¨èï¼škeyword ç±»å‹é€‚åˆç²¾ç¡®åŒ¹é…å’Œèšåˆ
{
  "level": {
    "type": "keyword"
  }
}

// æ¨èï¼šåŒæ—¶ä¿ç•™ text å’Œ keyword
{
  "message": {
    "type": "text",
    "fields": {
      "keyword": {
        "type": "keyword"
      }
    }
  }
}
```

**2. _source å­˜å‚¨**

```json
{
  "_source": {
    "enabled": false  // ç¦ç”¨ _sourceï¼ŒèŠ‚çœç£ç›˜ç©ºé—´
  },
  "properties": {
    "timestamp": { "type": "date" }
  }
}
```

---

#### 5.2 æŸ¥è¯¢ä¼˜åŒ–

**1. ä½¿ç”¨ filter è€Œé query**

```json
// ä¸æ¨èï¼šquery ä¼šè®¡ç®—ç›¸å…³æ€§åˆ†
{
  "query": {
    "term": { "level": "ERROR" }
  }
}

// æ¨èï¼šfilter ä¸è®¡ç®—åˆ†ï¼Œæ€§èƒ½æ›´å¥½
{
  "query": {
    "bool": {
      "filter": [
        { "term": { "level": "ERROR" } }
      ]
    }
  }
}
```

**2. ä½¿ç”¨ filter context**

```json
{
  "query": {
    "bool": {
      "must": {
        "match": { "message": "error" }
      },
      "filter": [
        { "range": { "timestamp": { "gte": "now-1h" } } }
      ]
    }
  }
}
```

**3. é™åˆ¶è¿”å›å­—æ®µ**

```json
{
  "_source": ["timestamp", "level", "message"],
  "query": {
    "match_all": {}
  }
}
```

---

#### 5.3 ç´¢å¼•ä¼˜åŒ–

**1. ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆILMï¼‰**

```json
PUT /_ilm/policy/logs_policy
{
  "policy": {
    "phases": {
      "hot": {
        "actions": {
          "rollover": {
            "max_size": "50GB",
            "max_age": "30d"
          }
        }
      },
      "warm": {
        "min_age": "30d",
        "actions": {
          "shrink": {
            "number_of_shards": 1
          },
          "forcemerge": {
            "max_num_segments": 1
          }
        }
      },
      "delete": {
        "min_age": "90d",
        "actions": {
          "delete": {}
        }
      }
    }
  }
}
```

**2. ç´¢å¼•æ¨¡æ¿**

```json
PUT /_template/logs_template
{
  "index_patterns": ["logs-*"],
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1,
    "index.lifecycle.name": "logs_policy",
    "index.lifecycle.rollover_alias": "logs"
  },
  "mappings": {
    // Mapping å®šä¹‰
  }
}
```

---

## å®è·µä»»åŠ¡ï¼ˆåˆæ³•æˆæƒèŒƒå›´å†…ï¼‰

> **æ³¨æ„**ï¼šè¯·åœ¨ä½ è‡ªå·±çš„æµ‹è¯•ç¯å¢ƒä¸­æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ã€‚

---

### ä»»åŠ¡ 1ï¼ˆå¿…åšï¼‰ï¼šåˆ›å»ºæ—¥å¿—ç´¢å¼•

**ç›®æ ‡**ï¼šåˆ›å»ºæ—¥å¿—ç´¢å¼•å¹¶å®šä¹‰ Mappingã€‚

**æ­¥éª¤**ï¼š

1. **åˆ›å»ºç´¢å¼•**

```bash
curl -X PUT "localhost:9200/logs-2026-01-23?pretty" -H 'Content-Type: application/json' -d'
{
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1
  },
  "mappings": {
    "properties": {
      "timestamp": {
        "type": "date",
        "format": "strict_date_optional_time||epoch_millis"
      },
      "level": {
        "type": "keyword"
      },
      "hostname": {
        "type": "keyword"
      },
      "service": {
        "type": "keyword"
      },
      "event_type": {
        "type": "keyword"
      },
      "message": {
        "type": "text",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 256
          }
        }
      },
      "http": {
        "properties": {
          "method": {
            "type": "keyword"
          },
          "path": {
            "type": "keyword"
          },
          "status_code": {
            "type": "integer"
          },
          "response_size": {
            "type": "long"
          },
          "duration_ms": {
            "type": "integer"
          }
        }
      }
    }
  }
}'
```

2. **éªŒè¯ç´¢å¼•åˆ›å»º**

```bash
# æŸ¥çœ‹ç´¢å¼•ä¿¡æ¯
curl -X GET "localhost:9200/logs-2026-01-23?pretty"

# æŸ¥çœ‹ Mapping
curl -X GET "localhost:9200/logs-2026-01-23/_mapping?pretty"
```

---

### ä»»åŠ¡ 2ï¼ˆå¿…åšï¼‰ï¼šå¯¼å…¥æ ·ä¾‹æ—¥å¿—

**ç›®æ ‡**ï¼šå‘ç´¢å¼•ä¸­å¯¼å…¥æ ·ä¾‹æ—¥å¿—æ•°æ®ã€‚

**æ­¥éª¤**ï¼š

1. **å‡†å¤‡æ ·ä¾‹æ•°æ®**

```json
[
  {
    "timestamp": "2026-01-23T10:00:00.000Z",
    "level": "INFO",
    "hostname": "web-01",
    "service": "nginx",
    "event_type": "http_access",
    "message": "GET /api/users HTTP/1.1\" 200 1234",
    "http": {
      "method": "GET",
      "path": "/api/users",
      "status_code": 200,
      "response_size": 1234,
      "duration_ms": 45
    }
  },
  {
    "timestamp": "2026-01-23T10:00:01.000Z",
    "level": "ERROR",
    "hostname": "app-01",
    "service": "user-service",
    "event_type": "error",
    "message": "Connection timeout to database"
  },
  {
    "timestamp": "2026-01-23T10:00:02.000Z",
    "level": "WARNING",
    "hostname": "db-01",
    "service": "mysql",
    "event_type": "slow_query",
    "message": "Query took 5.2 seconds"
  },
  {
    "timestamp": "2026-01-23T10:00:03.000Z",
    "level": "INFO",
    "hostname": "web-01",
    "service": "nginx",
    "event_type": "http_access",
    "message": "GET /api/data HTTP/1.1\" 200 5678",
    "http": {
      "method": "GET",
      "path": "/api/data",
      "status_code": 200,
      "response_size": 5678,
      "duration_ms": 123
    }
  },
  {
    "timestamp": "2026-01-23T10:00:04.000Z",
    "level": "CRITICAL",
    "hostname": "app-02",
    "service": "payment-service",
    "event_type": "payment_failed",
    "message": "Payment gateway timeout"
  }
]
```

2. **å¯¼å…¥æ•°æ®**

```bash
# æ–¹æ³• 1ï¼šé€æ¡å¯¼å…¥
curl -X POST "localhost:9200/logs-2026-01-23/_doc?pretty" -H 'Content-Type: application/json' -d'
{
  "timestamp": "2026-01-23T10:00:00.000Z",
  "level": "INFO",
  "hostname": "web-01",
  "service": "nginx",
  "event_type": "http_access",
  "message": "GET /api/users",
  "http": {
    "method": "GET",
    "path": "/api/users",
    "status_code": 200,
    "response_size": 1234,
    "duration_ms": 45
  }
}'
```

```bash
# æ–¹æ³• 2ï¼šæ‰¹é‡å¯¼å…¥
curl -X POST "localhost:9200/logs-2026-01-23/_bulk?pretty" -H 'Content-Type: application/json' --data-binary @logs.json
```

å…¶ä¸­ `logs.json` æ ¼å¼ï¼š

```json
{"index": {"_index": "logs-2026-01-23"}}
{"timestamp": "2026-01-23T10:00:00.000Z", "level": "INFO", "hostname": "web-01", "service": "nginx", "event_type": "http_access", "message": "GET /api/users", "http": {"method": "GET", "path": "/api/users", "status_code": 200, "response_size": 1234, "duration_ms": 45}}
{"index": {"_index": "logs-2026-01-23"}}
{"timestamp": "2026-01-23T10:00:01.000Z", "level": "ERROR", "hostname": "app-01", "service": "user-service", "event_type": "error", "message": "Connection timeout to database"}
```

3. **åˆ·æ–°ç´¢å¼•**

```bash
# å¼ºåˆ¶åˆ·æ–°ï¼ˆä½¿æ•°æ®å¯æœç´¢ï¼‰
curl -X POST "localhost:9200/logs-2026-01-23/_refresh"
```

---

### ä»»åŠ¡ 3ï¼ˆå¿…åšï¼‰ï¼šåŸºç¡€æŸ¥è¯¢ç»ƒä¹ 

**ç›®æ ‡**ï¼šæ‰§è¡Œå„ç§æŸ¥è¯¢å¹¶ç†è§£ç»“æœã€‚

**æ­¥éª¤**ï¼š

1. **æŸ¥è¯¢æ‰€æœ‰æ—¥å¿—**

```bash
curl -X GET "localhost:9200/logs-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "match_all": {}
  },
  "size": 10
}'
```

2. **æŸ¥è¯¢ ERROR çº§åˆ«æ—¥å¿—**

```bash
curl -X GET "localhost:9200/logs-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "term": {
      "level": "ERROR"
    }
  }
}'
```

3. **æŸ¥è¯¢æœ€è¿‘ 1 å°æ—¶çš„æ—¥å¿—**

```bash
curl -X GET "localhost:9200/logs-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "range": {
      "timestamp": {
        "gte": "now-1h"
      }
    }
  }
}'
```

4. **æŸ¥è¯¢ç‰¹å®šæœåŠ¡çš„æ—¥å¿—**

```bash
curl -X GET "localhost:9200/logs-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "term": {
      "service": "nginx"
    }
  }
}'
```

5. **ç»„åˆæŸ¥è¯¢ï¼ˆERROR çº§åˆ« + nginx æœåŠ¡ï¼‰**

```bash
curl -X GET "localhost:9200/logs-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "bool": {
      "must": [
        { "term": { "level": "ERROR" } },
        { "term": { "service": "nginx" } }
      ]
    }
  }
}'
```

---

### ä»»åŠ¡ 4ï¼ˆå¿…åšï¼‰ï¼šèšåˆæŸ¥è¯¢ç»ƒä¹ 

**ç›®æ ‡**ï¼šæ‰§è¡ŒèšåˆæŸ¥è¯¢ï¼Œç”Ÿæˆç»Ÿè®¡æ•°æ®ã€‚

**æ­¥éª¤**ï¼š

1. **æŒ‰æ—¥å¿—çº§åˆ«ç»Ÿè®¡**

```bash
curl -X GET "localhost:9200/logs-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "size": 0,
  "aggs": {
    "by_level": {
      "terms": {
        "field": "level",
        "size": 10
      }
    }
  }
}'
```

2. **æŒ‰æœåŠ¡ç»Ÿè®¡**

```bash
curl -X GET "localhost:9200/logs-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "size": 0,
  "aggs": {
    "by_service": {
      "terms": {
        "field": "service",
        "size": 10
      }
    }
  }
}'
```

3. **æŒ‰æ—¶é—´ç»Ÿè®¡ï¼ˆæ¯å°æ—¶ï¼‰**

```bash
curl -X GET "localhost:9200/logs-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "size": 0,
  "aggs": {
    "logs_over_time": {
      "date_histogram": {
        "field": "timestamp",
        "calendar_interval": "hour"
      }
    }
  }
}'
```

4. **å“åº”æ—¶é—´ç»Ÿè®¡**

```bash
curl -X GET "localhost:9200/logs-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "size": 0,
  "query": {
    "bool": {
      "must": [
        { "exists": { "field": "http.duration_ms" } }
      ]
    }
  },
  "aggs": {
    "duration_stats": {
      "stats": {
        "field": "http.duration_ms"
      }
    }
  }
}'
```

5. **ç»„åˆèšåˆï¼ˆæŒ‰æœåŠ¡åˆ†ç»„ï¼Œç»Ÿè®¡æ¯ä¸ªæœåŠ¡çš„é”™è¯¯æ•°ï¼‰**

```bash
curl -X GET "localhost:9200/logs-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "size": 0,
  "query": {
    "term": {
      "level": "ERROR"
    }
  },
  "aggs": {
    "by_service": {
      "terms": {
        "field": "service",
        "size": 10
      },
      "aggs": {
        "top_errors": {
          "top_hits": {
            "sort": [
              { "timestamp": { "order": "desc" } }
            ],
            "size": 5
          }
        }
      }
    }
  }
}'
```

---

### ä»»åŠ¡ 5ï¼ˆå¿…åšï¼‰ï¼šKibana å¯è§†åŒ–

**ç›®æ ‡**ï¼šåœ¨ Kibana ä¸­åˆ›å»ºå¯è§†åŒ–å›¾è¡¨å’Œä»ªè¡¨ç›˜ã€‚

**æ­¥éª¤**ï¼š

1. **æ‰“å¼€ Kibana**

```
æµè§ˆå™¨è®¿é—®: http://localhost:5601
```

2. **åˆ›å»ºç´¢å¼•æ¨¡å¼**

- è¿›å…¥ Stack Management â†’ Index Patterns
- ç‚¹å‡» Create index pattern
- è¾“å…¥ `logs-*`
- é€‰æ‹©æ—¶é—´å­—æ®µ `timestamp`
- ç‚¹å‡» Create index pattern

3. **Discover æŸ¥çœ‹æ—¥å¿—**

- è¿›å…¥ Discover
- é€‰æ‹©ç´¢å¼•æ¨¡å¼ `logs-*`
- æŸ¥çœ‹æ—¥å¿—æ•°æ®

4. **åˆ›å»ºå¯è§†åŒ–**

**åˆ›å»ºæ¡å½¢å›¾ï¼ˆæŒ‰æ—¥å¿—çº§åˆ«ï¼‰**ï¼š

- è¿›å…¥ Visualize Library
- é€‰æ‹© Create Visualization â†’ Bar Chart
- é€‰æ‹©æ•°æ®æº `logs-*`
- Buckets â†’ Split buckets â†’ Aggregation: Terms â†’ Field: level
- Metrics â†’ Count
- ç‚¹å‡» Update
- ä¿å­˜ä¸ºï¼š`Logs by Level`

**åˆ›å»ºæŠ˜çº¿å›¾ï¼ˆæŒ‰æ—¶é—´ï¼‰**ï¼š

- è¿›å…¥ Visualize Library
- é€‰æ‹© Create Visualization â†’ Line Chart
- é€‰æ‹©æ•°æ®æº `logs-*`
- Buckets â†’ X-Axis â†’ Date Histogram â†’ Field: timestamp â†’ Interval: Hour
- Metrics â†’ Count
- ç‚¹å‡» Update
- ä¿å­˜ä¸ºï¼š`Logs over Time`

5. **åˆ›å»ºä»ªè¡¨ç›˜**

- è¿›å…¥ Dashboard â†’ Create Dashboard
- ç‚¹å‡» Add from library
- é€‰æ‹© `Logs by Level` å’Œ `Logs over Time`
- è°ƒæ•´å¸ƒå±€
- ä¿å­˜ä¸ºï¼š`Logs Dashboard`

---

### ä»»åŠ¡ 6ï¼ˆè¿›é˜¶ï¼‰ï¼šåˆ›å»ºç´¢å¼•æ¨¡æ¿

**ç›®æ ‡**ï¼šåˆ›å»ºç´¢å¼•æ¨¡æ¿ï¼Œè‡ªåŠ¨åº”ç”¨ Mapping å’Œè®¾ç½®ã€‚

**æ­¥éª¤**ï¼š

1. **åˆ›å»ºç´¢å¼•æ¨¡æ¿**

```bash
curl -X PUT "localhost:9200/_template/logs_template?pretty" -H 'Content-Type: application/json' -d'
{
  "index_patterns": ["logs-*"],
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1,
    "refresh_interval": "1s"
  },
  "mappings": {
    "properties": {
      "timestamp": {
        "type": "date",
        "format": "strict_date_optional_time||epoch_millis"
      },
      "level": {
        "type": "keyword"
      },
      "hostname": {
        "type": "keyword"
      },
      "service": {
        "type": "keyword"
      },
      "event_type": {
        "type": "keyword"
      },
      "message": {
        "type": "text",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 256
          }
        }
      },
      "http": {
        "properties": {
          "method": {
            "type": "keyword"
          },
          "path": {
            "type": "keyword"
          },
          "status_code": {
            "type": "integer"
          },
          "response_size": {
            "type": "long"
          },
          "duration_ms": {
            "type": "integer"
          }
        }
      }
    }
  }
}'
```

2. **éªŒè¯æ¨¡æ¿**

```bash
# æŸ¥çœ‹æ‰€æœ‰æ¨¡æ¿
curl -X GET "localhost:9200/_template/logs_template?pretty"

# æŸ¥çœ‹ç‰¹å®šç´¢å¼•çš„æ¨¡æ¿
curl -X GET "localhost:9200/logs-2026-01-24/_mapping?pretty"
```

3. **åº”ç”¨æ¨¡æ¿**

åˆ›å»ºæ–°ç´¢å¼•æ—¶ï¼Œæ¨¡æ¿ä¼šè‡ªåŠ¨åº”ç”¨ï¼š

```bash
curl -X PUT "localhost:9200/logs-2026-01-24?pretty"
```

---

## å·©å›ºç»ƒä¹ ï¼ˆé¢˜ä¸å¤ç›˜ï¼‰

---

### ç»ƒä¹  1ï¼šæ˜ å°„ä¸å½“ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜ï¼Ÿ

**æ€è·¯æç¤º**ï¼š

- å­—æ®µç±»å‹é”™è¯¯ï¼ˆtext vs keywordï¼‰
- åˆ†è¯ä¸å½“å¯¼è‡´çš„æŸ¥è¯¢é—®é¢˜
- ç¼ºå°‘å­—æ®µå¯¼è‡´çš„æ•°æ®ä¸¢å¤±
- è¿‡å¤šçš„å­—æ®µå¯¼è‡´çš„æ€§èƒ½é—®é¢˜

---

### ç»ƒä¹  2ï¼šä¼˜åŒ–ä¸€ä¸ªæŸ¥è¯¢çš„æ€§èƒ½

**ä»»åŠ¡**ï¼šä¼˜åŒ–ä»¥ä¸‹æŸ¥è¯¢çš„æ€§èƒ½ã€‚

**åŸå§‹æŸ¥è¯¢**ï¼š

```json
{
  "query": {
    "bool": {
      "must": [
        { "match": { "message": "error" } },
        { "range": { "timestamp": { "gte": "now-1h" } } }
      ]
    }
  },
  "size": 100
}
```

**æ€è·¯æç¤º**ï¼š

- ä½¿ç”¨ filter context
- é™åˆ¶è¿”å›å­—æ®µ
- è€ƒè™‘ä½¿ç”¨ index patterns

---

### ç»ƒä¹  3ï¼šè®¾è®¡æ—¥å¿—ç´¢å¼•çš„ Mapping

**ä»»åŠ¡**ï¼šä¸ºä»¥ä¸‹æ—¥å¿—è®¾è®¡åˆç†çš„ Mappingã€‚

**æ—¥å¿—ç¤ºä¾‹**ï¼š

```json
{
  "timestamp": "2026-01-23T10:00:00.123Z",
  "level": "INFO",
  "logger": "com.example.app",
  "thread": "main",
  "message": "User admin logged in",
  "context": {
    "userId": "12345",
    "ipAddress": "192.168.1.10",
    "sessionId": "abc123"
  }
}
```

**è¦æ±‚**ï¼š

1. `timestamp` å¿…é¡»æ˜¯ date ç±»å‹
2. `level` å¿…é¡»æ˜¯ keyword ç±»å‹ï¼ˆç”¨äºèšåˆï¼‰
3. `message` å¿…é¡»æ˜¯ text ç±»å‹ï¼ˆç”¨äºå…¨æ–‡æœç´¢ï¼‰
4. `context` å¿…é¡»æ˜¯ object ç±»å‹

---

### ç»ƒä¹  4ï¼šè®¾è®¡ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç­–ç•¥

**ä»»åŠ¡**ï¼šä¸ºæ—¥å¿—ç´¢å¼•è®¾è®¡ ILM ç­–ç•¥ã€‚

**è¦æ±‚**ï¼š

1. å‰ 7 å¤©ï¼šhot é˜¶æ®µï¼ˆé«˜æ€§èƒ½å†™å…¥ï¼‰
2. 7-30 å¤©ï¼šwarm é˜¶æ®µï¼ˆå‹ç¼©å­˜å‚¨ï¼‰
3. 30-90 å¤©ï¼šcold é˜¶æ®µï¼ˆè¿›ä¸€æ­¥å‹ç¼©ï¼‰
4. è¶…è¿‡ 90 å¤©ï¼šdelete é˜¶æ®µï¼ˆåˆ é™¤ï¼‰

**æ€è·¯æç¤º**ï¼š

- ä½¿ç”¨ index lifecycle management
- å®šä¹‰å„é˜¶æ®µçš„æ“ä½œ

---

## è¯„ä¼°æ ‡å‡†ï¼ˆè¾¾æˆåˆ¤å®šï¼‰

- âœ… æˆåŠŸåˆ›å»ºäº†æ—¥å¿—ç´¢å¼•å¹¶å®šä¹‰ Mapping
- âœ… æˆåŠŸå¯¼å…¥æ ·ä¾‹æ—¥å¿—æ•°æ®
- âœ… æ‰§è¡Œäº†åŸºç¡€æŸ¥è¯¢ï¼ˆmatchã€termã€rangeã€boolï¼‰
- âœ… æ‰§è¡Œäº†èšåˆæŸ¥è¯¢ï¼ˆtermsã€date_histogramã€statsï¼‰
- âœ… åœ¨ Kibana ä¸­åˆ›å»ºäº†å¯è§†åŒ–å›¾è¡¨
- âœ… åœ¨ Kibana ä¸­åˆ›å»ºäº†ä»ªè¡¨ç›˜
- âœ… ç†è§£äº†ç´¢å¼•æ¨¡æ¿çš„ä½œç”¨

---

## å·©å›ºç»ƒä¹ ï¼ˆé¢˜ä¸å¤ç›˜ï¼‰
- é¢˜ç›®ï¼šæ˜ å°„ä¸å½“ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜ï¼Ÿ
- ç»ƒä¹ ï¼šä¼˜åŒ–ä¸€ä¸ªæŸ¥è¯¢çš„æ€§èƒ½

## è¯„ä¼°æ ‡å‡†ï¼ˆè¾¾æˆåˆ¤å®šï¼‰
- ç´¢å¼•ä¸æŸ¥è¯¢å·¥ä½œæ­£å¸¸
- æäº¤æŸ¥è¯¢ä¸å›¾è¡¨æˆªå›¾

## å­¦ä¹ æˆæœè¾¾æˆæƒ…å†µï¼ˆç”±å­¦ä¹ è€…å¡«å†™ï¼‰

---

### æˆªå›¾ä¸è¯æ®

- [ ] Elasticsearch ç´¢å¼•åˆ›å»ºæˆåŠŸæˆªå›¾
- [ ] Mapping å®šä¹‰æˆªå›¾
- [ ] æ ·ä¾‹æ—¥å¿—å¯¼å…¥æˆªå›¾
- [ ] æŸ¥è¯¢æ‰§è¡Œç»“æœæˆªå›¾
- [ ] èšåˆæŸ¥è¯¢ç»“æœæˆªå›¾
- [ ] Kibana å¯è§†åŒ–å›¾è¡¨æˆªå›¾
- [ ] Kibana ä»ªè¡¨ç›˜æˆªå›¾
- [ ] ç´¢å¼•æ¨¡æ¿åˆ›å»ºæˆªå›¾

---

### å…³é”®å‘½ä»¤ä¸è¾“å‡ºï¼ˆç²˜è´´å…³é”®ç‰‡æ®µï¼‰

**åˆ›å»ºç´¢å¼•**ï¼š

```bash
$ curl -X PUT "localhost:9200/logs-2026-01-23?pretty"
{
  "acknowledged" : true,
  "shards_acknowledged" : 3,
  "index" : "logs-2026-01-23"
}
```

**æŸ¥çœ‹ Mapping**ï¼š

```bash
$ curl -X GET "localhost:9200/logs-2026-01-23/_mapping?pretty"
{
  "logs-2026-01-23" : {
    "mappings" : {
      "properties" : {
        "timestamp" : {
          "type" : "date"
        },
        "level" : {
          "type" : "keyword"
        },
        "hostname" : {
          "type" : "keyword"
        },
        "service" : {
          "type" : "keyword"
        }
      }
    }
  }
}
```

**å¯¼å…¥æ•°æ®**ï¼š

```bash
$ curl -X POST "localhost:9200/logs-2026-01-23/_doc?pretty" -d'
{
  "timestamp": "2026-01-23T10:00:00.000Z",
  "level": "INFO",
  "hostname": "web-01",
  "service": "nginx",
  "event_type": "http_access",
  "message": "GET /api/users HTTP/1.1\" 200 1234",
  "http": {
    "method": "GET",
    "path": "/api/users",
    "status_code": 200,
    "response_size": 1234,
    "duration_ms": 45
  }
}'
```

**æŸ¥è¯¢ç»“æœ**ï¼š

```json
{
  "took" : 2,
  "hits" : {
    "total" : {
      "value" : 5,
      "relation" : "eq"
    },
    "max_score" : 1.0,
    "hits" : [
      {
        "_source" : {
          "timestamp" : "2026-01-23T10:00:00.000Z",
          "level" : "INFO",
          "hostname" : "web-01",
          "service" : "nginx"
        }
      }
    ]
  }
}
```

**èšåˆç»“æœ**ï¼š

```json
{
  "aggregations" : {
    "by_level" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : "INFO",
          "doc_count" : 3
        },
        {
          "key" : "ERROR",
          "doc_count" : 1
        },
        {
          "key" : "CRITICAL",
          "doc_count" : 1
        }
      ]
    }
  }
}
```

---

### ç»“è®ºä¸åæ€

**æˆ‘ä»Šå¤©ææ¸…æ¥šäº†**ï¼š

- Elasticsearch çš„æ ¸å¿ƒæ¦‚å¿µï¼ˆç´¢å¼•ã€æ–‡æ¡£ã€åˆ†ç‰‡ã€å‰¯æœ¬ï¼‰
- Mapping çš„ä½œç”¨å’Œå­—æ®µç±»å‹é€‰æ‹©
- åŸºç¡€æŸ¥è¯¢ DSL çš„ä½¿ç”¨ï¼ˆmatchã€termã€rangeã€boolï¼‰
- èšåˆæŸ¥è¯¢çš„ä½¿ç”¨ï¼ˆtermsã€date_histogramã€statsï¼‰
- Kibana çš„å¯è§†åŒ–åŠŸèƒ½

**æˆ‘å·®ç‚¹ææ··çš„æ˜¯**ï¼š

- text å’Œ keyword ç±»å‹çš„åŒºåˆ«å’Œä½¿ç”¨åœºæ™¯
- query å’Œ filter context çš„åŒºåˆ«
- åˆ†ç‰‡å’Œå‰¯æœ¬çš„ä½œç”¨

**æ˜å¤©æˆ‘è¦ç»§ç»­è¡¥çš„æ˜¯**ï¼š

- å­¦ä¹ æ—¥å¿—å¯è§†åŒ–å’Œå‘Šè­¦ç­–ç•¥ï¼ˆDay032ï¼‰
- äº†è§£æ—¥å¿—è§„èŒƒå’Œå­—æ®µç»Ÿä¸€ï¼ˆDay033ï¼‰

**æœ¬æ¬¡å­¦ä¹ è€—æ—¶**ï¼šçº¦ 4 å°æ—¶

**æŒæ¡ç¨‹åº¦è‡ªè¯„**ï¼š

- [ ] ğŸ˜• ç†è§£äº†åŸºæœ¬æ¦‚å¿µï¼Œä½†å®è·µä¸ç†Ÿç»ƒ
- [ ] ğŸ™‚ å®Œæˆäº†åŸºç¡€ç´¢å¼•å’ŒæŸ¥è¯¢
- [ ] ğŸ˜ƒ å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡å¹¶ç†è§£åŸç†
- [ ] ğŸ¤© é¢å¤–åˆ›å»ºäº†ç´¢å¼•æ¨¡æ¿å’Œ ILM ç­–ç•¥

---

## é›†ä¸­å‚è€ƒç­”æ¡ˆï¼ˆå«æ€è·¯ï¼‰

---

### ç»ƒä¹  1 å‚è€ƒç­”æ¡ˆï¼šæ˜ å°„ä¸å½“ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜ï¼Ÿ

**å¸¸è§æ˜ å°„é—®é¢˜**ï¼š

| é—®é¢˜ç±»å‹ | å…·ä½“è¡¨ç° | å½±å“ | è§£å†³æ–¹æ¡ˆ |
|---------|---------|------|---------|
| **å­—æ®µç±»å‹é”™è¯¯** | å°† keyword å­—æ®µå®šä¹‰ä¸º text | æ— æ³•ç²¾ç¡®åŒ¹é…ï¼Œèšåˆä¸å‡†ç¡® | é‡æ–°å®šä¹‰ç±»å‹ï¼Œä½¿ç”¨å¤šå­—æ®µ |
| **åˆ†è¯ä¸å½“** | text å­—æ®µé»˜è®¤åˆ†è¯ | æŸ¥è¯¢ç»“æœä¸ç¬¦åˆé¢„æœŸ | ä½¿ç”¨ keyword ç±»å‹æˆ–è‡ªå®šä¹‰åˆ†è¯å™¨ |
| **å­—æ®µç¼ºå¤±** | æ–°å­—æ®µä½¿ç”¨åŠ¨æ€æ˜ å°„ | ç±»å‹å¯èƒ½ä¸åˆé€‚ | æ˜¾å¼å®šä¹‰ Mapping æˆ–ä½¿ç”¨ dynamic templates |
| **å­—æ®µè¿‡å¤š** | å†—ä½™å­—æ®µå¤ªå¤š | ç´¢å¼•æ€§èƒ½ä¸‹é™ã€ç£ç›˜å ç”¨é«˜ | ç¦ç”¨ `dynamic`ï¼Œæ˜¾å¼å®šä¹‰å¿…è¦å­—æ®µ |
| **_source å­˜å‚¨** | å­˜å‚¨å®Œæ•´æ–‡æ¡£ | ç£ç›˜å ç”¨é«˜ | ä½¿ç”¨ `_source.enabled: false` æˆ– `includes` |
| **åˆ†æå™¨ä¸åŒ¹é…** | ä¸­æ–‡åˆ†è¯å™¨é…ç½®é”™è¯¯ | ä¸­æ–‡æ— æ³•æ­£ç¡®æœç´¢ | ä½¿ç”¨ ik_max_word ç­‰ä¸­æ–‡åˆ†è¯å™¨ |

**ç¤ºä¾‹ 1ï¼štext vs keyword**

```json
// é—®é¢˜ï¼šlevel å®šä¹‰ä¸º text
{
  "mappings": {
    "properties": {
      "level": {
        "type": "text"
      }
    }
  }
}

// ç»“æœï¼š
// 1. æ— æ³•ç²¾ç¡®åŒ¹é… "INFO"ï¼ˆä¼šè¢«åˆ†è¯ï¼‰
// 2. èšåˆä¸å‡†ç¡®ï¼ˆ"INFO" å’Œ "INFO:" å¯èƒ½è¢«èšåˆåˆ°ä¸åŒæ¡¶ï¼‰

// è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ keyword
{
  "mappings": {
    "properties": {
      "level": {
        "type": "keyword"
      }
    }
  }
}
```

**ç¤ºä¾‹ 2ï¼šåŠ¨æ€æ˜ å°„é—®é¢˜**

```json
// é—®é¢˜ï¼šåŠ¨æ€æ˜ å°„å¯¼è‡´ "user_id" è¢«æ¨æ–­ä¸º text
PUT /logs/_doc/1
{
  "user_id": "user123"  // ES å¯èƒ½æ¨æ–­ä¸º text

// ç»“æœï¼šuser_id æ— æ³•ç²¾ç¡®åŒ¹é…

// è§£å†³æ–¹æ¡ˆï¼šæ˜¾å¼å®šä¹‰
{
  "mappings": {
    "properties": {
      "user_id": {
        "type": "keyword"
      }
    }
  }
}
```

---

### ç»ƒä¹  2 å‚è€ƒç­”æ¡ˆï¼šä¼˜åŒ–ä¸€ä¸ªæŸ¥è¯¢çš„æ€§èƒ½

**åŸå§‹æŸ¥è¯¢åˆ†æ**ï¼š

```json
{
  "query": {
    "bool": {
      "must": [
        { "match": { "message": "error" } },
        { "range": { "timestamp": { "gte": "now-1h" } } }
      ]
    }
  },
  "size": 100
}
```

**é—®é¢˜**ï¼š

1. `match` æŸ¥è¯¢ä¼šè®¡ç®—ç›¸å…³æ€§åˆ†ï¼ˆLucene Scoreï¼‰ï¼Œä½†ä¸éœ€è¦
2. è¿”å›æ‰€æœ‰å­—æ®µï¼ˆ`_source`ï¼‰
3. size è¿‡å¤§ï¼ˆ100ï¼‰

**ä¼˜åŒ–æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ filter context**

```json
{
  "query": {
    "bool": {
      "filter": [
        { "term": { "level": "ERROR" } },  // ä½¿ç”¨ç²¾ç¡®åŒ¹é…
        { "range": { "timestamp": { "gte": "now-1h" } } }
      ],
      "must": {
        "match": { "message": "error" } }
      }
    }
  },
  "size": 20
}
```

**ä¼˜åŒ–æ–¹æ¡ˆ 2ï¼šé™åˆ¶è¿”å›å­—æ®µ**

```json
{
  "_source": ["timestamp", "level", "hostname", "message"],
  "query": {
    "bool": {
      "filter": [
        { "term": { "level": "ERROR" } },
        { "range": { "timestamp": { "gte": "now-1h" } } }
      ]
    }
  },
  "size": 20
}
```

**ä¼˜åŒ–æ–¹æ¡ˆ 3ï¼šä½¿ç”¨ index pattern**

```bash
# åªæŸ¥è¯¢ç‰¹å®šæ—¶é—´çš„ç´¢å¼•
GET /logs-2026-01-23/_search
{
  "query": {
    "term": {
      "level": "ERROR"
    }
  }
}
```

**ä¼˜åŒ–æ–¹æ¡ˆ 4ï¼šä½¿ç”¨æŸ¥è¯¢ç¼“å­˜**

```json
{
  "query": {
    "bool": {
      "filter": [
        { "term": { "level": "ERROR" } }
      ]
    }
  },
  "request_cache": true
}
```

---

### ç»ƒä¹  3 å‚è€ƒç­”æ¡ˆï¼šè®¾è®¡æ—¥å¿—ç´¢å¼•çš„ Mapping

**æ—¥å¿—åˆ†æ**ï¼š

```json
{
  "timestamp": "2026-01-23T10:00:00.123Z",
  "level": "INFO",
  "logger": "com.example.app",
  "thread": "main",
  "message": "User admin logged in",
  "context": {
    "userId": "12345",
    "ipAddress": "192.168.1.10",
    "sessionId": "abc123"
  }
}
```

**Mapping è®¾è®¡**ï¼š

```json
{
  "properties": {
    // 1. timestamp - date ç±»å‹
    "timestamp": {
      "type": "date",
      "format": "strict_date_optional_time||epoch_millis"
    },
    
    // 2. level - keyword ç±»å‹ï¼ˆç”¨äºèšåˆï¼‰
    "level": {
      "type": "keyword"
    },
    
    // 3. logger - keyword ç±»å‹ï¼ˆç”¨äºåˆ†ç»„ï¼‰
    "logger": {
      "type": "keyword"
    },
    
    // 4. thread - keyword ç±»å‹ï¼ˆç”¨äºåˆ†æï¼‰
    "thread": {
      "type": "keyword"
    },
    
    // 5. message - text ç±»å‹ï¼ˆå…¨æ–‡æœç´¢ï¼‰
    "message": {
      "type": "text",
      "analyzer": "standard",
      "fields": {
        "keyword": {
          "type": "keyword",
          "ignore_above": 256
        }
      }
    },
    
    // 6. context - object ç±»å‹
    "context": {
      "properties": {
        "userId": {
          "type": "keyword"
        },
        "ipAddress": {
          "type": "ip"
        },
        "sessionId": {
          "type": "keyword"
        }
      }
    }
  }
}
```

**å®Œæ•´ç´¢å¼•åˆ›å»º**ï¼š

```bash
curl -X PUT "localhost:9200/app-logs-2026-01-23?pretty" -H 'Content-Type: application/json' -d'
{
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1
  },
  "mappings": {
    "properties": {
      "timestamp": {
        "type": "date",
        "format": "strict_date_optional_time||epoch_millis"
      },
      "level": {
        "type": "keyword"
      },
      "logger": {
        "type": "keyword"
      },
      "thread": {
        "type": "keyword"
      },
      "message": {
        "type": "text",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 256
          }
        }
      },
      "context": {
        "properties": {
          "userId": {
            "type": "keyword"
          },
          "ipAddress": {
            "type": "ip"
          },
          "sessionId": {
            "type": "keyword"
          }
        }
      }
    }
  }
}'
```

---

### ç»ƒä¹  4 å‚è€ƒç­”æ¡ˆï¼šè®¾è®¡ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç­–ç•¥

**ILM ç­–ç•¥**ï¼š

```json
PUT /_ilm/policy/logs_policy?pretty
{
  "policy": {
    "phases": {
      // 1. Hot é˜¶æ®µï¼ˆ0-7 å¤©ï¼‰
      "hot": {
        "actions": {
          "rollover": {
            "max_size": "50GB",
            "max_age": "7d"
          },
          "set_priority": {
            "priority": 100
          }
        }
      },
      
      // 2. Warm é˜¶æ®µï¼ˆ7-30 å¤©ï¼‰
      "warm": {
        "min_age": "7d",
        "actions": {
          "forcemerge": {
            "max_num_segments": 1
          },
          "shrink": {
            "number_of_shards": 1
          },
          "set_priority": {
            "priority": 50
          }
        }
      },
      
      // 3. Cold é˜¶æ®µï¼ˆ30-90 å¤©ï¼‰
      "cold": {
        "min_age": "30d",
        "actions": {
          "freeze": {},
          "set_priority": {
            "priority": 0
          }
        }
      },
      
      // 4. Delete é˜¶æ®µï¼ˆ> 90 å¤©ï¼‰
      "delete": {
        "min_age": "90d",
        "actions": {
          "delete": {}
        }
      }
    }
  }
}
```

**ç´¢å¼•æ¨¡æ¿åº”ç”¨ ILM**ï¼š

```json
PUT /_template/logs_template?pretty
{
  "index_patterns": ["logs-*"],
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1,
    "index.lifecycle.name": "logs_policy",
    "index.lifecycle.rollover_alias": "logs",
    "index.lifecycle.prefer_ilm": true
  },
  "mappings": {
    // Mapping å®šä¹‰
  }
}
```

**éªŒè¯ ILM ç­–ç•¥**ï¼š

```bash
# æŸ¥çœ‹æ‰€æœ‰ ILM ç­–ç•¥
curl -X GET "localhost:9200/_ilm/policy/logs_policy?pretty"

# æŸ¥çœ‹ç´¢å¼•çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€
curl -X GET "localhost:9200/logs-*/_ilm/explain?pretty"
```

---

## å­¦ä¹ æˆæœç¤ºä¾‹å¡«å†™ï¼ˆå¯ç…§æŠ„ï¼‰

> å¯å°†"ç¤ºä¾‹"å†…å®¹æ›¿æ¢ä¸ºä½ è‡ªå·±çš„æ—¶é—´ä¸æˆªå›¾æ–‡ä»¶åã€‚

---

### æˆªå›¾ä¸è¯æ®ï¼ˆç¤ºä¾‹ï¼‰

- ç´¢å¼•åˆ›å»ºï¼š`images/day031_index_created.png`
- Mapping å®šä¹‰ï¼š`images/day031_mapping.png`
- æŸ¥è¯¢ç»“æœï¼š`images/day031_query_result.png`
- èšåˆç»“æœï¼š`images/day031_aggregation.png`
- Kibana å¯è§†åŒ–ï¼š`images/day031_kibana_viz.png`
- ä»ªè¡¨ç›˜ï¼š`images/day031_dashboard.png`

---

### å…³é”®å‘½ä»¤ä¸è¾“å‡ºï¼ˆç¤ºä¾‹ï¼‰

**åˆ›å»ºç´¢å¼•**ï¼š

```bash
$ curl -X PUT "localhost:9200/logs-2026-01-23?pretty"
{
  "acknowledged" : true,
  "shards_acknowledged" : 3
}
```

**æŸ¥è¯¢ç»“æœ**ï¼š

```json
{
  "took" : 2,
  "hits" : {
    "total" : 5
  }
}
```

---

### ç»“è®ºä¸åæ€ï¼ˆç¤ºä¾‹ï¼‰

**æˆ‘ä»Šå¤©ææ¸…æ¥šäº†**ï¼š

- Elasticsearch çš„æ ¸å¿ƒæ¦‚å¿µ
- Mapping çš„ä½œç”¨å’Œå­—æ®µç±»å‹é€‰æ‹©
- åŸºç¡€æŸ¥è¯¢å’Œèšåˆçš„ä½¿ç”¨æ–¹æ³•
- Kibana å¯è§†åŒ–çš„åˆ›å»º

**æˆ‘å·®ç‚¹ææ··çš„æ˜¯**ï¼š

- text å’Œ keyword çš„åŒºåˆ«
- query å’Œ filter context çš„åŒºåˆ«

**æ˜å¤©æˆ‘è¦ç»§ç»­è¡¥çš„æ˜¯**ï¼š

- æ—¥å¿—å¯è§†åŒ–å’Œå‘Šè­¦ç­–ç•¥
- æ—¥å¿—è§„èŒƒå’Œå­—æ®µç»Ÿä¸€

**æœ¬æ¬¡å­¦ä¹ è€—æ—¶**ï¼šçº¦ 4 å°æ—¶

**æŒæ¡ç¨‹åº¦è‡ªè¯„**ï¼š

- [x] ğŸ˜ƒ å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡å¹¶ç†è§£åŸç†
