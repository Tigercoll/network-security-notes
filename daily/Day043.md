---
title: Day043：网络防护 - 防火墙类型与规则设计
tags:
  - 网络
  - 安全
  - 学习计划
categories:
  - 网络安全
abbrlink: d5f875d1
date: 2026-02-05 00:00:00
updated: 2026-02-05 00:00:00
---

# Day043：网络防护 - 防火墙类型与规则设计

- 日期：2026-02-05
- 周次：第7周

## 学习目标

今天你将掌握防火墙的核心知识：

- **理解防火墙类型**：包过滤、状态检测、应用层防火墙的区别
- **掌握规则设计**：最小权限原则、规则顺序、默认策略
- **实现访问控制**：编写入站/出站规则并验证
- **配置审计日志**：记录命中与阻断的日志

---

<!--more-->

## 学习内容

### 1️⃣ 防火墙类型

#### 1.1 包过滤防火墙

```mermaid
┌─────────────────────────────────────────┐
│           包过滤防火墙                    │
├─────────────────────────────────────────┤
│ 检查每个数据包的：                        │
│ - 源/目的 IP 地址                        │
│ - 源/目的端口                            │
│ - 协议类型（TCP/UDP/ICMP）               │
│ - 方向（入站/出站）                       │
└─────────────────────────────────────────┘
```

| 特性 | 说明 |
|------|------|
| 过滤层次 | 网络层（第3层） |
| 速度 | 最快 |
| 资源消耗 | 最低 |
| 灵活性 | 低（仅基于包头） |
| 典型产品 | iptables/nftables（基础模式） |

```bash
# iptables 包过滤示例
# 允许已建立的连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 允许 SSH 入站
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# 允许 HTTP/HTTPS 入站
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# 允许来自内网的流量
iptables -A INPUT -s 192.168.0.0/16 -j ACCEPT

# 默认拒绝所有入站
iptables -P INPUT DROP
```

#### 1.2 状态检测防火墙

```mermaid
┌─────────────────────────────────────────┐
│          状态检测防火墙                   │
├─────────────────────────────────────────┤
│ 跟踪连接状态：                           │
│ - NEW（新建连接）                        │
│ - ESTABLISHED（已建立）                  │
│ - RELATED（相关连接）                    │
│ - INVALID（无效）                        │
└─────────────────────────────────────────┘
```

```bash
# iptables 状态检测
# 允许 NEW 状态的 SSH 连接
iptables -A INPUT -p tcp --dport 22 -m state --state NEW -j ACCEPT

# 允许已建立的连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 拒绝无效状态
iptables -A INPUT -m state --state INVALID -j DROP
```

| 特性 | 说明 |
|------|------|
| 过滤层次 | 网络层+传输层 |
| 速度 | 快 |
| 状态跟踪 | 支持 |
| 灵活性 | 中 |
| 典型产品 | Linux iptables、Windows Firewall |

#### 1.3 应用层防火墙（下一代防火墙）

```mermaid
┌─────────────────────────────────────────┐
│         应用层/下一代防火墙               │
├─────────────────────────────────────────┤
│ 深度包检测（DPI）：                      │
│ - 应用协议识别（HTTP/HTTPS/FTP/SMTP）    │
│ - 恶意内容检测                           │
│ - 用户身份验证                           │
│ - SSL/TLS 解密                           │
│ - IPS/IDS 功能                           │
└─────────────────────────────────────────┘
```

| 特性 | 说明 |
|------|------|
| 过滤层次 | 应用层（第7层） |
| 速度 | 较慢 |
| 功能 | 最丰富 |
| 灵活性 | 高 |
| 典型产品 | Palo Alto, Fortinet, Cloudflare WAF |

---

### 2️⃣ 规则设计最佳实践

#### 2.1 最小权限原则

```mermaid
┌─────────────────────────────────────────────────────┐
│              防火墙规则设计原则                       │
├─────────────────────────────────────────────────────┤
│ 1. 默认拒绝（Deny by Default）                       │
│ 2. 白名单优于黑名单                                  │
│ 3. 规则从具体到一般                                  │
│ 4. 定期审计和清理                                    │
│ 5. 记录所有阻断操作                                  │
└─────────────────────────────────────────────────────┘
```

#### 2.2 规则优先级

```
规则处理顺序：按配置顺序，从上到下匹配

示例：
┌────────────────────────────────────────────────────┐
│ #1 允许 SSH（具体规则，优先匹配）                    │
│ -A INPUT -p tcp --dport 22 -j ACCEPT              │
│                                                    │
│ #2 允许 HTTP（具体规则）                            │
│ -A INPUT -p tcp --dport 80 -j ACCEPT              │
│                                                    │
│ #3 允许已建立连接（状态规则）                        │
│ -A INPUT -m state --state ESTABLISHED -j ACCEPT   │
│                                                    │
│ #4 默认拒绝（兜底规则）                              │
│ -P INPUT DROP                                      │
└────────────────────────────────────────────────────┘
```

#### 2.3 企业防火墙规则示例

```bash
#!/bin/bash
# 企业防火墙规则脚本

# 清空现有规则
iptables -F
iptables -X
iptables -t nat -F

# 设置默认策略
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# 允许回环接口
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# 允许已建立连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# ==================== 入站规则 ====================

# SSH（仅限管理 IP）
ALLOWED_ADMIN_IP="10.0.0.100"
iptables -A INPUT -p tcp -s $ALLOWED_ADMIN_IP --dport 22 -j ACCEPT

# HTTP/HTTPS（Web 服务器）
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# ICMP（仅限内部网络）
iptables -A INPUT -s 10.0.0.0/8 -p icmp --icmp-type echo-request -j ACCEPT

# 拒绝特定端口扫描
iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP
iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP

# ==================== 出站规则 ====================

# 允许 DNS
iptables -A OUTPUT -p udp --dport 53 -j ACCEPT
iptables -A OUTPUT -p tcp --dport 53 -j ACCEPT

# 允许 NTP（时间同步）
iptables -A OUTPUT -p udp --dport 123 -j ACCEPT

# 允许 HTTP/HTTPS（外出）
iptables -A OUTPUT -p tcp --dport 80 -j ACCEPT
iptables -A OUTPUT -p tcp --dport 443 -j ACCEPT

# 记录被拒绝的包
iptables -A INPUT -j LOG --log-prefix "IPT_DROP: " --log-level 4

echo "防火墙规则已应用"
```

---

### 3️⃣ nftables（新一代 Linux 防火墙）

```bash
# nftables 规则集示例
#!/usr/bin/env nft -f

# 清空规则
flush ruleset

# 定义表
table inet filter {
    # 定义链
    chain input {
        type filter hook input priority 0;
        
        # 允许回环
        iif lo accept
        
        # 允许已建立连接
        ct state established,related accept
        
        # SSH（限制来源）
        ip saddr 10.0.0.0/8 tcp dport 22 accept
        
        # Web 服务
        tcp dport {80, 443} accept
        
        # 丢弃无效连接
        ct state invalid drop
        
        # 默认拒绝
        reject
    }
    
    chain forward {
        type filter hook forward priority 0;
        # 转发规则（如果需要）
        drop
    }
    
    chain output {
        type filter hook output priority 0;
        # 允许所有出站
        accept
    }
}
```

---

### 4️⃣ Windows 防火墙配置

```powershell
# Windows 防火墙配置示例

# 1. 启用防火墙
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True

# 2. 设置默认策略（默认阻止入站，允许出站）
Set-NetFirewallProfile -Profile Domain -DefaultInboundAction Block
Set-NetFirewallProfile -Profile Private -DefaultInboundAction Block
Set-NetFirewallProfile -Profile Public -DefaultInboundAction Block

# 3. 创建规则：允许 SSH
New-NetFirewallRule -DisplayName "SSH" -Direction Inbound -Protocol TCP `
    -LocalPort 22 -Action Allow -Enabled True

# 4. 创建规则：允许 HTTP/HTTPS
New-NetFirewallRule -DisplayName "HTTP" -Direction Inbound -Protocol TCP `
    -LocalPort 80 -Action Allow -Enabled True
New-NetFirewallRule -DisplayName "HTTPS" -Direction Inbound -Protocol TCP `
    -LocalPort 443 -Action Allow -Enabled True

# 5. 创建规则：禁止特定 IP
New-NetFirewallRule -DisplayName "Block IP 10.0.0.50" -Direction Inbound `
    -RemoteAddress 10.0.0.50 -Action Block

# 6. 查看规则
Get-NetFirewallRule | Select-Object DisplayName, Enabled, Action

# 7. 查看日志位置
# 默认日志位置：C:\Windows\System32\LogFiles\Firewall\pfirewall.log
```

---

## 实践任务（合法授权范围内）

### 任务 1（必做）：配置 Linux 防火墙

**目标**：为实验环境配置安全的防火墙规则。

**步骤**：

```bash
# 1. 查看当前规则
sudo iptables -L -n -v

# 2. 创建防火墙脚本
cat > ~/firewall_setup.sh << 'EOF'
#!/bin/bash

# 清空现有规则
iptables -F
iptables -X
iptables -t nat -F

# 设置默认策略
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# 允许回环
iptables -A INPUT -i lo -j ACCEPT

# 允许已建立连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# SSH（从任意地址）
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# HTTP/HTTPS
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# 记录被拒绝的包
iptables -A INPUT -j LOG --log-prefix "IPT_DROP: " --log-level 4

echo "防火墙规则已配置"
EOF

chmod +x ~/firewall_setup.sh

# 3. 执行脚本
sudo ~/firewall_setup.sh

# 4. 验证规则
sudo iptables -L -n

# 5. 保存规则（Debian/Ubuntu）
sudo apt install iptables-persistent
sudo netfilter-persistent save

# 6. 测试连通性
# 从另一台机器测试 SSH 连接
# ssh user@your_server_ip
```

---

### 任务 2（必做）：验证防火墙规则

**目标**：测试防火墙规则是否生效。

**步骤**：

```bash
# 1. 测试允许的端口
nc -zv localhost 22
nc -zv localhost 80

# 2. 测试被拒绝的端口（如 MySQL 3306）
nc -zv localhost 3306

# 3. 查看日志
sudo tail -f /var/log/kern.log | grep "IPT_DROP"

# 4. 从外部测试
# 在另一台机器上：
nc -zv your_server_ip 22    # 应该成功
nc -zv your_server_ip 3306  # 应该失败（Connection refused）
```

---

### 任务 3（进阶）：配置 nftables

**目标**：使用新一代 nftables 配置防火墙。

```bash
# 1. 检查 nftables 是否可用
sudo nft -v

# 2. 创建规则集
cat > /etc/nftables.conf << 'EOF'
#!/usr/bin/env nft -f

# 定义表
table inet filter {
    chain input {
        type filter hook input priority 0;
        
        # 允许回环
        iif lo accept
        
        # 允许已建立连接
        ct state established,related accept
        
        # SSH
        tcp dport 22 accept
        
        # Web 服务
        tcp dport {80, 443} accept
        
        # 丢弃无效连接
        ct state invalid drop
        
        # 默认拒绝
        reject
    }
}
EOF

# 3. 应用规则
sudo nft -f /etc/nftables.conf

# 4. 查看规则
sudo nft list ruleset

# 5. 启用并启动服务
sudo systemctl enable nftables
sudo systemctl start nftables
```

---

## 巩固练习（题与复盘）

### 练习 1：默认拒绝策略的好处是什么？

**答案**：

| 好处 | 说明 |
|------|------|
| **安全性** | 只有明确允许的流量才能通过 |
| **最小暴露** | 减少攻击面 |
| **可控性** | 所有流量都被记录和审计 |
| **合规性** | 满足等保等合规要求 |

### 练习 2：为一个服务设计白名单规则

**任务**：为 Nginx Web 服务器设计防火墙规则。

**答案**：

```bash
# Nginx 服务器防火墙规则

# 清空规则
iptables -F

# 默认策略
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# 允许回环
iptables -A INPUT -i lo -j ACCEPT

# 允许已建立连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# ==================== 允许的入站 ====================

# SSH（仅限管理员 IP）
iptables -A INPUT -p tcp -s 10.0.0.0/24 --dport 22 -j ACCEPT

# HTTP
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

# HTTPS
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# ICMP（限制频率和来源）
iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/second --limit-burst 4 -j ACCEPT

# ==================== 阻断规则 ====================

# 防止端口扫描
iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP
iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP

# ==================== 日志 ====================

iptables -A INPUT -j LOG --log-prefix "DROP: " --log-level 4

echo "Nginx 防火墙规则已配置"
```

---

## 评估标准（达成判定）

- ✅ 理解包过滤、状态检测、应用层防火墙的区别
- ✅ 能编写符合最小权限原则的防火墙规则
- ✅ 规则生效并有审计记录
- ✅ 说明默认拒绝策略的好处

---

## 学习成果达成情况（由学习者填写）

### 截图与证据

- [ ] iptables 规则列表截图
- [ ] 连接测试结果截图
- [ ] 防火墙日志截图

### 关键命令与输出

**规则列表**：
```bash
$ sudo iptables -L -n
Chain INPUT (policy DROP)
target     prot opt source               destination
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED
ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:22
ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:80
ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:443
LOG        all  --  0.0.0.0/0            0.0.0.0/0            LOG flags 0 level 4 prefix "DROP: "
```

**测试结果**：
```bash
# 允许的端口
$ nc -zv localhost 22
Connection to localhost 22 port [tcp/ssh] succeeded!

# 被拒绝的端口
$ nc -zv localhost 3306
nc: connect to localhost port 3306 (tcp): Connection refused
```

### 结论与反思

**我今天搞清楚了**：

- 防火墙的三种类型：包过滤、状态检测、应用层
- 最小权限原则：默认拒绝，明确允许
- 规则顺序的重要性：具体规则在前，通用规则在后

**我差点搞混的是**：

- iptables 和 nftables 的语法差异
- 状态检测中 NEW 和 ESTABLISHED 的区别

**明天我要继续补的是**：

- IDS/IPS 原理与部署
- 网络分段与访问控制

**本次学习耗时**：约 2.5 小时

**掌握程度自评**：

- [ ] 😕 理解了基本概念
- [ ] 🙂 完成了基础任务
- [ ] 😃 完成了所有任务并理解原理
- [ ] 🤩 配置了完整的 nftables 规则集

---
