# Day005：网络与协议基础 - DNS 工作流

- 日期：2025-12-29
- 周次：第 1 周

## 学习目标

- 理解 DNS 的“分层命名 + 分布式数据库”设计，以及一次解析从本机到权威服务器的关键环节
- 熟悉常见记录类型：A/AAAA/CNAME/MX/TXT/NS/SOA
- 能在 Windows 上用 `nslookup` / `Resolve-DnsName` 做查询，并能用 Wireshark 抓包解释一次完整的 DNS 查询与响应
- 理解缓存与 TTL、递归与迭代、失败场景（NXDOMAIN/SERVFAIL/超时）含义

## 学习内容

### 1️⃣ DNS 在“上网”里扮演什么角色

DNS（Domain Name System）是把“人类可读的域名”映射为“机器可路由的 IP 地址”的系统。

你每天打开网页时，典型顺序是：

1. **DNS 解析**：`www.example.com` → IP
2. **建立连接**：对该 IP 发起 TCP/TLS/HTTP
3. **应用层交互**：请求页面/接口

因此，DNS 的问题会表现为：

- 浏览器提示“找不到服务器 / 无法解析域名”（解析失败）
- Ping 不通域名，但 Ping IP 可以（DNS 问题更可能）

### 2️⃣ 递归解析 vs 迭代解析（非常关键）

把角色分清楚：

- **客户端（Stub Resolver）**：你电脑上的解析器（由系统/浏览器调用）
- **递归解析器（Recursive Resolver）**：通常是你配置的 DNS 服务器（运营商/路由器/公司/公共 DNS）
- **根服务器（Root）/ 顶级域（TLD）/ 权威服务器（Authoritative）**：负责逐级指引和最终回答

**客户端通常发起的是“递归查询”**：

- “请你给我最终答案，不要让我自己去问根/TLD/权威。”

**递归解析器对外通常做“迭代查询”**：

- 先问根：“.com 的权威在哪？”
- 再问 TLD："example.com 的权威在哪？"
- 再问权威："www.example.com 的 A/AAAA 是多少？"

你在 Wireshark 里抓包时，很多时候只能看到 **客户端 ↔ 递归解析器** 这一跳。

### 3️⃣ DNS 报文与字段：抓包时看什么

DNS 既可以走 UDP（默认 53 端口）也可以走 TCP：

- **UDP 53**：大多数查询（快）
- **TCP 53**：响应太大需要截断/重试（TC=1），或进行区域传送（AXFR，通常只允许内部）

在 Wireshark 里建议重点看：

- **Transaction ID**：查询与响应的“配对 ID”
- **Flags**：
  - `QR`（Query/Response）
  - `RD`（Recursion Desired，客户端希望递归）
  - `RA`（Recursion Available，服务器支持递归）
  - `RCODE`（返回码：NOERROR/NXDOMAIN/SERVFAIL…）
- **Questions**：查询的域名 + 类型（A/AAAA…）
- **Answers**：返回记录（含 TTL）
- **Authority / Additional**：权威信息、附加信息（比如 NS + glue 记录）

### 4️⃣ 常见记录类型速查

| 类型  | 作用               | 你会在什么场景看到                           |
| ----- | ------------------ | -------------------------------------------- |
| A     | 域名 → IPv4        | most common                                  |
| AAAA  | 域名 → IPv6        | IPv6 环境                                    |
| CNAME | 别名 → 正式名      | CDN、统一入口（如 `www` 指向 `xxx.cdn.net`） |
| MX    | 邮件服务器         | 邮件系统                                     |
| TXT   | 文本记录           | SPF/DKIM/站点验证/一些验证 token             |
| NS    | 指定某域的权威 DNS | 委派关系                                     |
| SOA   | 区域起始授权信息   | 区域版本、刷新时间等                         |

> 记忆要点：**CNAME 不能和同名的 A/AAAA 同时存在**（同一名字要么别名，要么地址）。

### 5️⃣ 缓存与 TTL：为什么“改了解析不生效”

DNS 会大量缓存：

- 你的电脑可能缓存
- 浏览器/应用可能缓存
- 递归解析器一定会缓存

每条记录都带 **TTL（Time To Live）**，表示“缓存能保留多久”。

因此：

- 权威服务器更新记录后，旧缓存需要等待 TTL 过期才会刷新
- 排查时常用方式：换一个递归解析器、清本机缓存、或者直接查询权威

## 实践任务（合法授权范围内）

> 目标：在 Windows 上完成一次 DNS A/AAAA/CNAME/TXT 查询，并用 Wireshark 抓包解释一条请求与响应。

### 推荐练习域名清单（A / AAAA / TXT）

> 说明：不同网络/地区/CDN 策略会导致结果不同；如果某域名查不到 AAAA 属于正常现象（不一定是你操作错）。

**A（IPv4）常见稳定样本：**

- `example.com`
- `www.cloudflare.com`
- `www.microsoft.com`
- `www.bing.com`

**AAAA（IPv6）常见样本：**

- `ipv6.google.com`
- `www.cloudflare.com`
- `one.one.one.one`
- `www.facebook.com`

**TXT（文本记录）常见样本（常含 SPF/验证信息）：**

- `google.com`
- `microsoft.com`
- `cloudflare.com`
- `github.com`

**一键复制的 PowerShell 查询示例：**

- `Resolve-DnsName example.com -Type A`
- `Resolve-DnsName ipv6.google.com -Type AAAA`
- `Resolve-DnsName google.com -Type TXT`

### 任务 1：用 `nslookup` 做基础查询

在 PowerShell 里执行（示例域名可换成你常用网站）：

- 查询 A 记录：
  - `nslookup www.bing.com`
- 指定类型查询：
  - `nslookup -type=AAAA www.bing.com`
  - `nslookup -type=CNAME www.bing.com`
  - `nslookup -type=TXT microsoft.com`

记录：

- Server 是谁（你正在使用哪个递归 DNS）
- Name / Address / canonical name（CNAME）结果

### 任务 2：用 `Resolve-DnsName`（更强，推荐）

PowerShell 示例：

- `Resolve-DnsName www.bing.com`
- `Resolve-DnsName www.bing.com -Type A`
- `Resolve-DnsName www.bing.com -Type AAAA`
- `Resolve-DnsName microsoft.com -Type TXT`

指定某个 DNS 服务器（例如公共 DNS，只用于学习测试）：

- `Resolve-DnsName www.bing.com -Type A -Server 1.1.1.1`

你可以对比不同递归解析器返回的结果是否一致、TTL 是否不同。

### 任务 3：清理本机 DNS 缓存并复查

执行：

- `ipconfig /displaydns`（查看缓存）
- `ipconfig /flushdns`（清空缓存）

再执行一遍 `Resolve-DnsName`，观察输出是否变化。

### 任务 4：Wireshark 抓包并解释一次查询

1. 打开 Wireshark，选择你正在联网的网卡（Wi-Fi/以太网）
2. 设置显示过滤器：
   - `dns`
   - 或：`udp.port == 53 || tcp.port == 53`
3. 开始抓包
4. 另开一个 PowerShell，执行：
   - `Resolve-DnsName www.bing.com -Type A`
5. 回到 Wireshark，找到对应的 DNS Query/Response

写出你的观察（建议按下面模板）：

- Query：查询名是什么？类型是什么（A/AAAA/TXT）？
- Flags：RD/RA 是否为 1？RCODE 是什么？
- Answer：返回了几条记录？每条 TTL 是多少？
- UDP 还是 TCP？如果是 TCP，是什么原因（是否看到 TC=1）？

## 常见坑与排查思路

### 1) NXDOMAIN / SERVFAIL / 超时分别意味着什么

- **NXDOMAIN**：权威 DNS 明确表示“这个名字不存在”
- **SERVFAIL**：递归解析器无法完成解析（上游异常、DNSSEC 校验问题、策略阻断等）
- **超时**：网络到 DNS 服务器不可达、防火墙拦截、或服务器负载/丢包

### 2) 为什么同一个域名在不同网络解析结果不同

常见原因：

- CDN 按地域/运营商调度
- 分流策略（EDNS Client Subnet 影响）
- 公司内网 DNS 做了内部解析（Split-horizon DNS）

### 3) 安全视角：DNS 也会被攻击/利用

本日先建立概念（后续会深入）：

- **DNS 欺骗/投毒**：让你解析到攻击者的 IP
- **重绑定（DNS Rebinding）**：利用浏览器同源策略边界进行绕过（与内网访问相关）
- **隧道（DNS Tunnel）**：把数据编码进子域名/响应里，实现隐蔽通信

## 巩固练习（题与复盘）

1. **CNAME 与 A 记录的关系是什么？**

- 用一句话解释：CNAME 是“别名”，最终仍要落到 A/AAAA
- 思考：为什么同名不能同时存在 CNAME 和 A？

2. **解释一次失败解析的可能原因**（至少写 3 条）

建议从链路分层去想：

- 本机缓存/hosts 覆盖
- 到递归 DNS 的网络不可达
- 递归 DNS 自身故障/策略拦截
- 权威 DNS 不可达或配置错误
- DNSSEC 校验失败（未来会讲）

3. 加分题：

- 在 Wireshark 里找到一次返回多条 A 记录的响应，解释这通常用于什么（负载均衡/高可用）

## 评估标准（达成判定）

- 能用自己的话画出（或描述）一次解析链路：本机 → 递归 → 根 → TLD → 权威
- 能在 Wireshark 里指出一条 DNS 报文的 Query/Response，并说清楚 Query 类型 + Answer + TTL
- 能说出 TTL 的作用，以及为什么会导致“解析修改延迟生效”

## 学习成果达成情况（由学习者填写）

- 截图与证据：
  - Wireshark 抓包截图（Query + Response 各 1 张）
  - `Resolve-DnsName` 输出截图或复制粘贴
- 关键命令与输出：
  - `Resolve-DnsName <domain> -Type A/AAAA/TXT`
  - `ipconfig /displaydns`（可选）
- 结论与反思：
  - 今天你最清楚的一个点：
  - 仍然模糊的一个点（明天回看/补充）：
