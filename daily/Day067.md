---
title: Day067ï¼šäº‘ä¸å®¹å™¨å®‰å…¨ - K8s å…¥é—¨ï¼šRBAC ä¸ç½‘ç»œç­–ç•¥
tags:
  - ç½‘ç»œ
  - å®‰å…¨
  - å­¦ä¹ è®¡åˆ’
categories:
  - ç½‘ç»œå®‰å…¨
abbrlink: a0090632
date: 2026-03-01 00:00:00
updated: 2026-03-01 00:00:00
---

# Day067ï¼šäº‘ä¸å®¹å™¨å®‰å…¨ - K8s å…¥é—¨ï¼šRBAC ä¸ç½‘ç»œç­–ç•¥

- æ—¥æœŸï¼š2026-03-01
- å‘¨æ¬¡ï¼šç¬¬10å‘¨

## å­¦ä¹ ç›®æ ‡

ä»Šå¤©ä½ å°†æŒæ¡ Kubernetes å®‰å…¨çš„åŸºç¡€çŸ¥è¯†ï¼š

- **ç†è§£ RBAC æœºåˆ¶**ï¼šæŒæ¡è§’è‰²ã€è§’è‰²ç»‘å®šã€é›†ç¾¤è§’è‰²çš„ä½¿ç”¨
- **å®æ–½æœ€å°æƒé™**ï¼šè®¾è®¡å®‰å…¨çš„æƒé™ç­–ç•¥
- **é…ç½®ç½‘ç»œç­–ç•¥**ï¼šå®ç° Pod é—´çš„ç½‘ç»œéš”ç¦»
- **å®¡è®¡ä¸ç›‘æ§**ï¼šè®°å½•å’Œåˆ†æå®‰å…¨ç›¸å…³äº‹ä»¶
- **é˜²å¾¡æ·±åº¦**ï¼šæ„å»ºå¤šå±‚å®‰å…¨é˜²æŠ¤ä½“ç³»

---

<!--more-->

## å­¦ä¹ å†…å®¹

### 1ï¸âƒ£ Kubernetes RBAC

#### 1.1 RBAC åŸºç¡€

```python
#!/usr/bin/env python3
"""
Kubernetes RBAC å®‰å…¨é…ç½®
"""
from __future__ import annotations
from dataclasses import dataclass
from typing import Optional, list


@dataclass
class KubernetesResource:
    """Kubernetes èµ„æº"""
    api_group: str
    resource: str
    verbs: list[str]


@dataclass
class RoleConfig:
    """è§’è‰²é…ç½®"""
    role_name: str
    namespace: str
    resources: list[KubernetesResource]
    rules_summary: str


@dataclass
class RoleBindingConfig:
    """è§’è‰²ç»‘å®šé…ç½®"""
    binding_name: str
    namespace: str
    role_ref_kind: str  # Role, ClusterRole
    role_ref_name: str
    subjects: list[dict]


class KubernetesRBACManager:
    """Kubernetes RBAC ç®¡ç†å™¨"""
    
    def __init__(self):
        self.roles: list[RoleConfig] = []
        self.bindings: list[RoleBindingConfig] = []
        
    def create_pod_reader_role(self, namespace: str = "default") -> RoleConfig:
        """åˆ›å»º Pod è¯»å–è§’è‰²"""
        role = RoleConfig(
            role_name="pod-reader",
            namespace=namespace,
            resources=[
                KubernetesResource(
                    api_group="",
                    resource="pods",
                    verbs=["get", "list", "watch"]
                ),
                KubernetesResource(
                    api_group="",
                    resource="pods/log",
                    verbs=["get", "list"]
                ),
                KubernetesResource(
                    api_group="",
                    resource="pods/status",
                    verbs=["get"]
                )
            ],
            rules_summary="å…è®¸è¯»å– Pod ä¿¡æ¯å’Œæ—¥å¿—"
        )
        
        self.roles.append(role)
        return role
    
    def create_developer_role(self, namespace: str = "default") -> RoleConfig:
        """åˆ›å»ºå¼€å‘è€…è§’è‰²"""
        role = RoleConfig(
            role_name="developer",
            namespace=namespace,
            resources=[
                # Pods
                KubernetesResource(
                    api_group="",
                    resource="pods",
                    verbs=["get", "list", "watch", "create", "update", "delete"]
                ),
                # Deployments
                KubernetesResource(
                    api_group="apps",
                    resource="deployments",
                    verbs=["get", "list", "watch", "create", "update", "patch", "delete"]
                ),
                # Services
                KubernetesResource(
                    api_group="",
                    resource="services",
                    verbs=["get", "list", "watch", "create", "update", "patch", "delete"]
                ),
                # ConfigMaps
                KubernetesResource(
                    api_group="",
                    resource="configmaps",
                    verbs=["get", "list", "watch", "create", "update", "patch", "delete"]
                ),
                # Secrets
                KubernetesResource(
                    api_group="",
                    resource="secrets",
                    verbs=["get", "list"]  # åªè¯»ï¼Œé˜²æ­¢æ•æ„Ÿä¿¡æ¯æ³„éœ²
                ),
                # Ingresses
                KubernetesResource(
                    api_group="networking.k8s.io",
                    resource="ingresses",
                    verbs=["get", "list", "watch", "create", "update", "patch", "delete"]
                )
            ],
            rules_summary="å…è®¸å¼€å‘è€…ç®¡ç†åº”ç”¨èµ„æºï¼Œé™åˆ¶ Secrets åªè¯»"
        )
        
        self.roles.append(role)
        return role
    
    def create_admin_role(self, namespace: str = "default") -> RoleConfig:
        """åˆ›å»ºå‘½åç©ºé—´ç®¡ç†å‘˜è§’è‰²"""
        role = RoleConfig(
            role_name="namespace-admin",
            namespace=namespace,
            resources=[
                KubernetesResource(
                    api_group="*",
                    resource="*",
                    verbs=["get", "list", "watch", "create", "update", "patch", "delete"]
                )
            ],
            rules_summary="å…è®¸å®Œå…¨ç®¡ç†å‘½åç©ºé—´å†…èµ„æºï¼ˆé™¤ç‰¹æ®Šèµ„æºå¤–ï¼‰"
        )
        
        self.roles.append(role)
        return role
    
    def create_read_only_role(self, namespace: str = None) -> RoleConfig:
        """åˆ›å»ºåªè¯»è§’è‰²ï¼ˆé›†ç¾¤çº§åˆ«ï¼‰"""
        role = RoleConfig(
            role_name="cluster-readonly",
            namespace="",  # é›†ç¾¤çº§åˆ«
            resources=[
                KubernetesResource(
                    api_group="",
                    resource="pods",
                    verbs=["get", "list", "watch"]
                ),
                KubernetesResource(
                    api_group="",
                    resource="services",
                    verbs=["get", "list", "watch"]
                ),
                KubernetesResource(
                    api_group="apps",
                    resource="deployments",
                    verbs=["get", "list", "watch"]
                ),
                KubernetesResource(
                    api_group="apps",
                    resource="statefulsets",
                    verbs=["get", "list", "watch"]
                ),
                KubernetesResource(
                    api_group="networking.k8s.io",
                    resource="ingresses",
                    verbs=["get", "list", "watch"]
                )
            ],
            rules_summary="å…è®¸åªè¯»è®¿é—®é›†ç¾¤èµ„æº"
        )
        
        self.roles.append(role)
        return role
    
    def create_role_binding(self, binding_name: str, namespace: str, 
                           role_name: str, subjects: list[dict]) -> RoleBindingConfig:
        """åˆ›å»ºè§’è‰²ç»‘å®š"""
        binding = RoleBindingConfig(
            binding_name=binding_name,
            namespace=namespace,
            role_ref_kind="Role",
            role_ref_name=role_name,
            subjects=subjects
        )
        
        self.bindings.append(binding)
        return binding
    
    def create_cluster_role_binding(self, binding_name: str, 
                                   cluster_role_name: str, subjects: list[dict]) -> dict:
        """åˆ›å»ºé›†ç¾¤è§’è‰²ç»‘å®š"""
        binding = {
            "binding_name": binding_name,
            "role_ref_kind": "ClusterRole",
            "role_ref_name": cluster_role_name,
            "subjects": subjects
        }
        
        self.bindings.append(RoleBindingConfig(
            binding_name=binding_name,
            namespace="",  # é›†ç¾¤çº§åˆ«
            role_ref_kind="ClusterRole",
            role_ref_name=cluster_role_name,
            subjects=subjects
        ))
        
        return binding
    
    def generate_yaml_manifests(self) -> str:
        """ç”Ÿæˆ YAML æ¸…å•"""
        manifests = """
# Kubernetes RBAC é…ç½®æ¸…å•

---

# 1. Pod è¯»å–è§’è‰²
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pod-reader
  namespace: default
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get", "list"]

---

# 2. Pod è¯»å–è§’è‰²ç»‘å®š
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pod-reader-binding
  namespace: default
subjects:
- kind: User
  name: jane.doe
  apiGroup: rbac.authorization.k8s.io
- kind: Group
  name: developers
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: pod-reader
  apiGroup: rbac.authorization.k8s.io

---

# 3. å¼€å‘è€…è§’è‰²
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: developer
  namespace: default
rules:
- apiGroups: [""]
  resources: ["pods", "services", "configmaps"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list"]  # åªè¯»ï¼Œé˜²æ­¢æ•æ„Ÿä¿¡æ¯æ³„éœ²

---

# 4. å‘½åç©ºé—´ç®¡ç†å‘˜è§’è‰²
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: namespace-admin
  namespace: default
rules:
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

---

# 5. åªè¯»é›†ç¾¤è§’è‰²
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cluster-readonly
rules:
- apiGroups: [""]
  resources: ["pods", "services", "configmaps"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets", "daemonsets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses", "networkpolicies"]
  verbs: ["get", "list", "watch"]

---

# 6. ç³»ç»Ÿåªè¯»è§’è‰²ï¼ˆèšåˆåˆ°åªè¯»ï¼‰
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: custom-readonly
  labels:
    rbac.authorization.k8s.io/aggregate-to-view: "true"
rules: []
"""
        return manifests
    
    def generate_rbac_audit_report(self) -> str:
        """ç”Ÿæˆ RBAC å®¡è®¡æŠ¥å‘Š"""
        report = "# Kubernetes RBAC å®¡è®¡æŠ¥å‘Š\n\n"
        
        report += "## 1. è§’è‰²é…ç½®\n\n"
        report += "| è§’è‰²åç§° | å‘½åç©ºé—´ | èµ„æºæ•° | æè¿° |\n"
        report += "|----------|----------|--------|------|\n"
        for role in self.roles:
            report += f"| {role.role_name} | {role.namespace or 'é›†ç¾¤çº§åˆ«'} | {len(role.resources)} | {role.rules_summary} |\n"
        
        report += "\n## 2. è§’è‰²ç»‘å®š\n\n"
        report += "| ç»‘å®šåç§° | å‘½åç©ºé—´ | è§’è‰² | ä¸»ä½“æ•° |\n"
        report += "|----------|----------|------|--------|\n"
        for binding in self.bindings:
            subjects_count = len(binding.subjects)
            report += f"| {binding.binding_name} | {binding.namespace or 'é›†ç¾¤çº§åˆ«'} | {binding.role_ref_name} | {subjects_count} |\n"
        
        report += "\n## 3. å®‰å…¨åˆ†æ\n\n"
        checks = [
            ("é¿å…ä½¿ç”¨ cluster-admin", "âœ… é€šè¿‡" if not any("cluster-admin" in r.role_name for r in self.roles) else "âŒ éœ€å®¡æŸ¥"),
            ("Secrets åªè¯»è®¿é—®", "âœ… é€šè¿‡" if all("secrets" not in [r.resource for r in role.resources] or "delete" not in [v for r in role.resources for v in r.verbs if r.resource == "secrets"] for role in self.roles) else "âš ï¸ éœ€å®¡æŸ¥"),
            ("æœ€å°æƒé™åŸåˆ™", "âœ… é€šè¿‡" if all(len(role.resources) <= 10 for role in self.roles) else "âš ï¸ æƒé™è¾ƒå¤š"),
            ("é€‚å½“ä½¿ç”¨ Role è€Œé ClusterRole", "âœ… é€šè¿‡" if any(r.namespace for r in self.roles) else "âš ï¸ å»ºè®®ä½¿ç”¨ Role"),
            ("ServiceAccount ä½¿ç”¨", "âœ… é€šè¿‡" if all(s.get("kind") != "ServiceAccount" or s.get("name", "").endswith("-sa") for b in self.bindings for s in b.subjects) else "âš ï¸ æ£€æŸ¥ ServiceAccount å‘½å")
        ]
        
        for check, result in checks:
            report += f"- {result} {check}\n"
        
        report += "\n## 4. æ”¹è¿›å»ºè®®\n\n"
        recommendations = [
            "å®šæœŸå®¡æŸ¥å’Œæ¸…ç†æœªä½¿ç”¨çš„ç»‘å®š",
            "é¿å…ä½¿ç”¨é€šé…ç¬¦ï¼ˆ*ï¼‰åœ¨ apiGroups å’Œ resources ä¸­",
            "ä¼˜å…ˆä½¿ç”¨ Role è€Œä¸æ˜¯ ClusterRole",
            "ä¸ºæ¯ä¸ªåº”ç”¨åˆ›å»ºä¸“ç”¨çš„ ServiceAccount",
            "å®æ–½ RBAC å®¡è®¡æ—¥å¿—",
            "ä½¿ç”¨ Role Aggregation å¤ç”¨è§’è‰²"
        ]
        
        for rec in recommendations:
            report += f"- {rec}\n"
        
        return report
```

#### 1.2 æœ€å°æƒé™è®¾è®¡

```python
#!/usr/bin/env python3
"""
æœ€å°æƒé™ RBAC è®¾è®¡
"""
from __future__ import annotations
from dataclasses import dataclass
from typing import Optional, list


@dataclass
class PermissionMatrix:
    """æƒé™çŸ©é˜µ"""
    role: str
    permissions: list[dict]
    scope: str


class LeastPrivilegeRBACDesigner:
    """æœ€å°æƒé™ RBAC è®¾è®¡å™¨"""
    
    def __init__(self):
        self.permission_matrices: list[PermissionMatrix] = []
        
    def design_application_roles(self) -> dict:
        """è®¾è®¡åº”ç”¨è§’è‰²"""
        roles = {
            "frontend": {
                "description": "å‰ç«¯åº”ç”¨ - åªèƒ½è®¿é—®è‡ªå·±çš„ ConfigMap å’Œ Secret",
                "permissions": [
                    {"resource": "configmaps", "verbs": ["get", "list"], "own_only": True},
                    {"resource": "secrets", "verbs": ["get"], "own_only": True},
                    {"resource": "services", "verbs": ["get", "list"], "own_only": True}
                ]
            },
            "backend": {
                "description": "åç«¯åº”ç”¨ - å¯ä»¥è®¿é—®æ•°æ®åº“é…ç½®å’Œç¼“å­˜",
                "permissions": [
                    {"resource": "configmaps", "verbs": ["get", "list"], "own_only": True},
                    {"resource": "secrets", "verbs": ["get"], "own_only": True},
                    {"resource": "services", "verbs": ["get", "list"], "own_only": True},
                    {"resource": "pods", "verbs": ["get", "list", "watch"], "own_only": False}  # æœåŠ¡å‘ç°
                ]
            },
            "database": {
                "description": "æ•°æ®åº“ - åªèƒ½è®¿é—®æ•°æ®åº“å‡­æ®",
                "permissions": [
                    {"resource": "secrets", "verbs": ["get"], "own_only": True, "labels": {"app": "database"}}
                ]
            },
            "migration": {
                "description": "è¿ç§»ä½œä¸š - ä¸´æ—¶æƒé™ï¼Œæ‰§è¡Œå®Œæˆååˆ é™¤",
                "permissions": [
                    {"resource": "configmaps", "verbs": ["get", "list", "create", "update"]},
                    {"resource": "secrets", "verbs": ["get", "create"]},
                    {"resource": "jobs", "verbs": ["get", "list", "create", "delete"]}
                ],
                "temporary": True
            },
            "monitoring": {
                "description": "ç›‘æ§åº”ç”¨ - è¯»å– metrics å’ŒçŠ¶æ€",
                "permissions": [
                    {"resource": "pods", "verbs": ["get", "list", "watch"]},
                    {"resource": "services", "verbs": ["get", "list", "watch"]},
                    {"resource": "endpoints", "verbs": ["get", "list", "watch"]},
                    {"resource": "nodes", "verbs": ["get", "list"]}
                ]
            }
        }
        
        return roles
    
    def generate_role_definitions(self) -> str:
        """ç”Ÿæˆè§’è‰²å®šä¹‰"""
        roles = self.design_application_roles()
        
        definitions = """
# åº”ç”¨ä¸“ç”¨ Role å®šä¹‰

---

# Frontend åº”ç”¨è§’è‰²
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: app-frontend-role
  namespace: production
rules:
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list"]
  resourceNames: ["frontend-config", "frontend-env"]
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get"]
  resourceNames: ["frontend-api-key"]
- apiGroups: [""]
  resources: ["services"]
  verbs: ["get", "list"]
  resourceNames: ["frontend-service"]

---

# Frontend ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: frontend-sa
  namespace: production

---

# Frontend è§’è‰²ç»‘å®š
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: frontend-role-binding
  namespace: production
subjects:
- kind: ServiceAccount
  name: frontend-sa
  namespace: production
roleRef:
  kind: Role
  name: app-frontend-role
  apiGroup: rbac.authorization.k8s.io

---

# Backend åº”ç”¨è§’è‰²
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: app-backend-role
  namespace: production
rules:
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list"]
  resourceNames: ["backend-config", "database-config"]
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get"]
  resourceNames: ["database-credentials", "redis-credentials"]
- apiGroups: [""]
  resources: ["services"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]
  resourceNames: ["frontend-*"]  # é™åˆ¶åªèƒ½è®¿é—® frontend Pod

---

# Database è¿ç§»è§’è‰²ï¼ˆä¸´æ—¶ï¼‰
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: db-migration-role
  namespace: production
rules:
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "create", "update"]
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create"]
- apiGroups: ["batch"]
  resources: ["jobs"]
  verbs: ["get", "list", "create", "delete"]
"""
        return definitions
    
    def analyze_permission_requirements(self) -> str:
        """åˆ†ææƒé™éœ€æ±‚"""
        analysis = """
# æœ€å°æƒé™ RBAC è®¾è®¡åˆ†æ

## 1. è§’è‰²è®¾è®¡åŸåˆ™

### 1.1 åŸºäºèŒè´£çš„è§’è‰²
| èŒè´£ | è§’è‰² | æƒé™èŒƒå›´ |
|------|------|----------|
| å‰ç«¯åº”ç”¨ | frontend-role | è‡ªå·±çš„é…ç½® |
| åç«¯åº”ç”¨ | backend-role | é…ç½® + æœåŠ¡å‘ç° |
| æ•°æ®åº“ | db-role | æ•°æ®åº“å‡­æ® |
| è¿ç§»å·¥å…· | migration-role | ä¸´æ—¶ã€ä»»åŠ¡ç›¸å…³ |

### 1.2 æƒé™é™åˆ¶æ–¹æ³•

#### èµ„æºé™åˆ¶
```yaml
rules:
- resources: ["secrets"]
  verbs: ["get"]
  resourceNames: ["app-secret"]  # åªèƒ½è®¿é—®ç‰¹å®šèµ„æº
```

#### æ ‡ç­¾é€‰æ‹©å™¨
```yaml
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
  selectors:
    matchLabels:
      app: frontend
```

### 1.3 ç¦æ­¢çš„æ“ä½œ

| æ“ä½œ | åŸå›  | æ›¿ä»£æ–¹æ¡ˆ |
|------|------|----------|
| verbs: ["*"] | è¿‡åº¦æˆæƒ | æ˜ç¡®åˆ—å‡ºå¿…è¦æ“ä½œ |
| resources: ["*"] | è®¿é—®è¿‡å¤šèµ„æº | é™åˆ¶ç‰¹å®šèµ„æº |
| apiGroups: ["*"] | è®¿é—®æ‰€æœ‰ API | æ˜ç¡®æŒ‡å®š apiGroup |
| resourceNames: [] (empty) | æ— é™åˆ¶ | ä½¿ç”¨ resourceNames |

## 2. ServiceAccount è®¾è®¡

### 2.1 æ¯ä¸ªåº”ç”¨ä¸“ç”¨ ServiceAccount
```yaml
# å¥½çš„å®è·µ
apiVersion: v1
kind: ServiceAccount
metadata:
  name: frontend-sa
  namespace: production

å¥½çš„å®è·µ
# ä½¿ç”¨# ä¸ default ServiceAccount
```

### 2.2 å®šæœŸè½®æ¢ ServiceAccount ä»¤ç‰Œ
```bash
# åˆ é™¤å¹¶é‡å»º ServiceAccount
kubectl delete sa frontend-sa -n production
kubectl create sa frontend-sa -n production
```

## 3. æƒé™å®¡è®¡æ¸…å•

- [ ] é¿å…ä½¿ç”¨ cluster-admin
- [ ] é¿å… RoleBinding å¼•ç”¨ ClusterRoleï¼ˆé™¤éå¿…è¦ï¼‰
- [ ] ä½¿ç”¨ resourceNames é™åˆ¶è®¿é—®
- [ ] å®šæœŸå®¡æŸ¥æœªä½¿ç”¨çš„ç»‘å®š
- [ ] è®°å½•æ‰€æœ‰ RBAC å˜æ›´
- [ ] å¯ç”¨ RBAC å®¡è®¡æ—¥å¿—
"""
        return analysis
```

---

### 2ï¸âƒ£ ç½‘ç»œç­–ç•¥

#### 2.1 NetworkPolicy é…ç½®

```python
#!/usr/bin/env python3
"""
Kubernetes ç½‘ç»œç­–ç•¥é…ç½®
"""
from __future__ import annotations
from dataclasses import dataclass
from typing import Optional, list


@dataclass
class NetworkPolicyRule:
    """ç½‘ç»œç­–ç•¥è§„åˆ™"""
    rule_id: str
    direction: str  # Ingress, Egress
    from_source: list[dict]
    to_destination: list[dict]
    ports: list[dict]


@dataclass
class NetworkPolicyConfig:
    """ç½‘ç»œç­–ç•¥é…ç½®"""
    policy_name: str
    namespace: str
    pod_selector: dict
    ingress_rules: list[dict]
    egress_rules: list[dict]
    policy_types: list[str]


class KubernetesNetworkPolicyManager:
    """Kubernetes ç½‘ç»œç­–ç•¥ç®¡ç†å™¨"""
    
    def __init__(self):
        self.policies: list[NetworkPolicyConfig] = []
        
    def create_default_deny_policy(self, namespace: str) -> NetworkPolicyConfig:
        """åˆ›å»ºé»˜è®¤æ‹’ç»ç­–ç•¥"""
        policy = NetworkPolicyConfig(
            policy_name="default-deny",
            namespace=namespace,
            pod_selector={},  # é€‰æ‹©æ‰€æœ‰ Pod
            ingress_rules=[],
            egress_rules=[],
            policy_types=["Ingress", "Egress"]
        )
        
        self.policies.append(policy)
        return policy
    
    def create_allow_dns_policy(self, namespace: str) -> NetworkPolicyConfig:
        """åˆ›å»º DNS æ”¾è¡Œç­–ç•¥"""
        policy = NetworkPolicyConfig(
            policy_name="allow-dns",
            namespace=namespace,
            pod_selector={},
            ingress_rules=[],
            egress_rules=[
                {
                    "to": [
                        {
                            "namespaceSelector": {},
                            "podSelector": {
                                "matchLabels": {
                                    "k8s-app": "kube-dns"
                                }
                            }
                        }
                    ],
                    "ports": [
                        {"protocol": "UDP", "port": 53},
                        {"protocol": "TCP", "port": 53}
                    ]
                }
            ],
            policy_types=["Egress"]
        )
        
        self.policies.append(policy)
        return policy
    
    def create_frontend_policy(self, namespace: str) -> NetworkPolicyConfig:
        """åˆ›å»ºå‰ç«¯ç½‘ç»œç­–ç•¥"""
        policy = NetworkPolicyConfig(
            policy_name="frontend-network-policy",
            namespace=namespace,
            pod_selector={
                "matchLabels": {
                    "app": "frontend",
                    "tier": "web"
                }
            },
            ingress_rules=[
                {
                    "from": [
                        {
                            "namespaceSelector": {},
                            "podSelector": {}
                        }
                    ],
                    "ports": [
                        {"protocol": "TCP", "port": 80},
                        {"protocol": "TCP", "port": 443}
                    ]
                }
            ],
            egress_rules=[
                {
                    "to": [
                        {
                            "podSelector": {
                                "matchLabels": {
                                    "app": "backend",
                                    "tier": "api"
                                }
                            }
                        }
                    ],
                    "ports": [
                        {"protocol": "TCP", "port": 8080}
                    ]
                },
                {
                    "to": [
                        {
                            "namespaceSelector": {},
                            "podSelector": {
                                "matchLabels": {
                                    "k8s-app": "kube-dns"
                                }
                            }
                        }
                    ],
                    "ports": [
                        {"protocol": "UDP", "port": 53}
                    ]
                }
            ],
            policy_types=["Ingress", "Egress"]
        )
        
        self.policies.append(policy)
        return policy
    
    def create_backend_policy(self, namespace: str) -> NetworkPolicyConfig:
        """åˆ›å»ºåç«¯ç½‘ç»œç­–ç•¥"""
        policy = NetworkPolicyConfig(
            policy_name="backend-network-policy",
            namespace=namespace,
            pod_selector={
                "matchLabels": {
                    "app": "backend",
                    "tier": "api"
                }
            },
            ingress_rules=[
                {
                    "from": [
                        {
                            "podSelector": {
                                "matchLabels": {
                                    "app": "frontend",
                                    "tier": "web"
                                }
                            }
                        }
                    ],
                    "ports": [
                        {"protocol": "TCP", "port": 8080}
                    ]
                }
            ],
            egress_rules=[
                {
                    "to": [
                        {
                            "podSelector": {
                                "matchLabels": {
                                    "app": "database",
                                    "tier": "db"
                                }
                            }
                        }
                    ],
                    "ports": [
                        {"protocol": "TCP", "port": 5432}
                    ]
                },
                {
                    "to": [
                        {
                            "namespaceSelector": {},
                            "podSelector": {
                                "matchLabels": {
                                    "k8s-app": "kube-dns"
                                }
                            }
                        }
                    ],
                    "ports": [
                        {"protocol": "UDP", "port": 53}
                    ]
                }
            ],
            policy_types=["Ingress", "Egress"]
        )
        
        self.policies.append(policy)
        return policy
    
    def create_database_policy(self, namespace: str) -> NetworkPolicyConfig:
        """åˆ›å»ºæ•°æ®åº“ç½‘ç»œç­–ç•¥"""
        policy = NetworkPolicyConfig(
            policy_name="database-network-policy",
            namespace=namespace,
            pod_selector={
                "matchLabels": {
                    "app": "database",
                    "tier": "db"
                }
            },
            ingress_rules=[
                {
                    "from": [
                        {
                            "podSelector": {
                                "matchLabels": {
                                    "app": "backend",
                                    "tier": "api"
                                }
                            }
                        }
                    ],
                    "ports": [
                        {"protocol": "TCP", "port": 5432}
                    ]
                },
                {
                    "from": [
                        {
                            "podSelector": {
                                "matchLabels": {
                                    "app": "migration",
                                    "tier": "job"
                                }
                            }
                        }
                    ],
                    "ports": [
                        {"protocol": "TCP", "port": 5432}
                    ]
                }
            ],
            egress_rules=[],
            policy_types=["Ingress"]
        )
        
        self.policies.append(policy)
        return policy
    
    def generate_policy_yaml(self, policy: NetworkPolicyConfig) -> str:
        """ç”Ÿæˆç­–ç•¥ YAML"""
        yaml = f"""apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {policy.policy_name}
  namespace: {policy.namespace}
spec:
  podSelector:
    matchLabels: {policy.pod_selector}
"""
        
        if policy.ingress_rules:
            yaml += "  ingress:\n"
            for i, rule in enumerate(policy.ingress_rules):
                yaml += f"  - from:\n"
                for source in rule.get("from", []):
                    yaml += f"    - podSelector:\n"
                    yaml += f"        matchLabels: {source.get('podSelector', {})}\n"
                yaml += f"    ports:\n"
                for port in rule.get("ports", []):
                    yaml += f"      - protocol: {port.get('protocol')}\n"
                    yaml += f"        port: {port.get('port')}\n"
        
        if policy.egress_rules:
            yaml += "  egress:\n"
            for rule in policy.egress_rules:
                yaml += f"  - to:\n"
                for dest in rule.get("to", []):
                    yaml += f"    - podSelector:\n"
                    yaml += f"        matchLabels: {dest.get('podSelector', {})}\n"
                yaml += f"    ports:\n"
                for port in rule.get("ports", []):
                    yaml += f"      - protocol: {port.get('protocol')}\n"
                    yaml += f"        port: {port.get('port')}\n"
        
        yaml += f"  policyTypes: {policy.policy_types}\n"
        
        return yaml
    
    def generate_network_topology(self) -> str:
        """ç”Ÿæˆç½‘ç»œæ‹“æ‰‘"""
        topology = """
# Kubernetes ç½‘ç»œæ‹“æ‰‘

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”Ÿäº§ç¯å¢ƒç½‘ç»œç­–ç•¥                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    default å‘½åç©ºé—´                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”‚
â”‚  â”‚  â”‚              Internet                            â”‚       â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â”‚
â”‚  â”‚                         â”‚                                    â”‚    â”‚
â”‚  â”‚                         â–¼                                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”‚
â”‚  â”‚  â”‚         ğŸŒ Frontend (frontend)                  â”‚       â”‚    â”‚
â”‚  â”‚  â”‚         - å…è®¸å…¥ç«™: 80, 443                      â”‚       â”‚    â”‚
â”‚  â”‚  â”‚         - å…è®¸å‡ºç«™: backend (8080), DNS         â”‚       â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â”‚
â”‚  â”‚                         â”‚                                    â”‚    â”‚
â”‚  â”‚                         â–¼                                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”‚
â”‚  â”‚  â”‚         âš™ï¸ Backend (backend)                    â”‚       â”‚    â”‚
â”‚  â”‚  â”‚         - å…è®¸å…¥ç«™: frontend (8080)             â”‚       â”‚    â”‚
â”‚  â”‚  â”‚         - å…è®¸å‡ºç«™: database (5432), DNS        â”‚       â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â”‚
â”‚  â”‚                         â”‚                                    â”‚    â”‚
â”‚  â”‚                         â–¼                                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”‚
â”‚  â”‚  â”‚         ğŸ—„ï¸ Database (database)                  â”‚       â”‚    â”‚
â”‚  â”‚  â”‚         - å…è®¸å…¥ç«™: backend (5432)              â”‚       â”‚    â”‚
â”‚  â”‚  â”‚         - å‡ºç«™: æ—                                â”‚       â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â”‚
â”‚  â”‚                                                             â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”‚
â”‚  â”‚  â”‚         ğŸ“ DNS (kube-dns)                       â”‚       â”‚    â”‚
â”‚  â”‚  â”‚         - æ‰€æœ‰ Pod å¯ä»¥è®¿é—®                      â”‚       â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    kube-system å‘½åç©ºé—´                      â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”‚
â”‚  â”‚  â”‚         ğŸ”§ CoreDNS                               â”‚       â”‚    â”‚
â”‚  â”‚  â”‚         - å“åº” DNS æŸ¥è¯¢                          â”‚       â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  é»˜è®¤ç­–ç•¥:                                                        â”‚
â”‚  - é»˜è®¤æ‹’ç»æ‰€æœ‰å…¥ç«™æµé‡                                           â”‚
â”‚  - é»˜è®¤æ‹’ç»æ‰€æœ‰å‡ºç«™æµé‡ï¼ˆé™¤ DNSï¼‰                                  â”‚
â”‚  - æ¯ä¸ªåº”ç”¨åªèƒ½ä¸å…¶ç›´æ¥ä¾èµ–é€šä¿¡                                    â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
"""
        return topology
    
    def generate_network_policy_report(self) -> str:
        """ç”Ÿæˆç½‘ç»œç­–ç•¥æŠ¥å‘Š"""
        report = "# Kubernetes ç½‘ç»œç­–ç•¥æŠ¥å‘Š\n\n"
        
        report += "## 1. ç½‘ç»œç­–ç•¥é…ç½®\n\n"
        for policy in self.policies:
            report += f"### {policy.policy_name}\n\n"
            report += f"**å‘½åç©ºé—´**: {policy.namespace}\n"
            report += f"**Pod é€‰æ‹©å™¨**: {policy.pod_selector}\n"
            report += f"**ç­–ç•¥ç±»å‹**: {', '.join(policy.policy_types)}\n"
            
            if policy.ingress_rules:
                report += f"**å…¥ç«™è§„åˆ™**: {len(policy.ingress_rules)} æ¡\n"
            if policy.egress_rules:
                report += f"**å‡ºç«™è§„åˆ™**: {len(policy.egress_rules)} æ¡\n"
            report += "\n"
        
        report += "## 2. ç½‘ç»œæ‹“æ‰‘\n\n"
        report += self.generate_network_topology()
        
        report += "\n## 3. éƒ¨ç½²æ­¥éª¤\n\n"
        steps = """
```bash
# 1. éƒ¨ç½²é»˜è®¤æ‹’ç»ç­–ç•¥
kubectl apply -f default-deny.yaml

# 2. éƒ¨ç½² DNS æ”¾è¡Œç­–ç•¥
kubectl apply -f allow-dns.yaml

# 3. éƒ¨ç½²åº”ç”¨ç½‘ç»œç­–ç•¥
kubectl apply -f frontend-policy.yaml
kubectl apply -f backend-policy.yaml
kubectl apply -f database-policy.yaml

# 4. éªŒè¯ç­–ç•¥
kubectl get networkpolicies -n production

# 5. æµ‹è¯•è¿æ¥æ€§
kubectl exec -n production frontend-xxx -- curl -s backend-service:8080
kubectl exec -n production frontend-xxx -- curl -s database-service:5432  # åº”è¯¥å¤±è´¥
```
"""
        report += steps
        
        report += "\n## 4. éªŒè¯æ¸…å•\n\n"
        checks = [
            ("é»˜è®¤æ‹’ç»ç­–ç•¥å·²éƒ¨ç½²", "âœ…"),
            ("DNS è§£æå¯ç”¨", "âœ…"),
            ("å‰ç«¯åªèƒ½è®¿é—®åç«¯", "âœ…"),
            ("åç«¯åªèƒ½è®¿é—®æ•°æ®åº“", "âœ…"),
            ("æ•°æ®åº“ä¸æ¥å—å‰ç«¯ç›´æ¥è¿æ¥", "âœ…")
        ]
        
        for check, status in checks:
            report += f"- {status} {check}\n"
        
        return report
```

---

## å®è·µä»»åŠ¡ï¼ˆåˆæ³•æˆæƒèŒƒå›´å†…ï¼‰

> **æ³¨æ„**ï¼šä»¥ä¸‹ä»»åŠ¡è¯·åœ¨ä½ è‡ªå·±çš„æµ‹è¯•ç¯å¢ƒã€è™šæ‹Ÿæœºæˆ–æˆæƒé¶åœºä¸­æ‰§è¡Œã€‚

---

### ä»»åŠ¡ 1ï¼ˆå¿…åšï¼‰ï¼šRBAC é…ç½®

**ç›®æ ‡**ï¼šåœ¨æœ¬åœ° K8s ç¯å¢ƒä¸­é…ç½® RBACã€‚

**æ­¥éª¤**ï¼š

```bash
#!/bin/bash
# Kubernetes RBAC é…ç½®è„šæœ¬

# 1. åˆ›å»ºå¼€å‘è€…è§’è‰²
cat <<EOF | kubectl apply -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: developer-role
  namespace: default
rules:
- apiGroups: [""]
  resources: ["pods", "services", "configmaps"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
EOF

# 2. åˆ›å»ºå¼€å‘è€… ServiceAccount
kubectl create serviceaccount developer-sa -n default

# 3. åˆ›å»ºè§’è‰²ç»‘å®š
cat <<EOF | kubectl apply -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: developer-role-binding
  namespace: default
subjects:
- kind: ServiceAccount
  name: developer-sa
  namespace: default
roleRef:
  kind: Role
  name: developer-role
  apiGroup: rbac.authorization.k8s.io
EOF

# 4. éªŒè¯ç»‘å®š
kubectl auth can-i create pods --as=system:serviceaccount:default:developer-sa -n default

# 5. åˆ—å‡ºæ‰€æœ‰ RoleBinding
kubectl get rolebindings -n default

# 6. æŸ¥çœ‹è§’è‰²æƒé™
kubectl describe role developer-role -n default
```

---

### ä»»åŠ¡ 2ï¼ˆå¿…åšï¼‰ï¼šç½‘ç»œç­–ç•¥é…ç½®

**ç›®æ ‡**ï¼šé…ç½® Pod ç½‘ç»œéš”ç¦»ç­–ç•¥ã€‚

**æ­¥éª¤**ï¼š

```bash
#!/bin/bash
# Kubernetes ç½‘ç»œç­–ç•¥é…ç½®è„šæœ¬

# 1. åˆ›å»ºé»˜è®¤æ‹’ç»ç­–ç•¥
cat <<EOF | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny
  namespace: default
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
EOF

# 2. åˆ›å»º DNS æ”¾è¡Œç­–ç•¥
cat <<EOF | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: default
spec:
  podSelector: {}
  egress:
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  policyTypes:
  - Egress
EOF

# 3. åˆ›å»ºå‰ç«¯ç½‘ç»œç­–ç•¥
cat <<EOF | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-policy
  namespace: default
spec:
  podSelector:
    matchLabels:
      app: frontend
  ingress:
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 80
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: backend
    ports:
    - protocol: TCP
      port: 8080
  policyTypes:
  - Ingress
  - Egress
EOF

# 4. æŸ¥çœ‹ç½‘ç»œç­–ç•¥
kubectl get networkpolicies -n default

# 5. éªŒè¯ç­–ç•¥
kubectl describe networkpolicy default-deny -n default
```

---

### ä»»åŠ¡ 3ï¼ˆå¿…åšï¼‰ï¼šéªŒè¯ç­–ç•¥æ•ˆæœ

**ç›®æ ‡**ï¼šéªŒè¯ RBAC å’Œç½‘ç»œç­–ç•¥çš„æ•ˆæœã€‚

**æ­¥éª¤**ï¼š

```bash
#!/bin/bash
# éªŒè¯è„šæœ¬

# 1. éªŒè¯ RBAC
echo "=== RBAC éªŒè¯ ==="
echo "å¼€å‘è€… SA å¯ä»¥åˆ›å»º Pod:"
kubectl auth can-i create pods --as=system:serviceaccount:default:developer-sa -n default

echo "å¼€å‘è€… SA å¯ä»¥åˆ›å»º Secret:"
kubectl auth can-i create secrets --as=system:serviceaccount:default:developer-sa -n default

echo "å¼€å‘è€… SA å¯ä»¥åˆ é™¤ Deployment:"
kubectl auth can-i delete deployments --as=system:serviceaccount:default:developer-sa -n default

# 2. éªŒè¯ç½‘ç»œç­–ç•¥
echo ""
echo "=== ç½‘ç»œç­–ç•¥éªŒè¯ ==="
echo "å‰ç«¯ Pod æ ‡ç­¾:"
kubectl get pods -l app=frontend --show-labels

echo "åç«¯ Pod æ ‡ç­¾:"
kubectl get pods -l app=backend --show-labels

echo "ç½‘ç»œç­–ç•¥åˆ—è¡¨:"
kubectl get networkpolicies -o wide

# 3. æµ‹è¯•è¿æ¥æ€§
echo ""
echo "=== è¿æ¥æ€§æµ‹è¯• ==="
echo "ä» Frontend Pod æµ‹è¯•åˆ° Backend:"
kubectl exec -n default $(kubectl get pod -l app=frontend -o jsonpath='{.items[0].metadata.name}') -- \
    curl -s --connect-timeout 2 http://backend-service:8080/health || echo "è¿æ¥å¤±è´¥æˆ–è¶…æ—¶"

echo "ä» Frontend Pod æµ‹è¯•åˆ°æ•°æ®åº“:"
kubectl exec -n default $(kubectl get pod -l app=frontend -o jsonpath='{.items[0].metadata.name}') -- \
    curl -s --connect-timeout 2 http://database-service:5432 || echo "è¿æ¥è¢«é˜»æ­¢ï¼ˆé¢„æœŸè¡Œä¸ºï¼‰"
```

---

## å·©å›ºç»ƒä¹ ï¼ˆé¢˜ä¸å¤ç›˜ï¼‰

---

### ç»ƒä¹  1ï¼šæœ€å°æƒé™ RBAC è®¾è®¡

**é—®é¢˜**ï¼šä¸ºä¸€ä¸ªå¤šç§Ÿæˆ· SaaS åº”ç”¨è®¾è®¡ RBAC ç­–ç•¥ï¼ŒåŒ…å«ä»¥ä¸‹è§’è‰²ï¼š
- ç§Ÿæˆ·ç®¡ç†å‘˜ï¼šç®¡ç†è‡ªå·±çš„å‘½åç©ºé—´
- ç§Ÿæˆ·å¼€å‘è€…ï¼šåªèƒ½éƒ¨ç½²å’ŒæŸ¥çœ‹è‡ªå·±çš„åº”ç”¨
- ç§Ÿæˆ·åªè¯»ï¼šåªèƒ½æŸ¥çœ‹èµ„æºçŠ¶æ€

**ç¤ºä¾‹ç­”æ¡ˆ**ï¼š

```yaml
# ç§Ÿæˆ·å‘½åç©ºé—´è§’è‰²
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: tenant-admin
  namespace: tenant-001
rules:
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["*"]  # å…¨æƒç®¡ç†è‡ªå·±çš„å‘½åç©ºé—´

---
# ç§Ÿæˆ·å¼€å‘è€…è§’è‰²
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: tenant-developer
  namespace: tenant-001
rules:
- apiGroups: [""]
  resources: ["pods", "services", "configmaps", "secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

---
# ç§Ÿæˆ·åªè¯»è§’è‰²
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: tenant-readonly
  namespace: tenant-001
rules:
- apiGroups: [""]
  resources: ["pods", "services", "configmaps"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "watch"]
```

---

### ç»ƒä¹  2ï¼šNetworkPolicy è®¾è®¡

**é—®é¢˜**ï¼šä¸ºä¸€ä¸ªå¾®æœåŠ¡æ¶æ„è®¾è®¡ç½‘ç»œç­–ç•¥ã€‚

**ç¤ºä¾‹ç­”æ¡ˆ**ï¼š

```yaml
# é»˜è®¤æ‹’ç»æ‰€æœ‰æµé‡
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

---
# å…è®¸ API Gateway è®¿é—®æ‰€æœ‰æœåŠ¡
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-api-gateway
spec:
  podSelector:
    matchLabels:
      tier: backend
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
  egress: []

---
# å…è®¸æœåŠ¡å‘ç°
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-lookup
spec:
  podSelector: {}
  egress:
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
```

---

## è¯„ä¼°æ ‡å‡†ï¼ˆè¾¾æˆåˆ¤å®šï¼‰

- âœ… èƒ½åˆ›å»ºå’Œé…ç½® Role/ClusterRole
- âœ… èƒ½åˆ›å»º RoleBinding/ClusterRoleBinding
- âœ… èƒ½è®¾è®¡æœ€å°æƒé™çš„ RBAC ç­–ç•¥
- âœ… èƒ½é…ç½® NetworkPolicy å®ç° Pod éš”ç¦»
- âœ… èƒ½éªŒè¯ RBAC å’Œç½‘ç»œç­–ç•¥çš„æ•ˆæœ
- âœ… èƒ½ç”Ÿæˆå®‰å…¨å®¡è®¡æŠ¥å‘Š

---

## å­¦ä¹ æˆæœè¾¾æˆæƒ…å†µï¼ˆç”±å­¦ä¹ è€…å¡«å†™ï¼‰

### æˆªå›¾ä¸è¯æ®

- [ ] RBAC è§’è‰²é…ç½®æˆªå›¾
- [ ] è§’è‰²ç»‘å®šé…ç½®æˆªå›¾
- [ ] NetworkPolicy é…ç½®æˆªå›¾
- [ ] ç­–ç•¥éªŒè¯æˆªå›¾
- [ ] å®¡è®¡æŠ¥å‘Šæˆªå›¾

### å…³é”®å‘½ä»¤ä¸è¾“å‡º

**RBAC é…ç½®**ï¼š
```bash
$ kubectl get roles -n default
NAME              CREATED AT
developer-role    2024-01-15T10:00:00Z

$ kubectl auth can-i create pods --as=system:serviceaccount:default:developer-sa
yes
```

**ç½‘ç»œç­–ç•¥**ï¼š
```bash
$ kubectl get networkpolicies -n default
NAME              POD-SELECTOR       AGE
default-deny      {}                 1h
frontend-policy   app=frontend       30m
backend-policy    app=backend        30m
```

### ç»“è®ºä¸åæ€

**æˆ‘ä»Šå¤©ææ¸…æ¥šäº†**ï¼š

- Kubernetes RBAC çš„è§’è‰²å’Œç»‘å®šæœºåˆ¶
- æœ€å°æƒé™åŸåˆ™åœ¨ K8s ä¸­çš„åº”ç”¨
- NetworkPolicy çš„é…ç½®å’Œä½¿ç”¨
- ç­–ç•¥éªŒè¯å’Œè°ƒè¯•æ–¹æ³•
- å®¡è®¡æŠ¥å‘Šçš„ç”Ÿæˆ

**æˆ‘å·®ç‚¹ææ··çš„æ˜¯**ï¼š

- Role å’Œ ClusterRole çš„ä½¿ç”¨åœºæ™¯
- NamespaceSelector å’Œ PodSelector çš„åŒºåˆ«
- Ingress å’Œ Egress è§„åˆ™çš„é…ç½®

**æ˜å¤©æˆ‘è¦ç»§ç»­è¡¥çš„æ˜¯**ï¼š

- Kubernetes å®‰å…¨åŠ å›º
- å®¹å™¨ç½‘ç»œå®‰å…¨
- äº‘åŸç”Ÿå®‰å…¨å·¥å…·

**æœ¬æ¬¡å­¦ä¹ è€—æ—¶**ï¼šçº¦ 4 å°æ—¶

**æŒæ¡ç¨‹åº¦è‡ªè¯„**ï¼š

- [ ] ğŸ˜• ç†è§£äº†åŸºæœ¬æ¦‚å¿µï¼Œä½†å®è·µä¸ç†Ÿç»ƒ
- [ ] ğŸ™‚ å®Œæˆäº†åŸºç¡€ä»»åŠ¡
- [ ] ğŸ˜ƒ å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡å¹¶ç†è§£åŸç†
- [ ] ğŸ¤© é¢å¤–å®Œæˆäº†ä¼ä¸šçº§ RBAC æ¶æ„è®¾è®¡


## å­¦ä¹ æˆæœç¤ºä¾‹å¡«å†™ï¼ˆå¯ç…§æŠ„ï¼‰

> å¯å°†"ç¤ºä¾‹"å†…å®¹æ›¿æ¢ä¸ºä½ è‡ªå·±çš„æ—¶é—´ä¸æˆªå›¾æ–‡ä»¶åã€‚

### æˆªå›¾ä¸è¯æ®ï¼ˆç¤ºä¾‹ï¼‰

- ä»»åŠ¡ 1ï¼š`images/day067_task1.png`
- ä»»åŠ¡ 2ï¼š`images/day067_task2.png`
- ä»»åŠ¡ 3ï¼š`images/day067_task3.png`

### å…³é”®å‘½ä»¤ä¸è¾“å‡ºï¼ˆç¤ºä¾‹ï¼‰

```
å‘½ä»¤ç¤ºä¾‹ï¼š
è¾“å‡ºç¤ºä¾‹ï¼š
```

### ç»“è®ºä¸åæ€ï¼ˆç¤ºä¾‹ï¼‰

**æˆ‘ä»Šå¤©ææ¸…æ¥šäº†**ï¼š
- ï¼ˆç¤ºä¾‹ï¼‰ç†è§£äº†æ ¸å¿ƒæ¦‚å¿µ

**æˆ‘å·®ç‚¹ææ··çš„æ˜¯**ï¼š
- ï¼ˆç¤ºä¾‹ï¼‰æŸä¸ªæ˜“æ··æ·†ç‚¹

**æ˜å¤©æˆ‘è¦ç»§ç»­è¡¥çš„æ˜¯**ï¼š
- ï¼ˆç¤ºä¾‹ï¼‰ä¸‹ä¸€æ­¥æ·±å…¥æ–¹å‘

**æœ¬æ¬¡å­¦ä¹ è€—æ—¶**ï¼šçº¦ 2 å°æ—¶

**æŒæ¡ç¨‹åº¦è‡ªè¯„**ï¼š
- [x] ğŸ˜ƒ å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡å¹¶ç†è§£åŸç†
