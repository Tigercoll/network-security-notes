# Day029ï¼šæ—¥å¿—ä¸å¯è§‚æµ‹æ€§ - æ—¥å¿—ç±»å‹ä¸å­—æ®µè§„èŒƒ

- æ—¥æœŸï¼š2026-01-22
- å‘¨æ¬¡ï¼šç¬¬5å‘¨

## å­¦ä¹ ç›®æ ‡

ä»Šå¤©ä½ å°†æŒæ¡æ—¥å¿—ç®¡ç†çš„åŸºç¡€çŸ¥è¯†ï¼š

- **è¯†åˆ«æ—¥å¿—ç±»å‹**ï¼šç³»ç»Ÿæ—¥å¿—ã€åº”ç”¨æ—¥å¿—ã€å®‰å…¨æ—¥å¿—ã€è®¿é—®æ—¥å¿—çš„åŒºåˆ«ä¸ç”¨é€”
- **ç†è§£å…³é”®å­—æ®µ**ï¼šæ—¶é—´æˆ³ã€ä¸»æœºåã€ç”¨æˆ·ã€äº‹ä»¶ç±»å‹ã€ä¸Šä¸‹æ–‡ä¿¡æ¯çš„ä½œç”¨
- **æŒæ¡è§„èŒƒåŒ–æ„ä¹‰**ï¼šç†è§£æ—¥å¿—è§„èŒƒåŒ–çš„å¥½å¤„ï¼ˆåˆ†æã€æœç´¢ã€åˆè§„ï¼‰
- **è®¾è®¡æ—¥å¿—å­—æ®µ**ï¼šèƒ½ä¸ºä¸åŒåœºæ™¯è®¾è®¡åˆç†çš„æ—¥å¿—å­—æ®µç»“æ„
- **è¾“å‡ºç»Ÿä¸€æ ¼å¼**ï¼šèƒ½å°†ä¸åŒæ¥æºçš„æ—¥å¿—è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼ï¼ˆJSON/CSVï¼‰

---

## å­¦ä¹ å†…å®¹

### 1ï¸âƒ£ æ—¥å¿—åˆ†ç±»ä¸ç”¨é€”

#### 1.1 æ—¥å¿—ç±»å‹æ€»è§ˆ

```
æ—¥å¿—åˆ†ç±»ä½“ç³»
â”‚
â”œâ”€ ç³»ç»Ÿæ—¥å¿—
â”‚  â”œâ”€ å†…æ ¸æ—¥å¿—
â”‚  â”œâ”€ ç³»ç»ŸæœåŠ¡æ—¥å¿—
â”‚  â””â”€ ç¡¬ä»¶æ—¥å¿—
â”‚
â”œâ”€ åº”ç”¨æ—¥å¿—
â”‚  â”œâ”€ Web æœåŠ¡å™¨æ—¥å¿—ï¼ˆNginx/Apacheï¼‰
â”‚  â”œâ”€ åº”ç”¨ç¨‹åºæ—¥å¿—ï¼ˆPython/Java/Node.jsï¼‰
â”‚  â”œâ”€ æ•°æ®åº“æ—¥å¿—ï¼ˆMySQL/PostgreSQLï¼‰
â”‚  â””â”€ ä¸­é—´ä»¶æ—¥å¿—ï¼ˆRedis/MQï¼‰
â”‚
â”œâ”€ å®‰å…¨æ—¥å¿—
â”‚  â”œâ”€ è®¤è¯æ—¥å¿—ï¼ˆç™»å½•/ç™»å‡ºï¼‰
â”‚  â”œâ”€ æˆæƒæ—¥å¿—ï¼ˆæƒé™å˜æ›´ï¼‰
â”‚  â”œâ”€ å®¡è®¡æ—¥å¿—ï¼ˆæ“ä½œè®°å½•ï¼‰
â”‚  â””â”€ å¨èƒæ—¥å¿—ï¼ˆæ”»å‡»æ£€æµ‹ï¼‰
â”‚
â””â”€ è®¿é—®æ—¥å¿—
   â”œâ”€ HTTP è®¿é—®æ—¥å¿—
   â”œâ”€ API è°ƒç”¨æ—¥å¿—
   â””â”€ ç”¨æˆ·è¡Œä¸ºæ—¥å¿—
```

---

#### 1.2 å„ç±»å‹æ—¥å¿—è¯¦è§£

**1. ç³»ç»Ÿæ—¥å¿—**

| æ—¥å¿—ç±»å‹ | è·¯å¾„ï¼ˆLinuxï¼‰| è·¯å¾„ï¼ˆWindowsï¼‰| å…¸å‹å­—æ®µ |
|---------|----------------|----------------|----------|
| å†…æ ¸æ—¥å¿— | `/var/log/kern.log` | äº‹ä»¶æŸ¥çœ‹å™¨ â†’ ç³»ç»Ÿ | timestamp, level, message |
| ç³»ç»Ÿæ—¥å¿— | `/var/log/syslog` | äº‹ä»¶æŸ¥çœ‹å™¨ â†’ ç³»ç»Ÿ | timestamp, facility, level, message |
| æœåŠ¡æ—¥å¿— | `/var/log/` | Event Log | timestamp, service, status, message |

**ç¤ºä¾‹**ï¼š

```
Jan 22 10:30:00 server01 systemd[1]: Started nginx.service
Jan 22 10:30:01 server01 kernel: [UFW BLOCK] IN=eth0 SRC=192.168.1.100
```

---

**2. åº”ç”¨æ—¥å¿—**

**Web æœåŠ¡å™¨è®¿é—®æ—¥å¿—ï¼ˆNginx/Apacheï¼‰**ï¼š

```
192.168.1.10 - - [22/Jan/2026:10:30:00 +0800] "GET /api/users HTTP/1.1" 200 1234 "-" "Mozilla/5.0"
```

**åº”ç”¨ç¨‹åºæ—¥å¿—ï¼ˆç»“æ„åŒ–ï¼‰**ï¼š

```json
{
  "timestamp": "2026-01-22T10:30:00.123Z",
  "level": "INFO",
  "service": "user-service",
  "trace_id": "abc123",
  "user_id": "user001",
  "action": "login",
  "ip": "192.168.1.10",
  "status": "success"
}
```

**æ•°æ®åº“æ—¥å¿—ï¼ˆMySQLï¼‰**ï¼š

```
2026-01-22T10:30:00.123456Z 123 [Note] Access denied for user 'root'@'192.168.1.10'
```

---

**3. å®‰å…¨æ—¥å¿—**

**è®¤è¯æ—¥å¿—**ï¼ˆLinux `/var/log/auth.log`ï¼‰ï¼š

```
Jan 22 10:30:00 server01 sshd[12345]: Accepted password for user01 from 192.168.1.10 port 54321 ssh2
Jan 22 10:30:05 server01 sshd[12346]: Failed password for admin from 192.168.1.11 port 54322 ssh2
```

**å®‰å…¨äº‹ä»¶æ—¥å¿—**ï¼ˆWindows Event ID 4625ï¼‰ï¼š

```
è´¦æˆ·ç™»å½•å¤±è´¥
äº‹ä»¶ ID: 4625
ç”¨æˆ·å: Administrator
æº IP: 192.168.1.100
å¤±è´¥åŸå› : é”™è¯¯å¯†ç 
æ—¶é—´: 2026-01-22 10:30:00
```

---

**4. è®¿é—®æ—¥å¿—**

**HTTP è®¿é—®æ—¥å¿—ï¼ˆç»„åˆæ—¥å¿—æ ¼å¼ï¼‰**ï¼š

```
192.168.1.10 - user01 [22/Jan/2026:10:30:00 +0800] "GET /api/data HTTP/1.1" 200 5678 "https://example.com" "Mozilla/5.0" 0.123
```

**API è°ƒç”¨æ—¥å¿—**ï¼š

```json
{
  "timestamp": "2026-01-22T10:30:00.123Z",
  "method": "POST",
  "path": "/api/orders",
  "status_code": 201,
  "user_id": "user001",
  "request_id": "req_abc123",
  "duration_ms": 123,
  "ip": "192.168.1.10"
}
```

---

### 2ï¸âƒ£ æ—¥å¿—å…³é”®å­—æ®µ

#### 2.1 æ ¸å¿ƒå­—æ®µè¯´æ˜

| å­—æ®µç±»åˆ« | å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|---------|-------|------|------|------|
| **æ—¶é—´ç›¸å…³** | timestamp | datetime | äº‹ä»¶å‘ç”Ÿæ—¶é—´ | 2026-01-22T10:30:00.123Z |
| | duration_ms | int | è¯·æ±‚æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰| 123 |
| **ä¸»æœºç›¸å…³** | hostname | string | ä¸»æœºå | server01.example.com |
| | ip_address | string | IP åœ°å€ | 192.168.1.10 |
| | port | int | ç«¯å£å· | 443 |
| **ç”¨æˆ·ç›¸å…³** | user_id | string | ç”¨æˆ· ID | user001 |
| | username | string | ç”¨æˆ·å | admin |
| | session_id | string | ä¼šè¯ ID | sess_abc123 |
| **è¯·æ±‚ç›¸å…³** | method | string | HTTP æ–¹æ³• | GET, POST, PUT, DELETE |
| | path | string | è¯·æ±‚è·¯å¾„ | /api/users |
| | query_string | string | æŸ¥è¯¢å‚æ•° | ?page=1&limit=10 |
| | user_agent | string | ç”¨æˆ·ä»£ç† | Mozilla/5.0... |
| | referer | string | æ¥æºé¡µé¢ | https://example.com |
| **å“åº”ç›¸å…³** | status_code | int | HTTP çŠ¶æ€ç  | 200, 404, 500 |
| | response_size | int | å“åº”å¤§å°ï¼ˆå­—èŠ‚ï¼‰| 1234 |
| **äº‹ä»¶ç›¸å…³** | event_type | string | äº‹ä»¶ç±»å‹ | login, logout, error |
| | event_id | string | äº‹ä»¶ ID | evt_abc123 |
| | level | string | æ—¥å¿—çº§åˆ« | DEBUG, INFO, WARNING, ERROR |
| | message | string | æ—¥å¿—æ¶ˆæ¯ | ç”¨æˆ·ç™»å½•æˆåŠŸ |
| **ä¸Šä¸‹æ–‡ç›¸å…³** | trace_id | string | è¿½è¸ª ID | trace_abc123 |
| | tags | array | æ ‡ç­¾ | ["web", "api", "orders"] |
| | metadata | object | å…ƒæ•°æ® | {"version": "1.0.0"} |

---

#### 2.2 æ—¶é—´æˆ³æ ¼å¼è§„èŒƒ

| æ ¼å¼ | æ ‡å‡† | ç¤ºä¾‹ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|------|------|
| **ISO 8601** | å›½é™…æ ‡å‡† | 2026-01-22T10:30:00.123Z | æœºå™¨å¯è¯»ã€æ—¶åŒºæ˜ç¡® | äººç±»å¯è¯»æ€§ç•¥å·® |
| **Unix æ—¶é—´æˆ³** | Unix æ ‡å‡† | 1737515400.123 | ç²¾ç¡®ã€æ˜“äºè®¡ç®— | ä¸å¯è¯» |
| **Apache æ ¼å¼** | Web æ ‡å‡† | 22/Jan/2026:10:30:00 +0800 | Web æœåŠ¡å™¨é€šç”¨ | ä¸æ˜“è§£æ |

**æ¨èæ ¼å¼**ï¼šISO 8601 (UTC)
```json
{
  "timestamp": "2026-01-22T10:30:00.123Z"
}
```

---

### 3ï¸âƒ£ æ—¥å¿—è§„èŒƒåŒ–ä¸æ ‡å‡†åŒ–

#### 3.1 ä¸ºä½•éœ€è¦æ—¥å¿—è§„èŒƒåŒ–ï¼Ÿ

**ä¸è§„èŒƒçš„é—®é¢˜**ï¼š

```
é—®é¢˜ 1: æ—¶é—´æ ¼å¼ä¸ç»Ÿä¸€
â†’ 2026-01-22 10:30:00
â†’ 01/22/2026 10:30:00 AM
â†’ Jan 22, 2026 10:30 AM

é—®é¢˜ 2: å­—æ®µåç§°ä¸ç»Ÿä¸€
â†’ user_id, userId, User_ID
â†’ ip, IP, ip_address, client_ip

é—®é¢˜ 3: æ—¥å¿—çº§åˆ«ä¸ç»Ÿä¸€
â†’ INFO, info, Information
â†’ ERROR, error, Error, CRITICAL
```

**è§„èŒƒåŒ–çš„å¥½å¤„**ï¼š

1. **ç»Ÿä¸€åˆ†æ**ï¼šæ‰€æœ‰æ—¥å¿—å¯ç”¨åŒä¸€å·¥å…·åˆ†æ
2. **å¿«é€Ÿæ£€ç´¢**ï¼šå­—æ®µåä¸€è‡´ï¼Œæœç´¢æ›´é«˜æ•ˆ
3. **è‡ªåŠ¨åŒ–å¤„ç†**ï¼šæœºå™¨å¯è§£æï¼Œæ˜“äºè‡ªåŠ¨åŒ–
4. **åˆè§„è¦æ±‚**ï¼šæ»¡è¶³å®¡è®¡å’Œç›‘ç®¡è¦æ±‚
5. **é™ä½æˆæœ¬**ï¼šå‡å°‘æ ¼å¼è½¬æ¢å’Œæ¸…æ´—å·¥ä½œ

---

#### 3.2 æ—¥å¿—çº§åˆ«è§„èŒƒ

| çº§åˆ« | ç”¨é€” | ç¤ºä¾‹åœºæ™¯ |
|------|------|---------|
| **TRACE** | æœ€è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ | å‡½æ•°è°ƒç”¨ã€å˜é‡å€¼ |
| **DEBUG** | è°ƒè¯•ä¿¡æ¯ | æ•°æ®åº“æŸ¥è¯¢ã€ä¸­é—´çŠ¶æ€ |
| **INFO** | ä¸€èˆ¬ä¿¡æ¯ | ç”¨æˆ·ç™»å½•ã€æœåŠ¡å¯åŠ¨ |
| **WARNING** | è­¦å‘Šä¿¡æ¯ | é…ç½®é¡¹ç¼ºå¤±ã€é™çº§ä½¿ç”¨ |
| **ERROR** | é”™è¯¯ä¿¡æ¯ | å¼‚å¸¸æŠ›å‡ºã€è¯·æ±‚å¤±è´¥ |
| **CRITICAL** | ä¸¥é‡é”™è¯¯ | æœåŠ¡å®•æœºã€æ•°æ®ä¸¢å¤± |

**æ¨èæ˜ å°„**ï¼š

```python
# æ ‡å‡†æ—¥å¿—çº§åˆ«
LOG_LEVELS = {
    "TRACE": 0,
    "DEBUG": 1,
    "INFO": 2,
    "WARNING": 3,
    "ERROR": 4,
    "CRITICAL": 5
}
```

---

#### 3.3 ç»Ÿä¸€æ—¥å¿—æ ¼å¼ï¼ˆJSONï¼‰ç¤ºä¾‹

```json
{
  "timestamp": "2026-01-22T10:30:00.123Z",
  "level": "INFO",
  "hostname": "web-01",
  "service": "nginx",
  "event_type": "http_access",
  "ip_address": "192.168.1.10",
  "user_id": "user001",
  "http": {
    "method": "GET",
    "path": "/api/users",
    "query_string": "?page=1",
    "status_code": 200,
    "response_size": 1234,
    "duration_ms": 123
  },
  "context": {
    "user_agent": "Mozilla/5.0",
    "referer": "https://example.com",
    "trace_id": "trace_abc123"
  }
}
```

---

### 4ï¸âƒ£ æ—¥å¿—é‡‡é›†ä¸æ ‡å‡†åŒ–

#### 4.1 å¸¸ç”¨æ—¥å¿—é‡‡é›†å·¥å…·

| å·¥å…· | é€‚ç”¨åœºæ™¯ | ç‰¹ç‚¹ |
|------|---------|------|
| **Filebeat** | æ–‡ä»¶æ—¥å¿—é‡‡é›† | è½»é‡çº§ã€é…ç½®ç®€å• |
| **Fluentd** | å¤šæºæ—¥å¿—é‡‡é›† | æ’ä»¶ä¸°å¯Œã€çµæ´» |
| **Logstash** | æ—¥å¿—å¤„ç†ä¸è½¬æ¢ | å¼ºå¤§çš„è¿‡æ»¤å’Œè½¬æ¢èƒ½åŠ› |
| **Flume** | å¤§æ•°æ®æ—¥å¿— | Hadoop ç”Ÿæ€ |
| **Splunk** | æ—¥å¿—åˆ†æå¹³å° | å•†ä¸šè½¯ä»¶ã€åŠŸèƒ½å¼ºå¤§ |
| **ELK Stack** | å¼€æºæ—¥å¿—å¹³å° | Elasticsearch + Logstash + Kibana |

---

#### 4.2 æ—¥å¿—æ ‡å‡†åŒ–æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ—¥å¿—é‡‡é›†                                     â”‚
â”‚    - æ–‡ä»¶æ—¥å¿—ï¼šFilebeat/Fluentd                     â”‚
â”‚    - ç³»ç»Ÿæ—¥å¿—ï¼šSyslog/Windows Event Log           â”‚
â”‚    - åº”ç”¨æ—¥å¿—ï¼šç›´æ¥å†™å…¥æˆ–é€šè¿‡ Agent                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æ ¼å¼è½¬æ¢                                     â”‚
â”‚    - è§£æåŸå§‹æ—¥å¿—ï¼ˆæ–‡æœ¬ â†’ ç»“æ„åŒ–ï¼‰                â”‚
â”‚    - ç»Ÿä¸€å­—æ®µåç§°                                 â”‚
â”‚    - è½¬æ¢æ—¶é—´æ ¼å¼                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å­—æ®µæ˜ å°„                                     â”‚
â”‚    - æå–å…³é”®å­—æ®µ                                 â”‚
â”‚    - æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯                                 â”‚
â”‚    - å¯ŒåŒ–æ•°æ®ï¼ˆIP åœ°ç†ä½ç½®ã€User Agent è§£æï¼‰      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ•°æ®å­˜å‚¨                                     â”‚
â”‚    - æ—¶åºæ•°æ®åº“ï¼šElasticsearchã€InfluxDB           â”‚
â”‚    - æ•°æ®ä»“åº“ï¼šClickHouseã€Hive                   â”‚
â”‚    - å¯¹è±¡å­˜å‚¨ï¼šS3ã€HDFS                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. åˆ†æä¸å¯è§†åŒ–                                 â”‚
â”‚    - æœç´¢æŸ¥è¯¢                                     â”‚
â”‚    - ç»Ÿè®¡åˆ†æ                                     â”‚
â”‚    - å‘Šè­¦è§„åˆ™                                     â”‚
â”‚    - å¯è§†åŒ–ä»ªè¡¨ç›˜                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### 4.3 å­—æ®µæ˜ å°„ç¤ºä¾‹

**åŸå§‹ Nginx æ—¥å¿—**ï¼š

```
192.168.1.10 - user01 [22/Jan/2026:10:30:00 +0800] "GET /api/users HTTP/1.1" 200 1234 "-" "Mozilla/5.0"
```

**æ ‡å‡†åŒ–åçš„ JSON**ï¼š

```json
{
  "timestamp": "2026-01-22T02:30:00.000Z",
  "level": "INFO",
  "hostname": "web-01",
  "service": "nginx",
  "event_type": "http_access",
  "ip_address": "192.168.1.10",
  "user_id": "user01",
  "http": {
    "method": "GET",
    "path": "/api/users",
    "protocol": "HTTP/1.1",
    "status_code": 200,
    "response_size": 1234
  },
  "context": {
    "user_agent": "Mozilla/5.0"
  }
}
```

---

### 5ï¸âƒ£ åˆè§„è¦æ±‚ä¸æœ€ä½³å®è·µ

#### 5.1 åˆè§„è¦æ±‚

| åˆè§„æ ‡å‡† | æ—¥å¿—è¦æ±‚ | ä¿ç•™æœŸé™ | å…³é”®å­—æ®µ |
|---------|---------|---------|---------|
| **ç­‰ä¿ 2.0** | è®¿é—®æ—¥å¿—ã€å®‰å…¨æ—¥å¿— | â‰¥ 6 ä¸ªæœˆ | ç”¨æˆ· IDã€IPã€æ—¶é—´ã€æ“ä½œå†…å®¹ |
| **PCI DSS** | è®¿é—®æ—¥å¿—ã€å®¡è®¡æ—¥å¿— | â‰¥ 1 å¹´ | ç”¨æˆ· IDã€IPã€æ—¶é—´ã€æ“ä½œå†…å®¹ |
| **GDPR** | ä¸ªäººæ•°æ®å¤„ç†æ—¥å¿— | ç‰¹å®šåœºæ™¯ | ç”¨æˆ·æ ‡è¯†ã€æ•°æ®å¤„ç†ç›®çš„ |
| **SOX** | è´¢åŠ¡ç›¸å…³æ—¥å¿— | â‰¥ 7 å¹´ | æ“ä½œäººå‘˜ã€æ“ä½œå†…å®¹ã€å®¡è®¡è®°å½• |

---

#### 5.2 æ—¥å¿—æœ€ä½³å®è·µ

| å®è·µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **ç»“æ„åŒ–æ—¥å¿—** | ä½¿ç”¨ JSON æ ¼å¼ | {"timestamp": "...", "level": "INFO"} |
| **ç»Ÿä¸€æ—¶é—´æ ¼å¼** | ä½¿ç”¨ ISO 8601 | 2026-01-22T10:30:00.123Z |
| **å”¯ä¸€è¿½è¸ª ID** | æ¯ä¸ªè¯·æ±‚ç”Ÿæˆå”¯ä¸€ ID | trace_abc123 |
| **æ•æ„Ÿä¿¡æ¯è„±æ•** | ä¸è®°å½•å¯†ç ã€ä¿¡ç”¨å¡å· | `password=***` |
| **æ—¥å¿—åˆ†çº§** | åˆç†ä½¿ç”¨æ—¥å¿—çº§åˆ« | é”™è¯¯ç”¨ ERRORï¼Œæ™®é€šæ“ä½œç”¨ INFO |
| **æ—¥å¿—è½®è½¬** | å®šæœŸæ¸…ç†æ—§æ—¥å¿— | æ—¥å¿—æ–‡ä»¶æŒ‰å¤©/å¤§å°è½®è½¬ |
| **å¼‚æ­¥æ—¥å¿—** | ä¸é˜»å¡ä¸»çº¿ç¨‹ | ä½¿ç”¨å¼‚æ­¥æ—¥å¿—åº“ |
| **ä¸Šä¸‹æ–‡ä¿¡æ¯** | è®°å½•è¯·æ±‚ä¸Šä¸‹æ–‡ | user_id, session_id, ip_address |

---

### 6ï¸âƒ£ æ—¥å¿—åˆ†ææ¡ˆä¾‹

#### 6.1 åˆ†æåœºæ™¯ 1ï¼šæš´åŠ›ç ´è§£æ£€æµ‹

**æŸ¥è¯¢è¯­å¥ï¼ˆElasticsearch/Kibanaï¼‰**ï¼š

```json
{
  "query": {
    "bool": {
      "must": [
        {"match": {"event_type": "auth_failed"}},
        {"range": {"timestamp": {"gte": "now-1h"}}}
      ]
    }
  },
  "aggs": {
    "failed_logins_by_ip": {
      "terms": {"field": "ip_address"}
    }
  }
}
```

**å‘Šè­¦è§„åˆ™**ï¼š

```
å¦‚æœåŒä¸€ IP åœ¨ 5 åˆ†é’Ÿå†…å¤±è´¥ç™»å½•è¶…è¿‡ 10 æ¬¡ï¼Œè§¦å‘å‘Šè­¦
```

---

#### 6.2 åˆ†æåœºæ™¯ 2ï¼šå¼‚å¸¸æµé‡æ£€æµ‹

**æŸ¥è¯¢è¯­å¥**ï¼š

```json
{
  "query": {
    "bool": {
      "must": [
        {"match": {"event_type": "http_access"}}
      ],
      "filter": [
        {"range": {"http.response_size": {"gte": 10000000}}}
      ]
    }
  },
  "aggs": {
    "top_downloads": {
      "terms": {"field": "http.path", "size": 10}
    }
  }
}
```

**å‘Šè­¦è§„åˆ™**ï¼š

```
å¦‚æœå•æ¬¡å“åº”å¤§å°è¶…è¿‡ 10 MBï¼Œè§¦å‘å‘Šè­¦
```

---

## å®è·µä»»åŠ¡ï¼ˆåˆæ³•æˆæƒèŒƒå›´å†…ï¼‰

> **æ³¨æ„**ï¼šè¯·åœ¨ä½ è‡ªå·±çš„æµ‹è¯•ç¯å¢ƒæˆ–æˆæƒé¶åœºä¸­æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ã€‚

---

### ä»»åŠ¡ 1ï¼ˆå¿…åšï¼‰ï¼šåˆ†ææœ¬åœ°æ—¥å¿—

**ç›®æ ‡**ï¼šåˆ†ææœ¬åœ°ç³»ç»Ÿçš„ä¸åŒç±»å‹æ—¥å¿—ï¼Œè¯†åˆ«å…³é”®å­—æ®µã€‚

**æ­¥éª¤**ï¼š

1. **æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—ï¼ˆLinuxï¼‰**

```bash
# æŸ¥çœ‹ syslog
tail -50 /var/log/syslog

# æŸ¥çœ‹ auth.logï¼ˆè®¤è¯æ—¥å¿—ï¼‰
tail -50 /var/log/auth.log

# æŸ¥çœ‹ Nginx è®¿é—®æ—¥å¿—
tail -50 /var/log/nginx/access.log

# æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—
tail -50 /var/log/nginx/error.log
```

2. **æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—ï¼ˆWindowsï¼‰**

```powershell
# æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
Get-EventLog -LogName System -Newest 50

# æŸ¥çœ‹å®‰å…¨æ—¥å¿—
Get-EventLog -LogName Security -Newest 50

# æŸ¥çœ‹åº”ç”¨ç¨‹åºæ—¥å¿—
Get-EventLog -LogName Application -Newest 50
```

3. **è®°å½•å­—æ®µ**

åˆ›å»º `log_fields_analysis.md`ï¼š

```markdown
# æ—¥å¿—å­—æ®µåˆ†æ

## ç³»ç»Ÿæ—¥å¿— (/var/log/syslog)

| å­—æ®µ | ç±»å‹ | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|------|
| timestamp | datetime | Jan 22 10:30:00 | äº‹ä»¶æ—¶é—´ |
| hostname | string | server01 | ä¸»æœºå |
| process | string | systemd[1] | è¿›ç¨‹å |
| message | string | Started nginx.service | æ¶ˆæ¯å†…å®¹ |

## è®¤è¯æ—¥å¿— (/var/log/auth.log)

| å­—æ®µ | ç±»å‹ | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|------|
| timestamp | datetime | Jan 22 10:30:00 | äº‹ä»¶æ—¶é—´ |
| hostname | string | server01 | ä¸»æœºå |
| process | string | sshd[12345] | è¿›ç¨‹å |
| action | string | Accepted | åŠ¨ä½œç±»å‹ |
| username | string | user01 | ç”¨æˆ·å |
| ip | string | 192.168.1.10 | IP åœ°å€ |

## Nginx è®¿é—®æ—¥å¿—

| å­—æ®µ | ç±»å‹ | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|------|
| ip | string | 192.168.1.10 | å®¢æˆ·ç«¯ IP |
| user | string | user01 | ç”¨æˆ·å |
| timestamp | string | 22/Jan/2026:10:30:00 | æ—¶é—´ |
| method | string | GET | HTTP æ–¹æ³• |
| path | string | /api/users | è¯·æ±‚è·¯å¾„ |
| protocol | string | HTTP/1.1 | åè®®ç‰ˆæœ¬ |
| status | int | 200 | çŠ¶æ€ç  |
| size | int | 1234 | å“åº”å¤§å° |
```

---

### ä»»åŠ¡ 2ï¼ˆå¿…åšï¼‰ï¼šè®¾è®¡æ—¥å¿—è§„èŒƒ

**ç›®æ ‡**ï¼šä¸ºä½ çš„åº”ç”¨è®¾è®¡ç»Ÿä¸€çš„æ—¥å¿—è§„èŒƒã€‚

**æ­¥éª¤**ï¼š

åˆ›å»º `log_specification.md`ï¼š

```markdown
# æ—¥å¿—è§„èŒƒè‰æ¡ˆ

## æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰äº† [ä½ çš„åº”ç”¨åç§°] çš„æ—¥å¿—è§„èŒƒï¼Œç¡®ä¿æ‰€æœ‰æ—¥å¿—æ ¼å¼ç»Ÿä¸€ã€æ˜“äºåˆ†æã€‚

## é€šç”¨å­—æ®µ

æ‰€æœ‰æ—¥å¿—å¿…é¡»åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|-------|------|------|------|------|
| timestamp | string (ISO 8601) | âœ… | äº‹ä»¶æ—¶é—´ï¼ˆUTCï¼‰| 2026-01-22T10:30:00.123Z |
| level | string | âœ… | æ—¥å¿—çº§åˆ« | DEBUG, INFO, WARNING, ERROR, CRITICAL |
| hostname | string | âœ… | ä¸»æœºå | web-01 |
| service | string | âœ… | æœåŠ¡å | user-service |
| trace_id | string | âš ï¸ | è¿½è¸ª IDï¼ˆå¯é€‰ï¼‰| trace_abc123 |

## HTTP è®¿é—®æ—¥å¿—

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|-------|------|------|------|------|
| event_type | string | âœ… | äº‹ä»¶ç±»å‹ | http_access |
| ip_address | string | âœ… | å®¢æˆ·ç«¯ IP | 192.168.1.10 |
| user_id | string | âš ï¸ | ç”¨æˆ· IDï¼ˆå¦‚å·²è®¤è¯ï¼‰| user001 |
| http.method | string | âœ… | HTTP æ–¹æ³• | GET |
| http.path | string | âœ… | è¯·æ±‚è·¯å¾„ | /api/users |
| http.query_string | string | âš ï¸ | æŸ¥è¯¢å‚æ•° | ?page=1 |
| http.status_code | int | âœ… | HTTP çŠ¶æ€ç  | 200 |
| http.response_size | int | âœ… | å“åº”å¤§å°ï¼ˆå­—èŠ‚ï¼‰| 1234 |
| http.duration_ms | int | âœ… | è¯·æ±‚æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰| 123 |
| context.user_agent | string | âš ï¸ | ç”¨æˆ·ä»£ç† | Mozilla/5.0... |
| context.referer | string | âš ï¸ | æ¥æºé¡µé¢ | https://example.com |

### ç¤ºä¾‹

```json
{
  "timestamp": "2026-01-22T10:30:00.123Z",
  "level": "INFO",
  "hostname": "web-01",
  "service": "user-service",
  "trace_id": "trace_abc123",
  "event_type": "http_access",
  "ip_address": "192.168.1.10",
  "user_id": "user001",
  "http": {
    "method": "GET",
    "path": "/api/users",
    "query_string": "?page=1",
    "status_code": 200,
    "response_size": 1234,
    "duration_ms": 123
  },
  "context": {
    "user_agent": "Mozilla/5.0...",
    "referer": "https://example.com"
  }
}
```

## è®¤è¯æ—¥å¿—

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|-------|------|------|------|------|
| event_type | string | âœ… | äº‹ä»¶ç±»å‹ | login, logout, auth_failed |
| ip_address | string | âœ… | å®¢æˆ·ç«¯ IP | 192.168.1.10 |
| username | string | âš ï¸ | ç”¨æˆ·å | admin |
| status | string | âœ… | çŠ¶æ€ | success, failed |
| failure_reason | string | âš ï¸ | å¤±è´¥åŸå› ï¼ˆå¦‚å¤±è´¥ï¼‰| invalid_password, account_locked |

### ç¤ºä¾‹

```json
{
  "timestamp": "2026-01-22T10:30:00.123Z",
  "level": "INFO",
  "hostname": "web-01",
  "service": "user-service",
  "event_type": "login",
  "ip_address": "192.168.1.10",
  "username": "user001",
  "status": "success"
}
```

## é”™è¯¯æ—¥å¿—

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|-------|------|------|------|------|
| event_type | string | âœ… | äº‹ä»¶ç±»å‹ | error, exception |
| error_code | string | âš ï¸ | é”™è¯¯ä»£ç  | ERR_001 |
| error_message | string | âœ… | é”™è¯¯æ¶ˆæ¯ | Division by zero |
| exception_type | string | âš ï¸ | å¼‚å¸¸ç±»å‹ | ValueError |
| stack_trace | string | âš ï¸ | å †æ ˆä¿¡æ¯ | at line 42... |

### ç¤ºä¾‹

```json
{
  "timestamp": "2026-01-22T10:30:00.123Z",
  "level": "ERROR",
  "hostname": "web-01",
  "service": "user-service",
  "event_type": "error",
  "error_code": "ERR_001",
  "error_message": "Division by zero",
  "exception_type": "ZeroDivisionError",
  "stack_trace": "at line 42..."
}
```
```

---

### ä»»åŠ¡ 3ï¼ˆå¿…åšï¼‰ï¼šæ—¥å¿—æ ‡å‡†åŒ–è„šæœ¬

**ç›®æ ‡**ï¼šç¼–å†™è„šæœ¬ï¼Œå°†ä¸åŒæ¥æºçš„æ—¥å¿—è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼ã€‚

**æ­¥éª¤**ï¼š

åˆ›å»º `log_normalizer.py`ï¼š

```python
#!/usr/bin/env python3
"""
æ—¥å¿—æ ‡å‡†åŒ–è„šæœ¬
å°† Nginx è®¿é—®æ—¥å¿—è½¬æ¢ä¸ºç»Ÿä¸€ JSON æ ¼å¼
"""
import re
import json
import sys
from datetime import datetime


class NginxLogNormalizer:
    """Nginx è®¿é—®æ—¥å¿—æ ‡å‡†åŒ–å™¨"""
    
    # Nginx è®¿é—®æ—¥å¿—æ­£åˆ™
    LOG_PATTERN = re.compile(
        r'(?P<ip>\S+) '
        r'(?P<user>\S+) '
        r'\[(?P<timestamp>[^\]]+)\] '
        r'"(?P<request>[^"]*)" '
        r'(?P<status>\d+) '
        r'(?P<size>\d+) '
        r'"(?P<referer>[^"]*)" '
        r'"(?P<user_agent>[^"]*)"'
    )
    
    def __init__(self, hostname: str = "localhost", service: str = "nginx"):
        self.hostname = hostname
        self.service = service
    
    def parse(self, line: str) -> dict | None:
        """è§£æå•è¡Œ Nginx æ—¥å¿—
        
        Args:
            line: Nginx æ—¥å¿—è¡Œ
            
        Returns:
            æ ‡å‡†åŒ–çš„æ—¥å¿—å­—å…¸
        """
        match = self.LOG_PATTERN.match(line)
        if not match:
            return None
        
        data = match.groupdict()
        
        # è§£æè¯·æ±‚
        request_parts = data['request'].split()
        method = request_parts[0] if len(request_parts) > 0 else "-"
        path = request_parts[1] if len(request_parts) > 1 else "-"
        
        # åˆ†ç¦»è·¯å¾„å’ŒæŸ¥è¯¢å­—ç¬¦ä¸²
        if '?' in path:
            path, query_string = path.split('?', 1)
        else:
            query_string = None
        
        # è½¬æ¢æ—¶é—´æ ¼å¼ï¼ˆNginx â†’ ISO 8601ï¼‰
        try:
            # 22/Jan/2026:10:30:00 +0800 â†’ datetime
            dt = datetime.strptime(data['timestamp'], '%d/%b/%Y:%H:%M:%S %z')
            timestamp = dt.strftime('%Y-%m-%dT%H:%M:%S.%fZ')
        except ValueError:
            timestamp = data['timestamp']
        
        # æ„å»ºæ ‡å‡†åŒ–æ—¥å¿—
        return {
            "timestamp": timestamp,
            "level": "INFO",
            "hostname": self.hostname,
            "service": self.service,
            "event_type": "http_access",
            "ip_address": data['ip'],
            "user_id": data['user'] if data['user'] != '-' else None,
            "http": {
                "method": method,
                "path": path,
                "query_string": query_string,
                "status_code": int(data['status']),
                "response_size": int(data['size']),
                "duration_ms": 0  # Nginx é»˜è®¤ä¸è®°å½•æ—¶é•¿ï¼Œéœ€é…ç½®
            },
            "context": {
                "user_agent": data['user_agent'],
                "referer": data['referer']
            }
        }


def main():
    if len(sys.argv) != 2:
        print("ç”¨æ³•: python log_normalizer.py <nginx_access_log>")
        sys.exit(1)
    
    input_file = sys.argv[1]
    output_file = input_file.replace('.log', '_normalized.jsonl')
    
    normalizer = NginxLogNormalizer(hostname="web-01", service="nginx")
    
    with open(input_file, 'r', encoding='utf-8') as f_in, \
         open(output_file, 'w', encoding='utf-8') as f_out:
        
        count = 0
        for line in f_in:
            line = line.strip()
            if not line:
                continue
            
            normalized = normalizer.parse(line)
            if normalized:
                f_out.write(json.dumps(normalized, ensure_ascii=False) + '\n')
                count += 1
    
    print(f"âœ… å®Œæˆï¼")
    print(f"   è¾“å…¥æ–‡ä»¶: {input_file}")
    print(f"   è¾“å‡ºæ–‡ä»¶: {output_file}")
    print(f"   å¤„ç†è®°å½•: {count} æ¡")


if __name__ == "__main__":
    main()
```

**è¿è¡Œè„šæœ¬**ï¼š

```bash
# è·å– Nginx è®¿é—®æ—¥å¿—ï¼ˆå¦‚æœ‰ï¼‰
sudo tail -100 /var/log/nginx/access.log > /tmp/nginx_sample.log

# æˆ–è€…åˆ›å»ºç¤ºä¾‹æ—¥å¿—
cat > /tmp/nginx_sample.log <<'EOF'
192.168.1.10 - user01 [22/Jan/2026:10:30:00 +0800] "GET /api/users HTTP/1.1" 200 1234 "-" "Mozilla/5.0"
192.168.1.11 - - [22/Jan/2026:10:30:01 +0800] "POST /api/login HTTP/1.1" 401 567 "-" "Mozilla/5.0"
192.168.1.12 - user02 [22/Jan/2026:10:30:02 +0800] "GET /api/data HTTP/1.1" 500 890 "-" "Mozilla/5.0"
EOF

# è¿è¡Œæ ‡å‡†åŒ–è„šæœ¬
python log_normalizer.py /tmp/nginx_sample.log
```

**é¢„æœŸè¾“å‡º**ï¼š

```bash
âœ… å®Œæˆï¼
   è¾“å…¥æ–‡ä»¶: /tmp/nginx_sample.log
   è¾“å‡ºæ–‡ä»¶: /tmp/nginx_sample_normalized.jsonl
   å¤„ç†è®°å½•: 3 æ¡
```

**æŸ¥çœ‹æ ‡å‡†åŒ–åçš„æ—¥å¿—**ï¼š

```bash
cat /tmp/nginx_sample_normalized.jsonl | python -m json.tool | head -30
```

---

### ä»»åŠ¡ 4ï¼ˆè¿›é˜¶ï¼‰ï¼šç”Ÿæˆ CSV æ ¼å¼

**ç›®æ ‡**ï¼šå°†æ ‡å‡†åŒ–åçš„æ—¥å¿—å¯¼å‡ºä¸º CSV æ ¼å¼ã€‚

**åˆ›å»º `log_exporter.py`**ï¼š

```python
#!/usr/bin/env python3
"""
æ—¥å¿—å¯¼å‡ºå™¨
å°† JSONL æ—¥å¿—å¯¼å‡ºä¸º CSV æ ¼å¼
"""
import csv
import json
import sys
from pathlib import Path


def export_to_csv(input_file: str, output_file: str | None = None):
    """å°† JSONL æ—¥å¿—å¯¼å‡ºä¸º CSV
    
    Args:
        input_file: è¾“å…¥ JSONL æ–‡ä»¶
        output_file: è¾“å‡º CSV æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
    """
    if output_file is None:
        output_file = input_file.replace('.jsonl', '.csv')
    
    # è¯»å–æ—¥å¿—å¹¶æå–å­—æ®µ
    records = []
    with open(input_file, 'r', encoding='utf-8') as f:
        for line in f:
            line = line.strip()
            if not line:
                continue
            
            record = json.loads(line)
            records.append(record)
    
    if not records:
        print("âŒ æ— æ•°æ®å¯å¯¼å‡º")
        return
    
    # å±•å¹³åµŒå¥—å­—æ®µ
    flat_records = []
    for record in records:
        flat = {}
        
        # é¡¶å±‚å­—æ®µ
        for key in ['timestamp', 'level', 'hostname', 'service', 'event_type', 'ip_address', 'user_id']:
            flat[key] = record.get(key, '')
        
        # HTTP å­—æ®µ
        http = record.get('http', {})
        for key in ['method', 'path', 'query_string', 'status_code', 'response_size', 'duration_ms']:
            flat[f'http.{key}'] = http.get(key, '')
        
        # ä¸Šä¸‹æ–‡å­—æ®µ
        context = record.get('context', {})
        for key in ['user_agent', 'referer']:
            flat[f'context.{key}'] = context.get(key, '')
        
        flat_records.append(flat)
    
    # å†™å…¥ CSV
    with open(output_file, 'w', encoding='utf-8', newline='') as f:
        fieldnames = list(flat_records[0].keys())
        writer = csv.DictWriter(f, fieldnames=fieldnames)
        writer.writeheader()
        writer.writerows(flat_records)
    
    print(f"âœ… å®Œæˆï¼")
    print(f"   è¾“å…¥æ–‡ä»¶: {input_file}")
    print(f"   è¾“å‡ºæ–‡ä»¶: {output_file}")
    print(f"   å¯¼å‡ºè®°å½•: {len(flat_records)} æ¡")


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("ç”¨æ³•: python log_exporter.py <input.jsonl> [output.csv]")
        sys.exit(1)
    
    input_file = sys.argv[1]
    output_file = sys.argv[2] if len(sys.argv) > 2 else None
    
    export_to_csv(input_file, output_file)
```

**è¿è¡Œå¯¼å‡º**ï¼š

```bash
python log_exporter.py /tmp/nginx_sample_normalized.jsonl /tmp/nginx_sample_normalized.csv
```

**æŸ¥çœ‹ CSV**ï¼š

```bash
cat /tmp/nginx_sample_normalized.csv
```

---

## å·©å›ºç»ƒä¹ ï¼ˆé¢˜ä¸å¤ç›˜ï¼‰

---

### ç»ƒä¹  1ï¼šä¸ºä½•éœ€è¦ç»Ÿä¸€å­—æ®µï¼Ÿ

**æ€è·¯æç¤º**ï¼š

- å­—æ®µä¸ç»Ÿä¸€å¸¦æ¥çš„é—®é¢˜ï¼ˆæœç´¢ã€åˆ†æã€è‡ªåŠ¨åŒ–ï¼‰
- ä¸åŒå›¢é˜Ÿåä½œæ—¶çš„æ²Ÿé€šæˆæœ¬
- æ—¥å¿—èšåˆå’Œåˆ†æå·¥å…·çš„æ•ˆç‡

---

### ç»ƒä¹  2ï¼šè®¾è®¡ä¸€ä»½æ—¥å¿—è§„èŒƒè‰æ¡ˆ

**ä»»åŠ¡**ï¼šä¸ºä»¥ä¸‹åœºæ™¯è®¾è®¡æ—¥å¿—è§„èŒƒã€‚

**åœºæ™¯**ï¼šç”µå•†è®¢å•æœåŠ¡

**è¦æ±‚**ï¼š
1. è®¢å•åˆ›å»ºæ—¥å¿—
2. è®¢å•æ”¯ä»˜æ—¥å¿—
3. è®¢å•å‘è´§æ—¥å¿—
4. é”™è¯¯æ—¥å¿—

**æç¤º**ï¼š
- å¿…é¡»åŒ…å«é€šç”¨å­—æ®µï¼ˆtimestamp, level, hostname, serviceï¼‰
- å¿…é¡»åŒ…å«äº‹ä»¶ç±»å‹ï¼ˆevent_typeï¼‰
- å¿…é¡»åŒ…å«ä¸šåŠ¡ç›¸å…³å­—æ®µï¼ˆorder_id, user_id, amount ç­‰ï¼‰

---

### ç»ƒä¹  3ï¼šæ—¥å¿—æ•æ„Ÿä¿¡æ¯è„±æ•

**ä»»åŠ¡**ï¼šç¼–å†™è„šæœ¬ï¼Œè„±æ•æ—¥å¿—ä¸­çš„æ•æ„Ÿä¿¡æ¯ã€‚

**ç¤ºä¾‹**ï¼š

```python
import re

def sanitize_log(message: str) -> str:
    """è„±æ•æ•æ„Ÿä¿¡æ¯"""
    # è„±æ•å¯†ç 
    message = re.sub(r'password=[^&\s]+', 'password=***', message)
    
    # è„±æ•ä¿¡ç”¨å¡å·
    message = re.sub(r'\b\d{16}\b', '************', message)
    
    # è„±æ•æ‰‹æœºå·
    message = re.sub(r'\b1[3-9]\d{9}\b', '***', message)
    
    return message
```

**ä»»åŠ¡**ï¼š
1. æ‰©å±•è„±æ•è§„åˆ™ï¼ˆé‚®ç®±ã€èº«ä»½è¯ç­‰ï¼‰
2. åº”ç”¨åˆ°æ—¥å¿—æ ‡å‡†åŒ–æµç¨‹

---

### ç»ƒä¹  4ï¼šè®¾è®¡æ—¥å¿—è½®è½¬ç­–ç•¥

**ä»»åŠ¡**ï¼šä¸ºä½ çš„åº”ç”¨è®¾è®¡æ—¥å¿—è½®è½¬ç­–ç•¥ã€‚

**æ€è·¯æç¤º**ï¼š

- æŒ‰æ—¶é—´è½®è½¬ï¼ˆæŒ‰å¤©ã€æŒ‰å°æ—¶ï¼‰
- æŒ‰å¤§å°è½®è½¬ï¼ˆ100MBã€1GBï¼‰
- å‹ç¼©æ—§æ—¥å¿—ï¼ˆgzipï¼‰
- åˆ é™¤è¿‡æœŸæ—¥å¿—ï¼ˆä¿ç•™ 7 å¤©ã€30 å¤©ï¼‰

**ç¤ºä¾‹ï¼ˆlogrotate é…ç½®ï¼‰**ï¼š

```
/var/log/myapp/*.log {
    daily           # æ¯å¤©è½®è½¬
    rotate 7        # ä¿ç•™ 7 ä¸ªæ–‡ä»¶
    compress        # å‹ç¼©æ—§æ—¥å¿—
    delaycompress   # å»¶è¿Ÿå‹ç¼©
    missingok       # æ–‡ä»¶ä¸å­˜åœ¨ä¸æŠ¥é”™
    notifempty      # æ–‡ä»¶ä¸ºç©ºä¸è½®è½¬
    create 0644 www-data www-data  # åˆ›å»ºæ–°æ–‡ä»¶ï¼ŒæŒ‡å®šæƒé™
}
```

---

## è¯„ä¼°æ ‡å‡†ï¼ˆè¾¾æˆåˆ¤å®šï¼‰

- âœ… å®Œæˆäº†æœ¬åœ°æ—¥å¿—åˆ†æï¼Œè¯†åˆ«äº†å…³é”®å­—æ®µ
- âœ… è®¾è®¡äº†æ—¥å¿—è§„èŒƒæ–‡æ¡£ï¼ˆåŒ…å«å­—æ®µå®šä¹‰å’Œç¤ºä¾‹ï¼‰
- âœ… ç¼–å†™äº†æ—¥å¿—æ ‡å‡†åŒ–è„šæœ¬
- âœ… å°†æ ‡å‡†åŒ–æ—¥å¿—å¯¼å‡ºä¸º CSV æ ¼å¼
- âœ… èƒ½è¯´æ˜æ—¥å¿—è§„èŒƒåŒ–çš„å¥½å¤„

---

## å­¦ä¹ æˆæœè¾¾æˆæƒ…å†µï¼ˆç”±å­¦ä¹ è€…å¡«å†™ï¼‰

---

### æˆªå›¾ä¸è¯æ®

- [ ] æœ¬åœ°æ—¥å¿—åˆ†ææˆªå›¾ï¼ˆsyslog, auth.log, nginx.logï¼‰
- [ ] æ—¥å¿—å­—æ®µåˆ†ææ–‡æ¡£ï¼ˆlog_fields_analysis.mdï¼‰
- [ ] æ—¥å¿—è§„èŒƒæ–‡æ¡£ï¼ˆlog_specification.mdï¼‰
- [ ] æ—¥å¿—æ ‡å‡†åŒ–è„šæœ¬ï¼ˆlog_normalizer.pyï¼‰
- [ ] æ ‡å‡†åŒ–åçš„æ—¥å¿—è¾“å‡ºï¼ˆJSONL æ ¼å¼ï¼‰
- [ ] CSV å¯¼å‡ºè„šæœ¬ï¼ˆlog_exporter.pyï¼‰
- [ ] å¯¼å‡ºçš„ CSV æ–‡ä»¶

---

### å…³é”®å‘½ä»¤ä¸è¾“å‡ºï¼ˆç²˜è´´å…³é”®ç‰‡æ®µï¼‰

**æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—**ï¼š

```bash
$ tail -20 /var/log/syslog
Jan 22 10:30:00 server01 systemd[1]: Started nginx.service
Jan 22 10:30:01 server01 sshd[12345]: Accepted password for user01 from 192.168.1.10
```

**æŸ¥çœ‹ Nginx è®¿é—®æ—¥å¿—**ï¼š

```bash
$ tail -10 /var/log/nginx/access.log
192.168.1.10 - user01 [22/Jan/2026:10:30:00 +0800] "GET /api/users HTTP/1.1" 200 1234 "-" "Mozilla/5.0"
```

**è¿è¡Œæ—¥å¿—æ ‡å‡†åŒ–è„šæœ¬**ï¼š

```bash
$ python log_normalizer.py /tmp/nginx_sample.log
âœ… å®Œæˆï¼
   è¾“å…¥æ–‡ä»¶: /tmp/nginx_sample.log
   è¾“å‡ºæ–‡ä»¶: /tmp/nginx_sample_normalized.jsonl
   å¤„ç†è®°å½•: 3 æ¡
```

**æŸ¥çœ‹æ ‡å‡†åŒ–åçš„æ—¥å¿—**ï¼š

```bash
$ cat /tmp/nginx_sample_normalized.jsonl | python -m json.tool
{
  "timestamp": "2026-01-22T02:30:00.000Z",
  "level": "INFO",
  "hostname": "web-01",
  "service": "nginx",
  "event_type": "http_access",
  "ip_address": "192.168.1.10",
  "user_id": "user01",
  "http": {
    "method": "GET",
    "path": "/api/users",
    "query_string": null,
    "status_code": 200,
    "response_size": 1234,
    "duration_ms": 0
  },
  "context": {
    "user_agent": "Mozilla/5.0",
    "referer": "-"
  }
}
```

**å¯¼å‡º CSV æ ¼å¼**ï¼š

```bash
$ python log_exporter.py /tmp/nginx_sample_normalized.jsonl /tmp/nginx_sample_normalized.csv
âœ… å®Œæˆï¼
   è¾“å…¥æ–‡ä»¶: /tmp/nginx_sample_normalized.jsonl
   è¾“å‡ºæ–‡ä»¶: /tmp/nginx_sample_normalized.csv
   å¯¼å‡ºè®°å½•: 3 æ¡
```

---

### ç»“è®ºä¸åæ€

**æˆ‘ä»Šå¤©ææ¸…æ¥šäº†**ï¼š

- ä¸åŒç±»å‹æ—¥å¿—ï¼ˆç³»ç»Ÿã€åº”ç”¨ã€å®‰å…¨ã€è®¿é—®ï¼‰çš„åŒºåˆ«å’Œç”¨é€”
- æ—¥å¿—å…³é”®å­—æ®µï¼ˆtimestamp, hostname, user_id, event_type ç­‰ï¼‰çš„ä½œç”¨
- æ—¥å¿—è§„èŒƒåŒ–å’Œæ ‡å‡†åŒ–çš„é‡è¦æ€§
- å¦‚ä½•ç¼–å†™è„šæœ¬å°†ä¸åŒæ ¼å¼çš„æ—¥å¿—è½¬æ¢ä¸ºç»Ÿä¸€çš„ JSON æ ¼å¼
- å¦‚ä½•å°†ç»“æ„åŒ–æ—¥å¿—å¯¼å‡ºä¸º CSV æ ¼å¼ä¾¿äºåˆ†æ

**æˆ‘å·®ç‚¹ææ··çš„æ˜¯**ï¼š

- æœ€åˆä¸ç†è§£ ISO 8601 æ—¶é—´æ ¼å¼çš„ä¼˜åŠ¿
- æ··æ·†äº†æ—¥å¿—çº§åˆ«ï¼ˆDEBUG/INFO/WARNING/ERRORï¼‰çš„ä½¿ç”¨åœºæ™¯
- ä¸æ¸…æ¥šå­—æ®µæ˜ å°„å’Œç»“æ„åŒ–æ—¥å¿—çš„å…³ç³»

**æ˜å¤©æˆ‘è¦ç»§ç»­è¡¥çš„æ˜¯**ï¼š

- å­¦ä¹ æ—¥å¿—åˆ†æå·¥å…·ï¼ˆElasticsearch/Kibanaã€Splunkï¼‰çš„ä½¿ç”¨ï¼ˆDay030ï¼‰
- äº†è§£æ—¥å¿—å‘Šè­¦è§„åˆ™çš„è®¾è®¡ä¸é…ç½®ï¼ˆDay031ï¼‰
- å­¦ä¹ æ—¥å¿—å­˜å‚¨ä¸æ£€ç´¢ä¼˜åŒ–ï¼ˆDay032ï¼‰

**æœ¬æ¬¡å­¦ä¹ è€—æ—¶**ï¼šçº¦ 3 å°æ—¶

**æŒæ¡ç¨‹åº¦è‡ªè¯„**ï¼š

- [ ] ğŸ˜• ç†è§£äº†åŸºæœ¬æ¦‚å¿µï¼Œä½†å®è·µä¸ç†Ÿç»ƒ
- [ ] ğŸ™‚ å®Œæˆäº†æ—¥å¿—åˆ†æå’Œè§„èŒƒè®¾è®¡
- [ ] ğŸ˜ƒ å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡å¹¶ç†è§£åŸç†
- [ ] ğŸ¤© é¢å¤–æ‰©å±•äº†è„±æ•å’Œè½®è½¬åŠŸèƒ½

---

## é›†ä¸­å‚è€ƒç­”æ¡ˆï¼ˆå«æ€è·¯ï¼‰

---

### ç»ƒä¹  1 å‚è€ƒç­”æ¡ˆï¼šä¸ºä½•éœ€è¦ç»Ÿä¸€å­—æ®µï¼Ÿ

**å­—æ®µä¸ç»Ÿä¸€å¸¦æ¥çš„é—®é¢˜**ï¼š

| é—®é¢˜ç±»å‹ | å…·ä½“è¡¨ç° | å½±å“ |
|---------|---------|------|
| **æ£€ç´¢å›°éš¾** | `user_id`, `userId`, `User_ID` æ··ç”¨ | æœç´¢æ—¶éœ€è¦å°è¯•å¤šç§å­—æ®µåï¼Œæ•ˆç‡ä½ |
| **åˆ†æå¤æ‚** | æ—¶é—´æ ¼å¼ä¸ç»Ÿä¸€ï¼ˆ`2026-01-22` vs `01/22/2026`ï¼‰| éœ€è¦é¢å¤–è½¬æ¢æ‰èƒ½åšæ—¶é—´èŒƒå›´æŸ¥è¯¢ |
| **è‡ªåŠ¨åŒ–å›°éš¾** | å­—æ®µå«ä¹‰ä¸æ˜ç¡® | éœ€è¦äººå·¥å¹²é¢„ï¼Œè‡ªåŠ¨åŒ–è„šæœ¬æ— æ³•é€šç”¨ |
| **åä½œæˆæœ¬é«˜** | ä¸åŒå›¢é˜Ÿä½¿ç”¨ä¸åŒå­—æ®µè§„èŒƒ | æ•°æ®å…±äº«å’Œé›†æˆéœ€è¦é¢å¤–é€‚é…å·¥ä½œ |
| **åˆè§„å®¡è®¡éš¾** | å­—æ®µç¼ºå¤±æˆ–ä¸ä¸€è‡´ | éš¾ä»¥æ»¡è¶³å®¡è®¡å’Œåˆè§„è¦æ±‚ |

**ç»Ÿä¸€å­—æ®µçš„å¥½å¤„**ï¼š

1. **æé«˜æ£€ç´¢æ•ˆç‡**ï¼š
   - å­—æ®µåç»Ÿä¸€ï¼Œä¸€æ¬¡æŸ¥è¯¢å³å¯æ‰¾åˆ°æ‰€æœ‰ç›¸å…³è®°å½•
   - ä¸éœ€è¦å°è¯•å¤šä¸ªå¯èƒ½çš„å­—æ®µå

2. **ç®€åŒ–æ•°æ®åˆ†æ**ï¼š
   - æ—¶é—´æ ¼å¼ç»Ÿä¸€ï¼ˆISO 8601ï¼‰ï¼Œæ—¶é—´èŒƒå›´æŸ¥è¯¢æ›´ç®€å•
   - æ•°æ®ç±»å‹ä¸€è‡´ï¼Œèšåˆç»Ÿè®¡æ›´å®¹æ˜“

3. **ä¾¿äºè‡ªåŠ¨åŒ–**ï¼š
   - æ ‡å‡†åŒ–å­—æ®µï¼Œè‡ªåŠ¨åŒ–è„šæœ¬å¯é€šç”¨
   - å‡å°‘äººå·¥å¹²é¢„ï¼Œæé«˜æ•ˆç‡

4. **é™ä½åä½œæˆæœ¬**ï¼š
   - å›¢é˜Ÿä¹‹é—´æ•°æ®å…±äº«æ— éœ€é¢å¤–é€‚é…
   - æ–°äººå¿«é€Ÿç†è§£æ—¥å¿—ç»“æ„

5. **æ»¡è¶³åˆè§„è¦æ±‚**ï¼š
   - å®¡è®¡æ‰€éœ€å­—æ®µæ˜ç¡®
   - ä¾¿äºç”Ÿæˆåˆè§„æŠ¥å‘Š

**ç¤ºä¾‹ï¼šå­—æ®µä¸ç»Ÿä¸€çš„æ£€ç´¢é—®é¢˜**

```bash
# ä¸ç»Ÿä¸€ï¼šéœ€è¦å°è¯•å¤šç§å­—æ®µå
grep "user001" log1.txt | grep "user_id"
grep "user001" log2.txt | grep "userId"
grep "user001" log3.txt | grep "User_ID"

# ç»Ÿä¸€ï¼šä¸€æ¬¡æŸ¥è¯¢
grep '"user_id": "user001"' standardized_logs.jsonl
```

---

### ç»ƒä¹  2 å‚è€ƒç­”æ¡ˆï¼šè®¾è®¡ä¸€ä»½æ—¥å¿—è§„èŒƒè‰æ¡ˆ

**ç”µå•†è®¢å•æœåŠ¡æ—¥å¿—è§„èŒƒ**ï¼š

```markdown
# ç”µå•†è®¢å•æœåŠ¡æ—¥å¿—è§„èŒƒ

## é€šç”¨å­—æ®µ

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|-------|------|------|------|------|
| timestamp | string (ISO 8601) | âœ… | äº‹ä»¶æ—¶é—´ï¼ˆUTCï¼‰| 2026-01-22T10:30:00.123Z |
| level | string | âœ… | æ—¥å¿—çº§åˆ« | DEBUG, INFO, WARNING, ERROR, CRITICAL |
| hostname | string | âœ… | ä¸»æœºå | order-service-01 |
| service | string | âœ… | æœåŠ¡å | order-service |
| trace_id | string | âš ï¸ | è¿½è¸ª ID | trace_abc123 |
| event_type | string | âœ… | äº‹ä»¶ç±»å‹ | order_created, order_paid, order_shipped |

## è®¢å•åˆ›å»ºæ—¥å¿—

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|-------|------|------|------|------|
| order_id | string | âœ… | è®¢å• ID | ORD-20260122-001 |
| user_id | string | âœ… | ç”¨æˆ· ID | user001 |
| product_id | string | âœ… | äº§å“ ID | PROD-001 |
| quantity | int | âœ… | æ•°é‡ | 2 |
| unit_price | decimal | âœ… | å•ä»· | 99.99 |
| total_amount | decimal | âœ… | æ€»é‡‘é¢ | 199.98 |

### ç¤ºä¾‹

```json
{
  "timestamp": "2026-01-22T10:30:00.123Z",
  "level": "INFO",
  "hostname": "order-service-01",
  "service": "order-service",
  "trace_id": "trace_abc123",
  "event_type": "order_created",
  "order_id": "ORD-20260122-001",
  "user_id": "user001",
  "product_id": "PROD-001",
  "quantity": 2,
  "unit_price": 99.99,
  "total_amount": 199.98
}
```

## è®¢å•æ”¯ä»˜æ—¥å¿—

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|-------|------|------|------|------|
| order_id | string | âœ… | è®¢å• ID | ORD-20260122-001 |
| user_id | string | âœ… | ç”¨æˆ· ID | user001 |
| payment_method | string | âœ… | æ”¯ä»˜æ–¹å¼ | credit_card, wechat_pay, alipay |
| amount | decimal | âœ… | æ”¯ä»˜é‡‘é¢ | 199.98 |
| transaction_id | string | âœ… | äº¤æ˜“ ID | TXN-20260122-001 |
| status | string | âœ… | çŠ¶æ€ | success, failed, pending |
| failure_reason | string | âš ï¸ | å¤±è´¥åŸå› ï¼ˆå¦‚å¤±è´¥ï¼‰| insufficient_balance |

### ç¤ºä¾‹

```json
{
  "timestamp": "2026-01-22T10:30:05.456Z",
  "level": "INFO",
  "hostname": "order-service-01",
  "service": "order-service",
  "trace_id": "trace_abc123",
  "event_type": "order_paid",
  "order_id": "ORD-20260122-001",
  "user_id": "user001",
  "payment_method": "wechat_pay",
  "amount": 199.98,
  "transaction_id": "TXN-20260122-001",
  "status": "success"
}
```

## è®¢å•å‘è´§æ—¥å¿—

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|-------|------|------|------|------|
| order_id | string | âœ… | è®¢å• ID | ORD-20260122-001 |
| user_id | string | âœ… | ç”¨æˆ· ID | user001 |
| shipping_address | object | âœ… | æ”¶è´§åœ°å€ | {"province": "Beijing", "city": "Beijing", ...} |
| shipping_method | string | âœ… | é…é€æ–¹å¼ | standard, express |
| tracking_number | string | âœ… | ç‰©æµå•å· | SF1234567890 |

### ç¤ºä¾‹

```json
{
  "timestamp": "2026-01-22T10:35:00.789Z",
  "level": "INFO",
  "hostname": "order-service-01",
  "service": "order-service",
  "trace_id": "trace_abc123",
  "event_type": "order_shipped",
  "order_id": "ORD-20260122-001",
  "user_id": "user001",
  "shipping_address": {
    "province": "Beijing",
    "city": "Beijing",
    "district": "Chaoyang",
    "address": "xxx Street",
    "postal_code": "100000"
  },
  "shipping_method": "express",
  "tracking_number": "SF1234567890"
}
```

## é”™è¯¯æ—¥å¿—

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|-------|------|------|------|------|
| error_code | string | âš ï¸ | é”™è¯¯ä»£ç  | ORD_ERR_001 |
| error_message | string | âœ… | é”™è¯¯æ¶ˆæ¯ | Inventory insufficient |
| exception_type | string | âš ï¸ | å¼‚å¸¸ç±»å‹ | ValueError |
| stack_trace | string | âš ï¸ | å †æ ˆä¿¡æ¯ | at line 42... |

### ç¤ºä¾‹

```json
{
  "timestamp": "2026-01-22T10:32:00.123Z",
  "level": "ERROR",
  "hostname": "order-service-01",
  "service": "order-service",
  "trace_id": "trace_abc123",
  "event_type": "error",
  "order_id": "ORD-20260122-002",
  "error_code": "ORD_ERR_001",
  "error_message": "Inventory insufficient",
  "exception_type": "ValueError",
  "stack_trace": "at line 42..."
}
```
```

---

### ç»ƒä¹  3 å‚è€ƒç­”æ¡ˆï¼šæ—¥å¿—æ•æ„Ÿä¿¡æ¯è„±æ•

**æ‰©å±•è„±æ•è§„åˆ™**ï¼š

```python
import re

class LogSanitizer:
    """æ—¥å¿—è„±æ•å™¨"""
    
    def __init__(self):
        self.rules = [
            # å¯†ç 
            (r'password=[^&\s]+', 'password=***'),
            # ä¿¡ç”¨å¡å·ï¼ˆ16ä½ï¼‰
            (r'\b\d{16}\b', '************'),
            # æ‰‹æœºå·ï¼ˆä¸­å›½ï¼‰
            (r'\b1[3-9]\d{9}\b', '***'),
            # é‚®ç®±
            (r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b', '***@***.com'),
            # èº«ä»½è¯å·ï¼ˆ18ä½ï¼‰
            (r'\b\d{17}[\dXx]\b', '******************'),
            # API Key
            (r'api[_-]?key\s*=\s*[\w-]{20,}', 'api_key=***'),
            # Token
            (r'token\s*=\s*[\w.-]{20,}', 'token=***'),
        ]
    
    def sanitize(self, message: str) -> str:
        """è„±æ•æ•æ„Ÿä¿¡æ¯
        
        Args:
            message: åŸå§‹æ—¥å¿—æ¶ˆæ¯
            
        Returns:
            è„±æ•åçš„æ—¥å¿—æ¶ˆæ¯
        """
        result = message
        
        for pattern, replacement in self.rules:
            result = re.sub(pattern, replacement, result)
        
        return result


# ä½¿ç”¨ç¤ºä¾‹
sanitizer = LogSanitizer()

original = "user=admin&password=secret123&email=user@example.com"
sanitized = sanitizer.sanitize(original)

print(f"åŸå§‹: {original}")
print(f"è„±æ•: {sanitized}")

# è¾“å‡º:
# åŸå§‹: user=admin&password=secret123&email=user@example.com
# è„±æ•: user=admin&password=***&email=***@***.com
```

**é›†æˆåˆ°æ—¥å¿—æ ‡å‡†åŒ–æµç¨‹**ï¼š

```python
class NginxLogNormalizer:
    """Nginx è®¿é—®æ—¥å¿—æ ‡å‡†åŒ–å™¨ï¼ˆå¸¦è„±æ•ï¼‰"""
    
    def __init__(self, hostname: str = "localhost", service: str = "nginx"):
        self.hostname = hostname
        self.service = service
        self.sanitizer = LogSanitizer()
    
    def parse(self, line: str) -> dict | None:
        """è§£æå•è¡Œ Nginx æ—¥å¿—ï¼ˆå¸¦è„±æ•ï¼‰"""
        match = self.LOG_PATTERN.match(line)
        if not match:
            return None
        
        data = match.groupdict()
        
        # è„±æ•æ•æ„Ÿä¿¡æ¯
        sanitized_user_agent = self.sanitizer.sanitize(data['user_agent'])
        sanitized_referer = self.sanitizer.sanitize(data['referer'])
        
        # ... å…¶ä»–è§£æé€»è¾‘ ...
        
        return {
            # ...
            "context": {
                "user_agent": sanitized_user_agent,
                "referer": sanitized_referer
            }
        }
```

---

### ç»ƒä¹  4 å‚è€ƒç­”æ¡ˆï¼šè®¾è®¡æ—¥å¿—è½®è½¬ç­–ç•¥

**logrotate é…ç½®ç¤ºä¾‹**ï¼š

```
# /etc/logrotate.d/myapp

/var/log/myapp/*.log {
    # è½®è½¬é¢‘ç‡ï¼šæ¯å¤©
    daily
    
    # ä¿ç•™æ–‡ä»¶æ•°ï¼š7 å¤©
    rotate 7
    
    # å‹ç¼©æ—§æ—¥å¿—
    compress
    
    # å»¶è¿Ÿå‹ç¼©ï¼ˆæœ€æ–°çš„ä¸å‹ç¼©ï¼‰
    delaycompress
    
    # æ–‡ä»¶ä¸å­˜åœ¨ä¸æŠ¥é”™
    missingok
    
    # æ–‡ä»¶ä¸ºç©ºä¸è½®è½¬
    notifempty
    
    # è½®è½¬ååˆ›å»ºæ–°æ–‡ä»¶
    # æ ¼å¼: [path] [owner] [group] [mode]
    create 0644 www-data www-data
    
    # è½®è½¬åæ‰§è¡Œè„šæœ¬
    postrotate
        # é€šçŸ¥åº”ç”¨é‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶
        systemctl reload myapp > /dev/null 2>&1 || true
    endscript
}

/var/log/myapp/access.log {
    # æŒ‰å¤§å°è½®è½¬ï¼ˆ100MBï¼‰
    size 100M
    
    # ä¿ç•™ 5 ä¸ªæ–‡ä»¶
    rotate 5
    
    # å‹ç¼©
    compress
    
    delaycompress
    missingok
    notifempty
    create 0644 www-data www-data
}
```

**è½®è½¬ç­–ç•¥å¯¹æ¯”**ï¼š

| ç­–ç•¥ç±»å‹ | é…ç½®é¡¹ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|-------|------|------|---------|
| **æŒ‰æ—¶é—´** | `daily`, `weekly`, `monthly` | ç®€å•ã€æ˜“äºç†è§£ | æ–‡ä»¶å¤§å°ä¸å›ºå®š | æ—¥å¿—é‡ç¨³å®šçš„ç³»ç»Ÿ |
| **æŒ‰å¤§å°** | `size 100M` | æ§åˆ¶å•ä¸ªæ–‡ä»¶å¤§å° | è½®è½¬é¢‘ç‡ä¸ç¡®å®š | æ—¥å¿—é‡æ³¢åŠ¨å¤§çš„ç³»ç»Ÿ |
| **æ··åˆ** | `daily` + `maxsize` | å…¼é¡¾æ—¶é—´å’Œå¤§å° | é…ç½®å¤æ‚ | éœ€è¦ç²¾ç»†æ§åˆ¶çš„åœºæ™¯ |

**Python è½®è½¬è„šæœ¬ç¤ºä¾‹**ï¼š

```python
#!/usr/bin/env python3
"""
æ—¥å¿—è½®è½¬è„šæœ¬
"""
import os
import gzip
import shutil
from pathlib import Path
from datetime import datetime, timedelta


def rotate_log(log_file: Path, max_files: int = 7, max_size_mb: int = 100):
    """è½®è½¬æ—¥å¿—æ–‡ä»¶
    
    Args:
        log_file: æ—¥å¿—æ–‡ä»¶è·¯å¾„
        max_files: ä¿ç•™çš„æœ€å¤§æ–‡ä»¶æ•°
        max_size_mb: æœ€å¤§æ–‡ä»¶å¤§å°ï¼ˆMBï¼‰ï¼Œè¶…è¿‡åˆ™ç«‹å³è½®è½¬
    """
    if not log_file.exists():
        return
    
    # æ£€æŸ¥æ–‡ä»¶å¤§å°
    file_size_mb = log_file.stat().st_size / (1024 * 1024)
    if file_size_mb < max_size_mb:
        return
    
    # ç”Ÿæˆè½®è½¬æ–‡ä»¶å
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    rotated_file = log_file.parent / f"{log_file.name}.{timestamp}"
    
    # ç§»åŠ¨æ–‡ä»¶
    shutil.move(str(log_file), str(rotated_file))
    print(f"âœ… è½®è½¬: {log_file.name} â†’ {rotated_file.name}")
    
    # å‹ç¼©æ—§æ–‡ä»¶
    compressed_file = rotated_file.with_suffix(f"{rotated_file.suffix}.gz")
    with open(rotated_file, 'rb') as f_in:
        with gzip.open(compressed_file, 'wb') as f_out:
            shutil.copyfileobj(f_in, f_out)
    os.remove(rotated_file)
    print(f"âœ… å‹ç¼©: {rotated_file.name} â†’ {compressed_file.name}")
    
    # æ¸…ç†è¿‡æœŸæ–‡ä»¶
    clean_old_logs(log_file.parent, log_file.name, max_files)


def clean_old_logs(directory: Path, base_name: str, max_files: int):
    """æ¸…ç†è¿‡æœŸæ—¥å¿—æ–‡ä»¶
    
    Args:
        directory: æ—¥å¿—ç›®å½•
        base_name: åŸºç¡€æ–‡ä»¶å
        max_files: ä¿ç•™çš„æœ€å¤§æ–‡ä»¶æ•°
    """
    # è·å–æ‰€æœ‰ç›¸å…³æ–‡ä»¶ï¼ˆåŒ…æ‹¬å‹ç¼©æ–‡ä»¶ï¼‰
    files = []
    for pattern in [f"{base_name}.*.log*", f"{base_name}.log*.gz"]:
        files.extend(directory.glob(pattern))
    
    # æŒ‰ä¿®æ”¹æ—¶é—´æ’åºï¼ˆä»æ—§åˆ°æ–°ï¼‰
    files.sort(key=lambda f: f.stat().st_mtime)
    
    # åˆ é™¤è¶…å‡ºæ•°é‡çš„æ–‡ä»¶
    if len(files) > max_files:
        for f in files[:-max_files]:
            f.unlink()
            print(f"âœ… åˆ é™¤è¿‡æœŸæ–‡ä»¶: {f.name}")


def main():
    log_dir = Path("/var/log/myapp")
    log_files = ["access.log", "error.log", "app.log"]
    
    for log_file in log_files:
        full_path = log_dir / log_file
        rotate_log(full_path, max_files=7, max_size_mb=100)


if __name__ == "__main__":
    main()
```

---

## å­¦ä¹ æˆæœç¤ºä¾‹å¡«å†™ï¼ˆå¯ç…§æŠ„ï¼‰

> å¯å°†"ç¤ºä¾‹"å†…å®¹æ›¿æ¢ä¸ºä½ è‡ªå·±çš„æ—¶é—´ä¸æˆªå›¾æ–‡ä»¶åã€‚

---

### æˆªå›¾ä¸è¯æ®ï¼ˆç¤ºä¾‹ï¼‰

- æ—¥å¿—åˆ†æï¼š`images/day029_log_analysis.png`
- è§„èŒƒæ–‡æ¡£ï¼š`log_specification.md`
- æ ‡å‡†åŒ–è„šæœ¬ï¼š`log_normalizer.py`
- æ ‡å‡†åŒ–è¾“å‡ºï¼š`images/day029_normalized_logs.png`
- CSV å¯¼å‡ºï¼š`images/day029_csv_export.png`

---

### å…³é”®å‘½ä»¤ä¸è¾“å‡ºï¼ˆç¤ºä¾‹ï¼‰

**æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—**ï¼š

```bash
$ tail -20 /var/log/syslog
Jan 22 10:30:00 server01 systemd[1]: Started nginx.service
```

**è¿è¡Œæ—¥å¿—æ ‡å‡†åŒ–**ï¼š

```bash
$ python log_normalizer.py /tmp/nginx_sample.log
âœ… å®Œæˆï¼
   å¤„ç†è®°å½•: 3 æ¡
```

**æŸ¥çœ‹æ ‡å‡†åŒ–æ—¥å¿—**ï¼š

```json
{
  "timestamp": "2026-01-22T10:30:00.000Z",
  "level": "INFO",
  "event_type": "http_access",
  "ip_address": "192.168.1.10",
  "http": {
    "method": "GET",
    "status_code": 200
  }
}
```

---

### ç»“è®ºä¸åæ€ï¼ˆç¤ºä¾‹ï¼‰

**æˆ‘ä»Šå¤©ææ¸…æ¥šäº†**ï¼š

- ä¸åŒç±»å‹æ—¥å¿—ï¼ˆç³»ç»Ÿã€åº”ç”¨ã€å®‰å…¨ã€è®¿é—®ï¼‰çš„åŒºåˆ«å’Œç”¨é€”
- æ—¥å¿—å…³é”®å­—æ®µçš„ä½œç”¨å’Œé‡è¦æ€§
- æ—¥å¿—è§„èŒƒåŒ–å’Œæ ‡å‡†åŒ–çš„å¥½å¤„
- å¦‚ä½•ç¼–å†™è„šæœ¬å°†ä¸åŒæ ¼å¼æ—¥å¿—è½¬æ¢ä¸ºç»Ÿä¸€ JSON æ ¼å¼
- æ•æ„Ÿä¿¡æ¯è„±æ•å’Œæ—¥å¿—è½®è½¬çš„é‡è¦æ€§

**æˆ‘å·®ç‚¹ææ··çš„æ˜¯**ï¼š

- æœ€åˆä¸ç†è§£ ISO 8601 æ—¶é—´æ ¼å¼çš„ä¼˜åŠ¿
- æ··æ·†äº†æ—¥å¿—çº§åˆ«çš„ä½¿ç”¨åœºæ™¯
- ä¸æ¸…æ¥šç»“æ„åŒ–æ—¥å¿—å’Œå­—æ®µæ˜ å°„çš„å…³ç³»

**æ˜å¤©æˆ‘è¦ç»§ç»­è¡¥çš„æ˜¯**ï¼š

- å­¦ä¹  Elasticsearch/Kibana çš„ä½¿ç”¨ï¼ˆDay030ï¼‰
- äº†è§£æ—¥å¿—å‘Šè­¦è§„åˆ™è®¾è®¡ï¼ˆDay031ï¼‰

**æœ¬æ¬¡å­¦ä¹ è€—æ—¶**ï¼šçº¦ 3 å°æ—¶

**æŒæ¡ç¨‹åº¦è‡ªè¯„**ï¼š

- [x] ğŸ˜ƒ å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡å¹¶ç†è§£åŸç†
