# Day013ï¼šå®‰å…¨åè®®ä¸åŠ å¯† - åŠ å¯†åº”ç”¨ä¸åœºæ™¯

- æ—¥æœŸï¼š2026-01-06
- å‘¨æ¬¡ï¼šç¬¬ 2 å‘¨

## å­¦ä¹ ç›®æ ‡

å­¦å®Œä»Šå¤©ä½ åº”è¯¥èƒ½åšåˆ°ï¼š

- èƒ½æŠŠ"åŠ å¯†"åˆ†æˆ 3 ç±»åœºæ™¯ï¼š**ä¼ è¾“ä¸­**ã€**å­˜å‚¨ä¸­**ã€**è®¤è¯/ç­¾å**
- èƒ½è¯†åˆ« 5 ä¸ªå¸¸è§é”™è¯¯ï¼š
  - æ˜æ–‡å­˜å¯†ç 
  - å¯é€†åŠ å¯†å­˜å¯†ç 
  - æ²¡ç›ï¼ˆsaltï¼‰
  - è¿­ä»£å¤ªä½/ç”¨å¿«å“ˆå¸Œï¼ˆå¦‚ SHA-256ï¼‰ç›´æ¥å­˜å¯†ç 
  - å¯†é’¥ç¡¬ç¼–ç /é•¿æœŸä¸è½®æ¢
- èƒ½è¾“å‡ºä¸€å¼ ä½ è‡ªå·±çš„"åº”ç”¨åŠ å¯†æ£€æŸ¥æ¸…å•"ï¼ˆç…§ç€æŠ„ä¹Ÿè¡Œï¼‰
- èƒ½ç”¨ Python æ¼”ç¤º"å¿«å“ˆå¸Œ vs æ…¢ KDF"çš„æ€§èƒ½å·®å¼‚
- èƒ½å†™å‡ºä¸€ä»½å®Œæ•´çš„å¯†ç å­˜å‚¨è®¾è®¡æ–‡æ¡£

## å­¦ä¹ å†…å®¹

### 1ï¸âƒ£ ä¼ è¾“ä¸­åŠ å¯†ï¼ˆIn Transitï¼‰ï¼šä½ æœ€å¸¸è§çœ‹åˆ°çš„ TLS/HTTPS

**æ ¸å¿ƒåŸç†ï¼ˆ1 å¥è¯ï¼‰**ï¼šç”¨åŠ å¯†ä¿æŠ¤"æ•°æ®åœ¨ç½‘ç»œä¸Šé£"çš„è¿‡ç¨‹ã€‚

#### ä½ å…³æ³¨ 3 ç‚¹å°±å¤Ÿï¼š

**A. æ˜¯å¦åŠ å¯†ï¼ˆæ˜¯ä¸æ˜¯ HTTPSï¼‰**

- çœ‹åœ°å€æ ï¼š`https://` å¼€å¤´ + å°é”å›¾æ ‡ ğŸ”’
- æŠ“åŒ…çœ‹ï¼šWireshark æ˜¾ç¤º `TLS` è€Œä¸æ˜¯æ˜æ–‡ `HTTP`
- Chrome å¼€å‘è€…å·¥å…·ï¼šNetwork â†’ Protocol åˆ—æ˜¾ç¤º `h2`ï¼ˆHTTP/2 over TLSï¼‰

**B. æ˜¯å¦éªŒè¯èº«ä»½ï¼ˆè¯ä¹¦å¯ä¿¡å—ï¼‰**

æ£€æŸ¥è¯ä¹¦çš„ 4 ä¸ªè¦ç´ ï¼š

| æ£€æŸ¥é¡¹ | æ€ä¹ˆçœ‹ | åˆæ ¼æ ‡å‡† |
|--------|--------|----------|
| åŸŸååŒ¹é… | ç‚¹å°é” â†’ è¯ä¹¦è¯¦æƒ… â†’ "é¢å‘ç»™" | ä¸è®¿é—®çš„åŸŸåä¸€è‡´ |
| æœ‰æ•ˆæœŸ | è¯ä¹¦è¯¦æƒ… â†’ "æœ‰æ•ˆæœŸè‡ª...è‡³..." | å½“å‰æ—¥æœŸåœ¨æœ‰æ•ˆæœŸå†… |
| è¯ä¹¦é“¾ | è¯ä¹¦è¯¦æƒ… â†’ "è¯ä¹¦è·¯å¾„" | Root CA â†’ Intermediate CA â†’ ç½‘ç«™è¯ä¹¦ |
| å—ä¿¡ä»» | æµè§ˆå™¨æ— çº¢è‰²è­¦å‘Š | æ ¹è¯ä¹¦åœ¨æ“ä½œç³»ç»Ÿä¿¡ä»»åˆ—è¡¨ä¸­ |

**C. æ˜¯å¦èƒ½è¢«é™çº§/è¯¯ç”¨**

| é£é™©ç±»å‹ | è¡¨ç° | å±å®³ | æ£€æµ‹æ–¹æ³• |
|----------|------|------|----------|
| æ··åˆå†…å®¹ï¼ˆMixed Contentï¼‰ | HTTPS é¡µé¢åŠ è½½ HTTP èµ„æºï¼ˆå›¾ç‰‡/JS/CSSï¼‰ | éƒ¨åˆ†èµ„æºå¯èƒ½è¢«åŠ«æŒ | æµè§ˆå™¨ F12 æ§åˆ¶å°é»„è‰²/çº¢è‰²è­¦å‘Š |
| è€ TLS ç‰ˆæœ¬ | ä½¿ç”¨ TLS 1.0/1.1 | å®¹æ˜“è¢«æ”»å‡»ï¼ˆå¦‚ BEASTã€POODLEï¼‰ | `curl -v` æŸ¥çœ‹ TLS version |
| è¯ä¹¦å›ºå®šå¤±æ•ˆ | APP ä¸éªŒè¯è¯ä¹¦é“¾ | ä¸­é—´äººæ”»å‡» | æŠ“åŒ…å·¥å…·èƒ½è§£å¯† HTTPS |
| HTTP è‡ªåŠ¨è·³è½¬å¤±è´¥ | è¾“å…¥ `http://` ä¸è·³è½¬åˆ° `https://` | é¦–æ¬¡è®¿é—®è¢«åŠ«æŒ | æ‰‹åŠ¨æµ‹è¯• `curl -I http://site` |

#### å¸¸è§å‘ï¼ˆä½ è¦ä¼šè¯†åˆ«ï¼‰

| å‘ | åæœ | æ€ä¹ˆå‘ç° | å¦‚ä½•ä¿®å¤ |
|----|------|----------|----------|
| è¯ä¹¦è¿‡æœŸ | æµè§ˆå™¨æ‹’ç»è®¿é—®ï¼ˆNET::ERR_CERT_DATE_INVALIDï¼‰ | ç‚¹å°é”çœ‹æœ‰æ•ˆæœŸ | ç»­æœŸè¯ä¹¦ï¼ˆLet's Encrypt å¯å…è´¹è‡ªåŠ¨ç»­æœŸï¼‰ |
| è‡ªç­¾åè¯ä¹¦ | æµè§ˆå™¨è­¦å‘Š"ä¸å®‰å…¨" | è¯ä¹¦é“¾ä¸­æ‰¾ä¸åˆ°å—ä¿¡ä»»çš„æ ¹ CA | ç”¨å—ä¿¡ä»» CA ç­¾å‘è¯ä¹¦æˆ–å°†æ ¹è¯ä¹¦åŠ å…¥ä¿¡ä»»åˆ—è¡¨ |
| åŸŸåä¸åŒ¹é… | ä¸­é—´äººæ”»å‡»é£é™© | è¯ä¹¦é¢å‘ç»™ `example.com` ä½†è®¿é—® `test.com` | ç”³è¯·å¤šåŸŸåè¯ä¹¦ï¼ˆSANï¼‰æˆ–é€šé…ç¬¦è¯ä¹¦ |
| æ··åˆå†…å®¹ | éƒ¨åˆ†èµ„æºæœªåŠ å¯†ï¼Œå¯èƒ½è¢«åŠ«æŒ | æµè§ˆå™¨ F12 æ§åˆ¶å°æœ‰é»„è‰²/çº¢è‰²è­¦å‘Š | æ‰€æœ‰èµ„æºæ”¹ç”¨ HTTPS æˆ–ç›¸å¯¹åè®® `//cdn.example.com/style.css` |

### 2ï¸âƒ£ å­˜å‚¨ä¸­åŠ å¯†ï¼ˆAt Restï¼‰ï¼šç›˜ä¸Š/åº“é‡Œçš„ä¸€åˆ‡

**æ ¸å¿ƒåŸç†ï¼ˆ1 å¥è¯ï¼‰**ï¼šæ•°æ®å­˜åœ¨ç¡¬ç›˜/æ•°æ®åº“æ—¶ä¹Ÿè¦ä¿æŠ¤ï¼Œé˜²æ­¢ç‰©ç†å¤±çªƒ/å¤‡ä»½æ³„éœ²ã€‚

#### è¿™é‡Œå®¹æ˜“çŠ¯çš„é”™ï¼ˆæ–°æ‰‹å¸¸è§ï¼‰

| é”™è¯¯åšæ³• | ä¸ºä»€ä¹ˆä¸è¡Œ | æ­£ç¡®åšæ³• |
|----------|------------|----------|
| âŒ æ˜æ–‡å­˜å¯†ç  | æ•°æ®åº“æ³„éœ² = å¯†ç ç›´æ¥æ›å…‰ | ç”¨ KDF å“ˆå¸Œ + salt |
| âŒ MD5/SHA-256 å­˜å¯†ç  | å¤ªå¿«ï¼ŒGPU æ¯ç§’å¯å°è¯•æ•°åäº¿æ¬¡ | ç”¨ bcrypt/Argon2/scrypt/PBKDF2 |
| âŒ AES åŠ å¯†å­˜å¯†ç  | å¯†é’¥æ³„éœ²å°±èƒ½æ‰¹é‡è§£å¯† | å¯†ç ä¸éœ€è¦å¯é€†ï¼Œç”¨å“ˆå¸Œä¸ç”¨åŠ å¯† |
| âŒ ç»Ÿä¸€ salt | é‡å¤å¯†ç ä¼šæš´éœ²ï¼ˆç›¸åŒ hashï¼‰ | æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹éšæœº salt |
| âŒ è¿­ä»£æ¬¡æ•°å¤ªä½ | çˆ†ç ´æˆæœ¬å¤ªä½ | PBKDF2 â‰¥ 200,000 æ¬¡ï¼Œbcrypt work_factor â‰¥ 10 |

#### æ­£ç¡®æ–¹å‘ï¼ˆåˆ†ä¸¤ç±»æ•°æ®ï¼‰

##### A. å¯†ç å­˜å‚¨ï¼ˆä¸å¯é€†ï¼Œåªèƒ½éªŒè¯ï¼‰

ç”¨ **KDF**ï¼ˆKey Derivation Functionï¼Œå¯†é’¥æ´¾ç”Ÿå‡½æ•°ï¼‰è€Œä¸æ˜¯æ™®é€šå“ˆå¸Œï¼š

| KDF ç®—æ³• | ç‰¹ç‚¹ | æ¨èæŒ‡æ•° | æˆæœ¬å‚æ•° | Python åº“ |
|----------|------|----------|----------|-----------|
| **Argon2** | 2015 å¹´å¯†ç å“ˆå¸Œç«èµ›å† å†›ï¼ŒæŠ— GPU/ASICï¼Œå†…å­˜å›°éš¾ | â­â­â­â­â­ | `memory_cost=65536`, `time_cost=3`, `parallelism=4` | `argon2-cffi` |
| **scrypt** | å†…å­˜å›°éš¾ï¼Œè¾ƒè€ä½†ä»å®‰å…¨ | â­â­â­â­ | `N=2^14`, `r=8`, `p=1` | `hashlib.scrypt` (Python 3.6+) |
| **bcrypt** | å·¥ä¸šæ ‡å‡†ï¼Œå¹¿æ³›æ”¯æŒï¼ŒBlowfish å˜ç§ | â­â­â­â­ | `work_factor=10~12`ï¼ˆæ¯å¢åŠ  1ï¼Œæ…¢ 2 å€ï¼‰ | `bcrypt` |
| **PBKDF2** | æ ‡å‡†åº“è‡ªå¸¦ï¼Œæœ€åŸºç¡€ï¼ŒNIST æ¨è | â­â­â­ | `iterations=200,000~600,000` | `hashlib.pbkdf2_hmac` |

**ä¸ºä»€ä¹ˆè¦ KDFï¼Ÿï¼ˆç”¨å¯¹æ¯”è¯´æ˜ï¼‰**

| å¯¹æ¯”é¡¹ | SHA-256ï¼ˆå¿«å“ˆå¸Œï¼‰ | bcryptï¼ˆKDFï¼‰ |
|--------|-------------------|---------------|
| å•æ¬¡è®¡ç®—æ—¶é—´ | 0.001 ms | 100-300 ms |
| GPU æ¯ç§’å°è¯•æ¬¡æ•° | æ•°åäº¿æ¬¡ | æ•°åƒæ¬¡ |
| 8 å­—ç¬¦å¯†ç çˆ†ç ´æ—¶é—´ | å‡ å°æ—¶ | æ•°ç™¾å¹´ |
| æ˜¯å¦éœ€è¦ salt | å¯é€‰ï¼ˆä½†å¿…é¡»ï¼‰ | å†…ç½® salt æœºåˆ¶ |
| èƒ½å¦è°ƒèŠ‚éš¾åº¦ | ä¸èƒ½ | å¯ä»¥ï¼ˆéšç¡¬ä»¶å‡çº§å¢åŠ æˆæœ¬ï¼‰ |

**bcrypt å­˜å‚¨æ ¼å¼è¯¦è§£**ï¼ˆä»¥ bcrypt ä¸ºä¾‹ï¼‰ï¼š

```text
$2b$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p/.CPY.tHOHEa2xFH0p3.O
 â”‚  â”‚  â”‚                                               â”‚
 â”‚  â”‚  â””â”€ saltï¼ˆ22 å­—ç¬¦ Base64ï¼‰                       â””â”€ hashï¼ˆ31 å­—ç¬¦ Base64ï¼‰
 â”‚  â””â”€ work_factorï¼ˆæˆæœ¬å‚æ•°ï¼Œ10 è¡¨ç¤º 2^10=1024 è½®è¿­ä»£ï¼‰
 â””â”€ ç®—æ³•ç‰ˆæœ¬ï¼ˆ2b è¡¨ç¤º bcrypt æ–°ç‰ˆæœ¬ï¼‰
```

**å…³é”®ç‰¹æ€§**ï¼š

- **æ…¢æ˜¯ç‰¹æ€§ï¼Œä¸æ˜¯ç¼ºé™·**ï¼šå•æ¬¡éªŒè¯ 100-300ms å¯¹ç”¨æˆ·æ— æ„Ÿï¼Œä½†è®©æ”»å‡»è€…çˆ†ç ´æˆæœ¬æŒ‡æ•°çº§ä¸Šå‡
- **æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ salt**ï¼šé˜²æ­¢å½©è™¹è¡¨æ”»å‡»ï¼Œå³ä½¿ä¸¤ä¸ªç”¨æˆ·å¯†ç ç›¸åŒï¼Œhash ä¹Ÿä¸åŒ
- **å¯è°ƒèŠ‚æˆæœ¬**ï¼šéšç€ç¡¬ä»¶æ€§èƒ½æå‡ï¼Œå¯ä»¥å¢åŠ  work_factorï¼ˆå¦‚ä» 10 æåˆ° 12ï¼‰

##### B. æ•æ„Ÿæ•°æ®ï¼ˆéå¯†ç ï¼Œéœ€å¯é€†ï¼‰

æ¯”å¦‚èº«ä»½è¯å·ã€é“¶è¡Œå¡ã€å¥åº·è®°å½•ã€API å¯†é’¥ç­‰ï¼š

**ç®—æ³•é€‰æ‹©**ï¼š

| ç®—æ³• | ç‰¹ç‚¹ | æ¨èåœºæ™¯ |
|------|------|----------|
| **AES-256-GCM** | è®¤è¯åŠ å¯†ï¼ˆAEADï¼‰ï¼Œæ—¢ä¿å¯†åˆé˜²ç¯¡æ”¹ | æ•°æ®åº“å­—æ®µåŠ å¯†ã€æ–‡ä»¶åŠ å¯† |
| **ChaCha20-Poly1305** | è½¯ä»¶å®ç°æ›´å¿«ï¼Œç§»åŠ¨ç«¯å‹å¥½ | ç§»åŠ¨ APPã€ç‰©è”ç½‘è®¾å¤‡ |
| AES-256-CBC + HMAC | ä¼ ç»Ÿæ–¹æ¡ˆï¼Œéœ€æ‰‹åŠ¨åš MAC | è€ç³»ç»Ÿå…¼å®¹ |

**å¯†é’¥ç®¡ç†å±‚çº§**ï¼ˆä»ä½åˆ°é«˜ï¼‰ï¼š

| å±‚çº§ | åšæ³• | é£é™© | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| âŒ ç¡¬ç¼–ç  | å¯†é’¥å†™åœ¨ä»£ç é‡Œ | ä»£ç æ³„éœ² = å¯†é’¥æ³„éœ² | **ç¦æ­¢ä½¿ç”¨** |
| âš ï¸ ç¯å¢ƒå˜é‡ | `os.environ['SECRET_KEY']` | è¿›ç¨‹ä¿¡æ¯å¯èƒ½æ³„éœ²ï¼Œæ—¥å¿—å¯èƒ½æ‰“å° | ä¸ªäººé¡¹ç›®/å­¦ä¹  |
| âœ… é…ç½®ä¸­å¿ƒ | Consul/Vault/etcd | éœ€è¦é¢å¤–ç»´æŠ¤é…ç½®ä¸­å¿ƒ | ä¸­å°å›¢é˜Ÿ |
| âœ…âœ… äº‘ KMS | AWS KMS/Azure Key Vault/GCP KMS | ä¾èµ–äº‘æœåŠ¡å•† | ä¼ä¸šç”Ÿäº§ç¯å¢ƒ |
| âœ…âœ…âœ… HSM | ç¡¬ä»¶å®‰å…¨æ¨¡å—ï¼ˆFIPS 140-2 è®¤è¯ï¼‰ | æˆæœ¬é«˜ï¼Œæ“ä½œå¤æ‚ | é‡‘è/æ”¯ä»˜/æ”¿åºœ |

**IV/Nonce å¤„ç†è§„åˆ™**ï¼š

- **å¿…é¡»éšæœº**ï¼šæ¯æ¬¡åŠ å¯†ç”¨æ–°çš„éšæœº IVï¼ˆ`os.urandom(16)`ï¼‰
- **å¯ä»¥å…¬å¼€**ï¼šIV ä¸æ˜¯å¯†é’¥ï¼Œå¯ä»¥å’Œå¯†æ–‡ä¸€èµ·å­˜å‚¨ï¼ˆå¦‚ `IV || Ciphertext`ï¼‰
- **ä¸èƒ½é‡å¤**ï¼šåŒä¸€å¯†é’¥ä¸‹ IV é‡å¤ä¼šæ³„éœ²æ˜æ–‡æ¨¡å¼ï¼ˆå°¤å…¶ AES-CTR/GCMï¼‰

**å­˜å‚¨æ ¼å¼ç¤ºä¾‹**ï¼ˆJSON å½¢å¼ï¼‰ï¼š

```json
{
  "algorithm": "AES-256-GCM",
  "iv": "a1b2c3d4e5f6...",  // Base64 ç¼–ç çš„ IV
  "ciphertext": "9f8e7d6c5b4a...",  // Base64 ç¼–ç çš„å¯†æ–‡
  "tag": "1a2b3c4d...",  // GCM æ¨¡å¼çš„è®¤è¯æ ‡ç­¾
  "key_version": "v2"  // å¯†é’¥ç‰ˆæœ¬ï¼Œä¾¿äºè½®æ¢
}
```

### 3ï¸âƒ£ è®¤è¯/ç­¾åï¼šä½ åœ¨ APIã€ç™»å½•ã€è¯ä¹¦é‡Œéƒ½èƒ½é‡åˆ°

**æ ¸å¿ƒåŸç†ï¼ˆ1 å¥è¯ï¼‰**ï¼šè¯æ˜"æ¶ˆæ¯æ˜¯è°å‘çš„"+"æœ‰æ²¡æœ‰è¢«æ”¹è¿‡"ã€‚

#### å¸¸è§åœºæ™¯å¯¹æ¯”

| åœºæ™¯ | ç”¨ä»€ä¹ˆ | ç›®çš„ | ç¤ºä¾‹ | éªŒè¯æ–¹ |
|------|--------|------|------|--------|
| **API è¯·æ±‚ç­¾å** | HMAC-SHA256 | é˜²æ­¢è¯·æ±‚è¢«ç¯¡æ”¹/é‡æ”¾ | AWS Signature V4, å¾®ä¿¡æ”¯ä»˜ç­¾å | æœåŠ¡ç«¯ï¼ˆæŒæœ‰ç›¸åŒå¯†é’¥ï¼‰ |
| **JWT ä»¤ç‰Œ** | HS256(HMAC) æˆ– RS256(RSA) | æ— çŠ¶æ€è®¤è¯ | ç”¨æˆ·ç™»å½•åç”Ÿæˆ JWTï¼Œåç»­è¯·æ±‚å¸¦ä¸Š | ä»»ä½•æœåŠ¡ï¼ˆHS256 éœ€å¯†é’¥ï¼ŒRS256 éœ€å…¬é’¥ï¼‰ |
| **TLS è¯ä¹¦** | RSA/ECDSA ç­¾å | è¯æ˜å…¬é’¥å½’å± | CA ç”¨ç§é’¥ç­¾åç½‘ç«™çš„å…¬é’¥ | æµè§ˆå™¨/æ“ä½œç³»ç»Ÿï¼ˆæŒæœ‰ CA å…¬é’¥ï¼‰ |
| **Git æäº¤** | GPG ç­¾åï¼ˆRSA/ECDSAï¼‰ | è¯æ˜æäº¤è€…èº«ä»½ | `git commit -S` | GitHub/GitLabï¼ˆå¯¼å…¥çš„ GPG å…¬é’¥ï¼‰ |
| **ä»£ç ç­¾å** | Authenticodeï¼ˆWindowsï¼‰/Codesignï¼ˆmacOSï¼‰ | è¯æ˜è½¯ä»¶æ¥æº | é©±åŠ¨ç¨‹åºã€å®‰è£…åŒ… | æ“ä½œç³»ç»Ÿï¼ˆéªŒè¯è¯ä¹¦é“¾ï¼‰ |

#### HMAC vs æ•°å­—ç­¾åï¼ˆå…³é”®åŒºåˆ«ï¼‰

| å¯¹æ¯”é¡¹ | HMAC | æ•°å­—ç­¾åï¼ˆRSA/ECDSAï¼‰ |
|--------|------|----------------------|
| **å¯†é’¥ç±»å‹** | å¯¹ç§°ï¼ˆå…±äº«å¯†é’¥ï¼‰ | éå¯¹ç§°ï¼ˆå…¬ç§é’¥å¯¹ï¼‰ |
| **è°èƒ½ç”Ÿæˆ** | åŒæ–¹éƒ½èƒ½ï¼ˆæŒæœ‰å…±äº«å¯†é’¥ï¼‰ | åªæœ‰æŒæœ‰ç§é’¥çš„äºº |
| **è°èƒ½éªŒè¯** | åŒæ–¹éƒ½èƒ½ | ä»»ä½•äººï¼ˆç”¨å…¬é’¥éªŒè¯ï¼‰ |
| **ä¸å¯å¦è®¤æ€§** | âŒ åŒæ–¹éƒ½èƒ½ç”Ÿæˆï¼Œæ— æ³•è¯æ˜æ˜¯è° | âœ… åªæœ‰ç§é’¥æŒæœ‰è€…èƒ½ç”Ÿæˆ |
| **é€‚ç”¨åœºæ™¯** | åŒæ–¹ä¿¡ä»»çš„å†…éƒ¨ç³»ç»Ÿï¼ˆå¦‚å¾®æœåŠ¡é—´è®¤è¯ï¼‰ | éœ€è¦"ä¸å¯å¦è®¤æ€§"çš„åœºæ™¯ï¼ˆå¦‚åˆåŒç­¾ç½²ã€ä»£ç å‘å¸ƒï¼‰ |
| **æ€§èƒ½** | å¿«ï¼ˆå¯¹ç§°è¿ç®—ï¼Œå‡ å¾®ç§’ï¼‰ | æ…¢ï¼ˆéå¯¹ç§°è¿ç®—ï¼Œå‡ æ¯«ç§’ï¼‰ |
| **å¯†é’¥åˆ†å‘** | å›°éš¾ï¼ˆéœ€è¦å®‰å…¨é€šé“åˆ†å‘å¯†é’¥ï¼‰ | ç®€å•ï¼ˆå…¬é’¥å¯å…¬å¼€ï¼‰ |

**å…¸å‹è¯¯ç”¨æ¡ˆä¾‹**ï¼š

```python
# âŒ é”™è¯¯ï¼šç”¨ SHA-256 åš"ç­¾å"ï¼ˆä»»ä½•äººéƒ½èƒ½ç®—ï¼Œæ— æ³•è¯æ˜èº«ä»½ï¼‰
signature = hashlib.sha256(request_params.encode()).hexdigest()

# âœ… æ­£ç¡®ï¼šç”¨ HMACï¼ˆéœ€è¦å¯†é’¥æ‰èƒ½ç”Ÿæˆæœ‰æ•ˆç­¾åï¼‰
signature = hmac.new(secret_key, request_params.encode(), hashlib.sha256).hexdigest()
```

### 4ï¸âƒ£ å¯†é’¥ç®¡ç†ï¼ˆKMS/è½®æ¢ï¼‰ï¼šçœŸæ­£"æ‹‰å¼€å·®è·"çš„åœ°æ–¹

**æ ¸å¿ƒåŸç†ï¼ˆ1 å¥è¯ï¼‰**ï¼šå†å¥½çš„åŠ å¯†ï¼Œå¯†é’¥ç®¡ç†ä¸å½“ä¹Ÿç™½æ­ã€‚

#### å·¥ç¨‹ä¸Šæœ€å¸¸è§ç¿»è½¦ç‚¹ï¼ˆä½ è¦ä¼šè¯†åˆ«ï¼‰

| ç¿»è½¦ç‚¹ | åæœ | çœŸå®æ¡ˆä¾‹ | æ­£ç¡®åšæ³• |
|--------|------|----------|----------|
| **å¯†é’¥ç¡¬ç¼–ç ** | ä»£ç æ³„éœ²ï¼ˆGitHub å…¬å¼€/åç¼–è¯‘ï¼‰= å¯†é’¥å…¨æš´éœ² | æŸå…¬å¸ AWS å¯†é’¥æäº¤åˆ° GitHubï¼Œ1 å°æ—¶åè¢«æŒ–çŸ¿ | ç”¨ç¯å¢ƒå˜é‡/é…ç½®ä¸­å¿ƒ/KMS |
| **å¯†é’¥ä¸æ•°æ®åŒåœ°** | æœºå™¨è¢«å…¥ä¾µ/å¤‡ä»½æ³„éœ²ï¼Œæ•°æ®+å¯†é’¥ä¸€é”…ç«¯ | æŸåŒ»ç–—ç³»ç»Ÿæ•°æ®åº“å¤‡ä»½å«åŠ å¯†å­—æ®µ+å¯†é’¥æ–‡ä»¶ | å¯†é’¥åˆ†ç¦»å­˜å‚¨ï¼ˆå¦‚ AWS KMSï¼‰ |
| **æ°¸ä¸è½®æ¢** | å¯†é’¥æ³„éœ²åï¼Œå†å²+æœªæ¥æ•°æ®å…¨éƒ¨å¯è§£å¯† | æŸæ”¯ä»˜å…¬å¸å¯†é’¥ç”¨äº† 5 å¹´ï¼Œæ³„éœ²åæ— æ³•æ­¢æŸ | å®šæœŸè½®æ¢ï¼ˆæ¯å­£åº¦/æ¯å¹´ï¼‰ |
| **æ— æƒé™æ§åˆ¶** | æ‰€æœ‰æœåŠ¡/äººå‘˜éƒ½èƒ½è¯»å¯†é’¥ | å¼€å‘ç¯å¢ƒå¯†é’¥è¢«æµ‹è¯•å›¢é˜Ÿè¯¯ç”¨åˆ°ç”Ÿäº§ | IAM ç­–ç•¥ï¼šæœ€å°æƒé™åŸåˆ™ |
| **æ— å¤‡ä»½/å•ç‚¹** | å¯†é’¥ä¸¢å¤± = æ‰€æœ‰æ•°æ®æ°¸ä¹…æ— æ³•è§£å¯† | æŸåˆ›ä¸šå…¬å¸å¯†é’¥æ–‡ä»¶è¢«è¯¯åˆ ï¼Œæ•°æ®åº“å…¨åºŸ | å¯†é’¥æ‰˜ç®¡ï¼ˆEscrowï¼‰æˆ–å¼‚åœ°å¤šå‰¯æœ¬ |
| **æ—¥å¿—æ³„éœ²å¯†é’¥** | DEBUG æ—¥å¿—æ‰“å°å¯†é’¥ï¼Œè¢«æ”¶é›†åˆ°æ—¥å¿—å¹³å° | æŸå…¬å¸æ—¥å¿—ä¸­å¿ƒå­˜æœ‰æ˜æ–‡å¯†é’¥ï¼Œè¢«å†…éƒ¨äººå‘˜çªƒå– | æ—¥å¿—è„±æ•ï¼Œç¦æ­¢æ‰“å°å¯†é’¥/Token |

#### ä½ å…ˆä»"èƒ½åšåˆ°çš„æœ€å°å®è·µ"å¼€å§‹

| å±‚çº§ | åšæ³• | é€‚ç”¨åœºæ™¯ | æˆæœ¬ | å®‰å…¨æ€§ |
|------|------|----------|------|--------|
| **å…¥é—¨çº§** | å¯†é’¥æ”¾ `.env` æ–‡ä»¶ï¼ˆä¸è¿› gitï¼ŒåŠ å…¥ `.gitignore`ï¼‰ | ä¸ªäººé¡¹ç›®ã€å­¦ä¹ æ¼”ç¤º | å…è´¹ | â­â­ |
| **è¿›é˜¶çº§** | å¯†é’¥æ”¾é…ç½®ä¸­å¿ƒï¼ˆConsul/Vaultï¼‰+ è®¿é—®æ§åˆ¶ | å°å›¢é˜Ÿé¡¹ç›®ï¼ˆ5-20 äººï¼‰ | è‡ªå»ºæˆ–ä½æˆæœ¬äº‘æœåŠ¡ | â­â­â­ |
| **ç”Ÿäº§çº§** | äº‘æœåŠ¡å•† KMS + è‡ªåŠ¨è½®æ¢ + å®¡è®¡æ—¥å¿— | ä¼ä¸šåº”ç”¨ï¼ˆ100+ ç”¨æˆ·ï¼‰ | $1-10/å¯†é’¥/æœˆ | â­â­â­â­ |
| **é‡‘èçº§** | HSMï¼ˆç¡¬ä»¶å®‰å…¨æ¨¡å—ï¼‰+ FIPS 140-2 è®¤è¯ + å¯†é’¥ä»ªå¼ | æ”¯ä»˜/é“¶è¡Œ/è¯åˆ¸ | $1000+/æœˆ | â­â­â­â­â­ |

#### å¯†é’¥è½®æ¢ç­–ç•¥ï¼ˆæœ€å°å¯ç”¨ç‰ˆï¼‰

**1. å®šä¹‰è½®æ¢å‘¨æœŸ**

| å¯†é’¥ç±»å‹ | æ•æ„Ÿåº¦ | è½®æ¢å‘¨æœŸ | ä¾æ® |
|----------|--------|----------|------|
| æ”¯ä»˜å¯†é’¥ | æé«˜ | 3-6 ä¸ªæœˆ | PCI-DSS åˆè§„è¦æ±‚ |
| æ•°æ®åŠ å¯†å¯†é’¥ï¼ˆDEKï¼‰ | é«˜ | 1 å¹´ | è¡Œä¸šæœ€ä½³å®è·µ |
| API å¯†é’¥ | ä¸­ | 1-2 å¹´ | æ ¹æ®ä½¿ç”¨é¢‘ç‡ |
| æ—¥å¿—ç­¾åå¯†é’¥ | ä½ | 2 å¹´ | å†å²æ—¥å¿—éœ€é•¿æœŸéªŒè¯ |

**2. è½®æ¢æµç¨‹ï¼ˆ5 æ­¥æ³•ï¼‰**

```plaintext
é˜¶æ®µ 1ï¼šå‡†å¤‡
  â””â”€ ç”Ÿæˆæ–°å¯†é’¥ key_v2ï¼ˆåœ¨ KMS ä¸­ç”Ÿæˆï¼Œæ ‡è®°ä¸º "active"ï¼‰
  â””â”€ å°† key_v1 æ ‡è®°ä¸º "deprecated"ï¼ˆä¿ç•™ä½†ä¸å†ç”¨äºæ–°åŠ å¯†ï¼‰

é˜¶æ®µ 2ï¼šåŒè·‘
  â””â”€ æ–°æ•°æ®ç”¨ key_v2 åŠ å¯†
  â””â”€ æ—§æ•°æ®ä»ä¿ç•™ key_v1ï¼ˆè§£å¯†æ—¶æ ¹æ® key_version å­—æ®µé€‰æ‹©å¯†é’¥ï¼‰

é˜¶æ®µ 3ï¼šé‡åŠ å¯†ï¼ˆå¯é€‰ï¼Œè§†æ•°æ®é‡è€Œå®šï¼‰
  â””â”€ åå°ä»»åŠ¡é€æ­¥å°†æ—§æ•°æ®ç”¨ key_v2 é‡æ–°åŠ å¯†
  â””â”€ æ›´æ–° key_version å­—æ®µä¸º "v2"

é˜¶æ®µ 4ï¼šè§‚å¯ŸæœŸï¼ˆ1-4 å‘¨ï¼‰
  â””â”€ ç›‘æ§æ˜¯å¦æœ‰ç³»ç»Ÿä»åœ¨ä½¿ç”¨ key_v1
  â””â”€ æ£€æŸ¥å®¡è®¡æ—¥å¿—ï¼Œç¡®è®¤æ— å¼‚å¸¸è®¿é—®

é˜¶æ®µ 5ï¼šåºŸå¼ƒ
  â””â”€ å°† key_v1 æ ‡è®°ä¸º "disabled"ï¼ˆä¿ç•™ä½†ç¦æ­¢ä½¿ç”¨ï¼‰
  â””â”€ 6 ä¸ªæœˆåå½»åº•åˆ é™¤ key_v1ï¼ˆç¬¦åˆå®¡è®¡è¦æ±‚åï¼‰
```

**3. åº”æ€¥è½®æ¢ï¼ˆç´§æ€¥æƒ…å†µï¼‰**

| è§¦å‘æ¡ä»¶ | å“åº”æ—¶é—´ | æ“ä½œæ­¥éª¤ |
|----------|----------|----------|
| å¯†é’¥ç–‘ä¼¼æ³„éœ²ï¼ˆå¦‚å‘˜å·¥ç¦»èŒå‰æ‰“å°äº†å¯†é’¥ï¼‰ | 1 å°æ—¶å†… | ç«‹å³ç”Ÿæˆ key_v2ï¼Œåœç”¨ key_v1ï¼Œé€šçŸ¥æ‰€æœ‰ç³»ç»Ÿ |
| å®‰å…¨äº‹ä»¶ï¼ˆå¦‚æœåŠ¡å™¨è¢«å…¥ä¾µï¼‰ | 2 å°æ—¶å†… | è½®æ¢æ‰€æœ‰å¯†é’¥ï¼Œå®¡è®¡å†å²è®¿é—®è®°å½•ï¼Œè¯„ä¼°å½±å“èŒƒå›´ |
| åˆè§„è¦æ±‚ï¼ˆå¦‚ç›‘ç®¡æœºæ„è¦æ±‚ï¼‰ | 24 å°æ—¶å†… | æŒ‰åˆè§„æµç¨‹è½®æ¢ï¼Œæäº¤è¯æ®æŠ¥å‘Š |

## å®è·µä»»åŠ¡ï¼ˆåˆæ³•æˆæƒèŒƒå›´å†…ï¼‰

> ä»Šå¤©åšä¸€ä¸ª"å¯†ç å­˜å‚¨å®‰å…¨è¯„ä¼°"çš„å°æ¼”ç»ƒï¼šä½ å¯ä»¥è¯„ä¼°ä½ è‡ªå·±çš„ demoã€æˆ–è€…ç½‘ä¸Šéšä¾¿æ‰¾æ®µç¤ºä¾‹ä»£ç ï¼ˆåªåšé˜…è¯»åˆ†æï¼‰ã€‚

### ä»»åŠ¡ 1ï¼ˆå¿…åšï¼‰ï¼šç”¨"æ£€æŸ¥æ¸…å•"è¯„ä¼°ä¸€ä¸ªå¯†ç å­˜å‚¨æ–¹æ¡ˆ

ä¸‹é¢ç»™ä½ ä¸€ä¸ªå…¸å‹çš„**åä¾‹å­**ï¼ˆâŒ **ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒç”¨**ï¼‰ï¼š

```python
# âŒ é”™è¯¯ç¤ºä¾‹ï¼šç”¨ SHA-256 ç›´æ¥å­˜å¯†ç 
import hashlib

def register_user_bad(username, password):
    password_hash = hashlib.sha256(password.encode()).hexdigest()
    # å­˜å‚¨åˆ°æ•°æ®åº“ï¼šINSERT INTO users (username, password_hash) VALUES (?, ?)
    return password_hash

def verify_user_bad(username, password, stored_hash):
    password_hash = hashlib.sha256(password.encode()).hexdigest()
    return password_hash == stored_hash
```

**ä½ éœ€è¦å†™å‡ºä¸ºä»€ä¹ˆå®ƒä¸è¡Œ**ï¼ˆè‡³å°‘ 3 ç‚¹ï¼‰ï¼š

1. âŒ **SHA-256 å¤ªå¿«**ï¼šGPU æ¯ç§’å¯å°è¯•æ•°åäº¿æ¬¡ï¼Œ8 å­—ç¬¦å¯†ç å‡ å°æ—¶å°±èƒ½çˆ†ç ´
2. âŒ **æ²¡ salt**ï¼šé‡å¤å¯†ç ä¼šæœ‰ç›¸åŒ hashï¼Œæ”»å‡»è€…çœ‹åˆ°ç›¸åŒ hash å°±çŸ¥é“å¯†ç ä¸€æ ·
3. âŒ **æ— æ³•å‡çº§**ï¼šç¡¬ä»¶æ€§èƒ½æå‡åï¼Œæ— æ³•å¢åŠ è®¡ç®—éš¾åº¦ï¼ˆSHA-256 ä¸æ”¯æŒæˆæœ¬å‚æ•°ï¼‰
4. âŒ **å®¹æ˜“å½©è™¹è¡¨æ”»å‡»**ï¼šé¢„å…ˆè®¡ç®—å¥½çš„å¸¸è§å¯†ç å“ˆå¸Œè¡¨å¯ä»¥ç¬é—´æŸ¥åˆ°

ç„¶åå†™å‡ºä¸€ä¸ª"å¤Ÿç”¨ç‰ˆæ­£ç¡®æ–¹æ¡ˆ"ï¼ˆä¼ªä»£ç å³å¯ï¼‰ï¼š

```python
# âœ… æ­£ç¡®ç¤ºä¾‹ï¼šç”¨ bcryptï¼ˆå·¥ä¸šæ ‡å‡†ï¼‰
import bcrypt

def register_user_good(username, password):
    # bcrypt è‡ªåŠ¨ç”Ÿæˆ salt å¹¶åŒ…å«åœ¨è¾“å‡ºä¸­
    salt = bcrypt.gensalt(rounds=12)  # work_factor=12ï¼ˆ2^12=4096 è½®è¿­ä»£ï¼‰
    password_hash = bcrypt.hashpw(password.encode(), salt)
    # å­˜å‚¨åˆ°æ•°æ®åº“ï¼šINSERT INTO users (username, password_hash) VALUES (?, ?)
    return password_hash.decode()  # è¿”å›çš„æ ¼å¼ï¼š$2b$12$salt..hash..

def verify_user_good(username, password, stored_hash):
    # bcrypt.checkpw ä¼šè‡ªåŠ¨ä» stored_hash ä¸­æå– salt
    return bcrypt.checkpw(password.encode(), stored_hash.encode())
```

**ä¸ºä»€ä¹ˆè¿™ä¸ªæ–¹æ¡ˆå¥½**ï¼š

- âœ… **bcrypt å¾ˆæ…¢**ï¼šå•æ¬¡éªŒè¯ 100-300msï¼Œè®©æ”»å‡»è€…æ¯ç§’åªèƒ½å°è¯•å‡ æ¬¡
- âœ… **è‡ªåŠ¨ salt**ï¼šæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹éšæœº saltï¼Œé˜²æ­¢å½©è™¹è¡¨å’Œé‡å¤å¯†ç æš´éœ²
- âœ… **å¯å‡çº§**ï¼šå¯ä»¥è°ƒæ•´ rounds å‚æ•°ï¼ˆå¦‚ä» 12 æåˆ° 13ï¼‰ï¼Œè®©è®¡ç®—æ—¶é—´ç¿»å€
- âœ… **å·¥ä¸šæ ‡å‡†**ï¼šè¢«å¹¿æ³›å®¡è®¡å’Œä½¿ç”¨ï¼Œåº“å®ç°ç»è¿‡å……åˆ†æµ‹è¯•

### ä»»åŠ¡ 2ï¼ˆå¿…åšï¼‰ï¼šç”¨ Python æ¼”ç¤º"å¿«å“ˆå¸Œ vs æ…¢ KDF"çš„åŒºåˆ«

ç”¨æ ‡å‡†åº“çš„ PBKDF2ï¼ˆè¿™æ˜¯ KDF çš„ä¸€ç§ï¼‰å¯¹æ¯” SHA-256ï¼š

```powershell
python - << 'PY'
import os
import time
import hashlib

password = b"P@ssw0rd!"
salt = os.urandom(16)

# æµ‹è¯• SHA-256ï¼ˆå¿«å“ˆå¸Œï¼‰
start = time.time()
sha = hashlib.sha256(password).hexdigest()
sha_time = (time.time() - start) * 1000
print(f"SHA-256:  {sha[:32]}... time={sha_time:.4f} ms")

# æµ‹è¯• PBKDF2ï¼ˆKDFï¼Œ200,000 æ¬¡è¿­ä»£ï¼‰
start = time.time()
pbk = hashlib.pbkdf2_hmac('sha256', password, salt, 200_000).hex()
pbk_time = (time.time() - start) * 1000
print(f"PBKDF2:   {pbk[:32]}... time={pbk_time:.4f} ms")

print(f"\næ€§èƒ½å¯¹æ¯”ï¼šPBKDF2 æ¯” SHA-256 æ…¢ {pbk_time/sha_time:.0f} å€")
print("âœ… è¿™å°±æ˜¯ KDF çš„ç›®çš„ï¼šè®©æ”»å‡»è€…çˆ†ç ´æˆæœ¬æŒ‡æ•°çº§ä¸Šå‡")
PY
```

**ä½ è¦è®°å½•çš„ç»“è®º**ï¼ˆæˆªå›¾ä¿å­˜ï¼‰ï¼š

- PBKDF2 æ˜æ˜¾æ›´æ…¢ï¼ˆé€šå¸¸æ…¢ 1000-10000 å€ï¼‰**è¿™æ˜¯å®ƒçš„ç›®çš„**ï¼šè®©çˆ†ç ´æˆæœ¬å˜é«˜
- æœ‰ saltï¼Œæ¯æ¬¡ç»“æœä¸ä¸€æ ·ï¼ˆå› ä¸º salt éšæœºï¼‰
- åœ¨æˆ‘çš„æœºå™¨ä¸Šï¼š
  - SHA-256 ç”¨æ—¶ï¼šçº¦ \_\_\_ ms
  - PBKDF2 ç”¨æ—¶ï¼šçº¦ \_\_\_ ms
  - æ…¢äº† \_\_\_ å€

### ä»»åŠ¡ 3ï¼ˆå¿…åšï¼‰ï¼šå†™ä¸€å¼ "åº”ç”¨åŠ å¯†æ£€æŸ¥æ¸…å•"ï¼ˆå­˜æ¡£åˆ°ä»Šå¤©çš„æˆæœé‡Œï¼‰

æŠŠä¸‹é¢çš„æ¸…å•å¤åˆ¶åˆ°ä½ çš„æˆæœåŒºï¼Œç„¶å**é€æ¡æ£€æŸ¥ä½ çš„é¡¹ç›®/å­¦ä¹ é¡¹ç›®**ï¼š

#### ä¼ è¾“åŠ å¯†æ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰æ•æ„Ÿæ¥å£å¿…é¡» HTTPSï¼ˆåŒ…æ‹¬ APIã€ç™»å½•ã€æ”¯ä»˜ï¼‰
- [ ] è¯ä¹¦æœ‰æ•ˆä¸”åŸŸååŒ¹é…
- [ ] ç¦æ­¢åœ¨ä»£ç ä¸­å¿½ç•¥è¯ä¹¦é”™è¯¯ï¼ˆå¦‚ `curl -k`ã€`requests.verify=False`ï¼‰
- [ ] æ‰€æœ‰å¤–éƒ¨èµ„æºï¼ˆCDN/å›¾ç‰‡/JSï¼‰ä½¿ç”¨ HTTPS
- [ ] é…ç½® HSTSï¼ˆHTTP Strict Transport Securityï¼‰å¤´éƒ¨

#### å¯†ç å­˜å‚¨æ£€æŸ¥æ¸…å•

- [ ] ä½¿ç”¨ KDFï¼ˆbcrypt/Argon2/scrypt/PBKDF2ï¼‰ï¼Œ**ç¦æ­¢** MD5/SHA-256 ç›´æ¥å­˜å¯†ç 
- [ ] æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹éšæœº saltï¼ˆä¸è¦å…¨å±€ç»Ÿä¸€ saltï¼‰
- [ ] æˆæœ¬å‚æ•°åˆç†ï¼šPBKDF2 â‰¥ 200,000 æ¬¡ï¼Œbcrypt work_factor â‰¥ 10
- [ ] **ç¦æ­¢**å¯é€†åŠ å¯†å­˜å¯†ç ï¼ˆå¦‚ AES åŠ å¯†å­˜å‚¨ï¼‰
- [ ] ç™»å½•å¤±è´¥æœ‰é™æµï¼ˆé˜²æ­¢åœ¨çº¿çˆ†ç ´ï¼‰

#### æ•æ„Ÿæ•°æ®åŠ å¯†æ£€æŸ¥æ¸…å•

- [ ] æ•æ„Ÿå­—æ®µåŠ å¯†ï¼ˆå¦‚èº«ä»½è¯å·ã€é“¶è¡Œå¡ï¼‰ï¼Œä½¿ç”¨ AES-GCM æˆ– ChaCha20-Poly1305
- [ ] å¯†é’¥ä¸è¿› gitï¼ˆåŠ å…¥ `.gitignore`ï¼‰
- [ ] å¯†é’¥ä¸æ•°æ®åˆ†ç¦»å­˜å‚¨ï¼ˆä¸è¦å’Œæ•°æ®åº“åœ¨åŒä¸€å°æœºå™¨ï¼‰
- [ ] æ¯æ¬¡åŠ å¯†ä½¿ç”¨æ–°çš„éšæœº IV/Nonce
- [ ] å­˜å‚¨æ ¼å¼åŒ…å« `algorithm`ã€`iv`ã€`ciphertext`ã€`key_version`

#### å¯†é’¥ç®¡ç†æ£€æŸ¥æ¸…å•

- [ ] å¯†é’¥ä¸ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
- [ ] å¯†é’¥æœ‰è½®æ¢ç­–ç•¥ï¼ˆè‡³å°‘å®šä¹‰äº†"å¤šä¹…æ¢ä¸€æ¬¡"ï¼‰
- [ ] å¯†é’¥æœ‰åº”æ€¥æ›¿æ¢æµç¨‹ï¼ˆå¯†é’¥æ³„éœ²æ—¶æ€ä¹ˆåŠï¼‰
- [ ] å¯†é’¥æœ‰å¤‡ä»½ï¼ˆä½†å¤‡ä»½ä¹Ÿè¦åŠ å¯†ï¼‰
- [ ] æœ€å°æƒé™ï¼šåªæœ‰éœ€è¦çš„æœåŠ¡/äººå‘˜èƒ½è®¿é—®å¯†é’¥

#### æ—¥å¿—ä¸å®¡è®¡æ£€æŸ¥æ¸…å•

- [ ] æ—¥å¿—ä¸æ‰“å°æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç /Token/å¯†é’¥/å®Œæ•´èº«ä»½è¯å·ï¼‰
- [ ] å¯†é’¥è®¿é—®æœ‰å®¡è®¡æ—¥å¿—ï¼ˆè°åœ¨ä»€ä¹ˆæ—¶å€™è®¿é—®äº†å¯†é’¥ï¼‰
- [ ] æ•æ„Ÿæ“ä½œæœ‰æ—¥å¿—ï¼ˆå¦‚å¯†ç é‡ç½®ã€å¯†é’¥è½®æ¢ï¼‰

### ä»»åŠ¡ 4ï¼ˆå¼ºçƒˆæ¨èï¼‰ï¼šbcrypt å®æˆ˜æ¼”ç¤º

å®‰è£… bcrypt åº“å¹¶å®é™…è¿è¡Œï¼š

```powershell
# å®‰è£… bcrypt
pip install bcrypt

# è¿è¡Œæ¼”ç¤º
python - << 'PY'
import bcrypt
import time

password = b"MySecureP@ssw0rd"

# æ³¨å†Œï¼šç”Ÿæˆå“ˆå¸Œ
print("=== æ³¨å†Œæµç¨‹ ===")
start = time.time()
salt = bcrypt.gensalt(rounds=12)  # work_factor=12
password_hash = bcrypt.hashpw(password, salt)
register_time = (time.time() - start) * 1000
print(f"å¯†ç å“ˆå¸Œ: {password_hash.decode()}")
print(f"è€—æ—¶: {register_time:.2f} ms")
print(f"è§£æ: $2b (ç®—æ³•) / $12 (work_factor) / 22å­—ç¬¦salt / 31å­—ç¬¦hash")

# ç™»å½•ï¼šéªŒè¯å“ˆå¸Œ
print("\n=== ç™»å½•æµç¨‹ï¼ˆæ­£ç¡®å¯†ç ï¼‰===")
start = time.time()
is_valid = bcrypt.checkpw(password, password_hash)
login_time = (time.time() - start) * 1000
print(f"éªŒè¯ç»“æœ: {'âœ… å¯†ç æ­£ç¡®' if is_valid else 'âŒ å¯†ç é”™è¯¯'}")
print(f"è€—æ—¶: {login_time:.2f} ms")

# é”™è¯¯å¯†ç æµ‹è¯•
print("\n=== ç™»å½•æµç¨‹ï¼ˆé”™è¯¯å¯†ç ï¼‰===")
wrong_password = b"WrongPassword"
start = time.time()
is_valid = bcrypt.checkpw(wrong_password, password_hash)
verify_time = (time.time() - start) * 1000
print(f"éªŒè¯ç»“æœ: {'âœ… å¯†ç æ­£ç¡®' if is_valid else 'âŒ å¯†ç é”™è¯¯'}")
print(f"è€—æ—¶: {verify_time:.2f} ms")

print(f"\nğŸ’¡ æ³¨æ„ï¼šå³ä½¿å¯†ç é”™è¯¯ï¼ŒéªŒè¯æ—¶é—´ä¹Ÿå·®ä¸å¤šï¼ˆ{verify_time:.2f} msï¼‰")
print("   è¿™æ˜¯é˜²å¾¡æªæ–½ï¼šé˜²æ­¢æ”»å‡»è€…é€šè¿‡æ—¶é—´å·®åˆ¤æ–­å¯†ç å¯¹é”™")
PY
```

## å·©å›ºç»ƒä¹ ï¼ˆé¢˜ä¸å¤ç›˜ï¼‰

### é¢˜ 1ï¼šä¸ºä»€ä¹ˆä¸èƒ½ç”¨æ˜æ–‡æˆ–å¯é€†åŠ å¯†å­˜å‚¨å¯†ç ï¼Ÿ

**æ€è·¯**ï¼šä½ è¦æŠŠ"æ•°æ®åº“æ³„éœ²"å½“æˆå¿…ç„¶ä¼šå‘ç”Ÿçš„äº‹æ•…æ¥è®¾è®¡ã€‚

- **æ˜æ–‡å­˜å‚¨**ï¼šæ•°æ®åº“ä¸€æ—¦æ³„éœ²ï¼Œæ‰€æœ‰ç”¨æˆ·å¯†ç ç›´æ¥æ›å…‰
- **å¯é€†åŠ å¯†ï¼ˆå¦‚ AESï¼‰**ï¼šåªè¦å¯†é’¥æ³„éœ²æˆ–è¢«æ‹¿åˆ°ï¼Œå¯†ç ä»ç„¶ä¼šè¢«æ‰¹é‡è§£å¯†
- **æ­£ç¡®åšæ³•**ï¼šç”¨ KDF å“ˆå¸Œ + saltï¼Œè®©æ”»å‡»è€…åªèƒ½å»çŒœï¼ˆè€Œä¸”å¾ˆæ…¢ï¼‰
- **æ·±å±‚åŸå› **ï¼šå¯†ç æ˜¯ç”¨æˆ·çš„**è®¤è¯å‡­æ®**ï¼Œä¸æ˜¯éœ€è¦è¿˜åŸçš„æ•°æ®ï¼ˆä¸åƒèº«ä»½è¯å·éœ€è¦è§£å¯†å±•ç¤ºï¼‰

### é¢˜ 2ï¼šè®¾è®¡ä¸€å¥—å¯†ç å­˜å‚¨ç­–ç•¥ï¼ˆå†™åˆ°èƒ½è½åœ°ï¼‰

**æ€è·¯**ï¼šå†™ 6 ä¸ªè¦ç´ ï¼ˆç…§ç€è¿™ä¸ªæ¡†æ¶å¡«ï¼‰ï¼š

1. **ç®—æ³•é€‰æ‹©**ï¼šbcryptï¼ˆwork_factor=12ï¼‰æˆ– Argon2idï¼ˆé»˜è®¤å‚æ•°ï¼‰
2. **salt ç­–ç•¥**ï¼šæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹éšæœº saltï¼Œç”± KDF è‡ªåŠ¨ç”Ÿæˆå¹¶åŒ…å«åœ¨è¾“å‡ºä¸­
3. **æˆæœ¬å‚æ•°**ï¼šbcrypt work_factor=12ï¼ˆçº¦ 250msï¼‰ï¼Œæ¯ 2 å¹´è¯„ä¼°æ˜¯å¦éœ€è¦å¢åŠ 
4. **å­˜å‚¨å­—æ®µ**ï¼šæ•°æ®åº“è¡¨åŒ…å« `password_hash`ï¼ˆTEXT ç±»å‹ï¼Œå­˜å‚¨å®Œæ•´çš„ bcrypt è¾“å‡ºï¼‰
5. **éªŒè¯æµç¨‹**ï¼šç™»å½•æ—¶è°ƒç”¨ `bcrypt.checkpw(input_password, stored_hash)`
6. **å‡çº§ç­–ç•¥**ï¼šç”¨æˆ·ä¸‹æ¬¡ç™»å½•æˆåŠŸæ—¶ï¼Œæ£€æµ‹ work_factor æ˜¯å¦è¿‡ä½ï¼Œå¦‚æœæ˜¯åˆ™ç”¨æ–°å‚æ•°é‡æ–°å“ˆå¸Œå¹¶æ›´æ–°

### é¢˜ 3ï¼ˆæ–°å¢ï¼‰ï¼šä»€ä¹ˆæƒ…å†µä¸‹å¯†é’¥éœ€è¦ç´§æ€¥è½®æ¢ï¼Ÿ

**æ€è·¯**ï¼šåˆ—ä¸¾è§¦å‘æ¡ä»¶ + å“åº”æ—¶é—´ + æ“ä½œæ­¥éª¤ã€‚

- **è§¦å‘æ¡ä»¶ç¤ºä¾‹**ï¼š
  1. å‘˜å·¥ç¦»èŒï¼ˆå°¤å…¶æ˜¯æœ‰æƒé™è®¿é—®å¯†é’¥çš„å‘˜å·¥ï¼‰
  2. æœåŠ¡å™¨è¢«å…¥ä¾µæˆ–ç–‘ä¼¼å…¥ä¾µ
  3. å¯†é’¥å‡ºç°åœ¨æ—¥å¿—/é”™è¯¯æŠ¥å‘Š/ç›‘æ§ç³»ç»Ÿä¸­
  4. å¯†é’¥è¢«è¯¯æäº¤åˆ° git ä»“åº“ï¼ˆå³ä½¿å·²åˆ é™¤æäº¤ï¼‰
  5. ç¬¬ä¸‰æ–¹ä¾›åº”å•†å®‰å…¨äº‹ä»¶ï¼ˆå¦‚ä½¿ç”¨çš„äº‘æœåŠ¡å•†è¢«æ”»å‡»ï¼‰
- **å“åº”æ—¶é—´**ï¼šæ ¹æ®æ•æ„Ÿåº¦ 1-24 å°æ—¶å†…
- **æ“ä½œæ­¥éª¤**ï¼š
  1. ç«‹å³ç”Ÿæˆæ–°å¯†é’¥å¹¶æ ‡è®°ä¸º active
  2. åœç”¨æ—§å¯†é’¥ï¼ˆä½†ä¿ç•™ï¼Œä¸åˆ é™¤ï¼Œç”¨äºå®¡è®¡ï¼‰
  3. é€šçŸ¥æ‰€æœ‰ç›¸å…³ç³»ç»Ÿæ›´æ–°å¯†é’¥å¼•ç”¨
  4. å®¡è®¡æ—§å¯†é’¥çš„å†å²è®¿é—®è®°å½•
  5. è¯„ä¼°å½±å“èŒƒå›´ï¼ˆå“ªäº›æ•°æ®å¯èƒ½å·²è¢«è§£å¯†ï¼‰
  6. ç”Ÿæˆäº‹ä»¶æŠ¥å‘Šï¼Œæ€»ç»“æ•™è®­

### é¢˜ 4ï¼ˆæ–°å¢ï¼‰ï¼šå¯¹æ¯” HMAC å’Œ æ•°å­—ç­¾åçš„åº”ç”¨åœºæ™¯

**æ€è·¯**ï¼šä»"ä¿¡ä»»æ¨¡å‹"è§’åº¦åˆ†æã€‚

| åœºæ™¯ | åº”è¯¥ç”¨ | åŸå›  |
|------|--------|------|
| å¾®æœåŠ¡ A è°ƒç”¨å¾®æœåŠ¡ Bï¼ˆå†…éƒ¨ç³»ç»Ÿï¼‰ | HMAC | åŒæ–¹äº’ä¿¡ï¼Œå…±äº«å¯†é’¥ï¼Œæ€§èƒ½é«˜ |
| ç”¨æˆ·æµè§ˆå™¨ â† æœåŠ¡å™¨ä¸‹å‘ JWT | å¯ä»¥ç”¨ HMACï¼ˆHS256ï¼‰ | å¦‚æœåªæœ‰æœåŠ¡å™¨éªŒè¯ JWT |
| ç”¨æˆ·æµè§ˆå™¨ â†’ å¤šä¸ªå¾®æœåŠ¡éƒ½éªŒè¯ JWT | æ•°å­—ç­¾åï¼ˆRS256ï¼‰ | é¿å…æŠŠå¯†é’¥åˆ†å‘ç»™æ‰€æœ‰å¾®æœåŠ¡ï¼Œç”¨å…¬é’¥éªŒè¯ |
| APP éªŒè¯æœåŠ¡å™¨å“åº”å®Œæ•´æ€§ | æ•°å­—ç­¾å | APP åªéœ€å†…ç½®å…¬é’¥ï¼Œæ— æ³•ä¼ªé€ å“åº” |
| ä»£ç ç­¾åï¼ˆå‘å¸ƒè½¯ä»¶åŒ…ï¼‰ | æ•°å­—ç­¾å | éœ€è¦"ä¸å¯å¦è®¤æ€§"ï¼Œè¯æ˜æ˜¯è°ç­¾çš„ |

## è¯„ä¼°æ ‡å‡†ï¼ˆè¾¾æˆåˆ¤å®šï¼‰

- âœ… ä½ å†™å‡ºè‡³å°‘ 5 æ¡"å¯†ç å­˜å‚¨/å¯†é’¥ç®¡ç†"é£é™©ç‚¹ + å¯¹åº”æ”¹æ³•
- âœ… ä½ èƒ½è·‘å‡º PBKDF2 ç¤ºä¾‹å¹¶æˆªå›¾ï¼ˆå¯¹æ¯” SHA-256 å’Œ PBKDF2 çš„è€—æ—¶ï¼‰
- âœ… ä½ å®Œæˆå¹¶ä¿å­˜"åº”ç”¨åŠ å¯†æ£€æŸ¥æ¸…å•"
- âœ… ä½ èƒ½è§£é‡Š"ä¸ºä»€ä¹ˆ bcrypt å•æ¬¡éªŒè¯ 100ms æ˜¯ç‰¹æ€§ä¸æ˜¯ç¼ºé™·"
- âœ… ä½ èƒ½è¯´å‡ºè‡³å°‘ 3 ç§å¯†é’¥è½®æ¢çš„è§¦å‘æ¡ä»¶

## å­¦ä¹ æˆæœè¾¾æˆæƒ…å†µï¼ˆç”±å­¦ä¹ è€…å¡«å†™ï¼‰

### æˆªå›¾ä¸è¯æ®

- [ ] ä»»åŠ¡ 2ï¼šPBKDF2 vs SHA-256 æ€§èƒ½å¯¹æ¯”æˆªå›¾
- [ ] ä»»åŠ¡ 4ï¼ˆå¯é€‰ï¼‰ï¼šbcrypt æ¼”ç¤ºè¾“å‡ºæˆªå›¾

### å…³é”®å‘½ä»¤ä¸è¾“å‡º

**PBKDF2 æ¼”ç¤ºè¾“å‡º**ï¼ˆç²˜è´´å…³é”®è¡Œï¼‰ï¼š

```
SHA-256:  ______... time=____ ms
PBKDF2:   ______... time=____ ms
æ€§èƒ½å¯¹æ¯”ï¼šPBKDF2 æ¯” SHA-256 æ…¢ ____ å€
```

### åº”ç”¨åŠ å¯†æ£€æŸ¥æ¸…å•ï¼ˆå‹¾é€‰ä½ çš„é¡¹ç›®ç¬¦åˆçš„é¡¹ï¼‰

#### ä¼ è¾“åŠ å¯†

- [ ] æ‰€æœ‰æ•æ„Ÿæ¥å£ HTTPS
- [ ] è¯ä¹¦æœ‰æ•ˆä¸”åŸŸååŒ¹é…
- [ ] ç¦æ­¢å¿½ç•¥è¯ä¹¦é”™è¯¯
- [ ] æ‰€æœ‰å¤–éƒ¨èµ„æº HTTPS
- [ ] é…ç½® HSTS

#### å¯†ç å­˜å‚¨

- [ ] ä½¿ç”¨ KDFï¼ˆbcrypt/Argon2ï¼‰
- [ ] æ¯ç”¨æˆ·ç‹¬ç«‹ salt
- [ ] æˆæœ¬å‚æ•°åˆç†
- [ ] ç¦æ­¢å¯é€†åŠ å¯†å­˜å¯†ç 
- [ ] ç™»å½•å¤±è´¥é™æµ

#### æ•æ„Ÿæ•°æ®åŠ å¯†

- [ ] æ•æ„Ÿå­—æ®µåŠ å¯†ï¼ˆAES-GCMï¼‰
- [ ] å¯†é’¥ä¸è¿› git
- [ ] å¯†é’¥ä¸æ•°æ®åˆ†ç¦»
- [ ] æ¯æ¬¡æ–° IV
- [ ] å­˜å‚¨æ ¼å¼å®Œæ•´

#### å¯†é’¥ç®¡ç†

- [ ] å¯†é’¥ä¸ç¡¬ç¼–ç 
- [ ] æœ‰è½®æ¢ç­–ç•¥
- [ ] æœ‰åº”æ€¥æµç¨‹
- [ ] æœ‰å¤‡ä»½
- [ ] æœ€å°æƒé™

#### æ—¥å¿—ä¸å®¡è®¡

- [ ] æ—¥å¿—ä¸æ‰“å°æ•æ„Ÿä¿¡æ¯
- [ ] å¯†é’¥è®¿é—®æœ‰å®¡è®¡
- [ ] æ•æ„Ÿæ“ä½œæœ‰æ—¥å¿—

### ç»“è®ºä¸åæ€

**æˆ‘ä»Šå¤©ææ¸…æ¥šäº†**ï¼š

- ï¼ˆä¾‹å¦‚ï¼šå¯†ç å­˜å‚¨è¦ç”¨ KDF è€Œä¸æ˜¯åŠ å¯†ï¼›å¯†é’¥ç®¡ç†æ¯”ç®—æ³•é€‰æ‹©æ›´é‡è¦ï¼‰

**æˆ‘å·®ç‚¹ææ··çš„æ˜¯**ï¼š

- ï¼ˆä¾‹å¦‚ï¼šä»¥ä¸º"åŠ å¯†å­˜å¯†ç "å°±å®‰å…¨äº†ï¼Œå…¶å®å¯†ç ä¸éœ€è¦å¯é€†ï¼‰

**æ˜å¤©æˆ‘è¦ç»§ç»­è¡¥çš„æ˜¯**ï¼š

- ï¼ˆä¾‹å¦‚ï¼šå¯†é’¥è½®æ¢çš„å…·ä½“å®æ–½ã€é…ç½®ä¸­å¿ƒ Vault çš„ä½¿ç”¨ï¼‰

**æœ¬æ¬¡å­¦ä¹ è€—æ—¶**ï¼šçº¦ \_\_\_ å°æ—¶

**æŒæ¡ç¨‹åº¦è‡ªè¯„**ï¼š

- [ ] ğŸ˜• çœ‹æ‡‚äº†ä½†æ²¡åŠ¨æ‰‹
- [ ] ğŸ™‚ è·‘é€šäº†åŸºç¡€ä»»åŠ¡
- [ ] ğŸ˜ƒ å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡å¹¶ç†è§£åŸç†
- [ ] ğŸ¤© é¢å¤–ç ”ç©¶äº† Argon2/Vault/HSM

## é›†ä¸­å‚è€ƒç­”æ¡ˆï¼ˆå«æ€è·¯ï¼‰

### é¢˜ 1 å‚è€ƒç­”æ¡ˆ

**ä¸ºä»€ä¹ˆä¸èƒ½ç”¨æ˜æ–‡æˆ–å¯é€†åŠ å¯†å­˜å‚¨å¯†ç ï¼Ÿ**

1. **æ˜æ–‡å­˜å¯†ç **ï¼š
   - åæœï¼šæ•°æ®åº“ä¸€æ—¦æ³„éœ²ï¼ˆSQL æ³¨å…¥/å¤‡ä»½æ³„éœ²/å†…éƒ¨äººå‘˜çªƒå–ï¼‰ï¼Œæ‰€æœ‰ç”¨æˆ·å¯†ç ç›´æ¥æ›å…‰
   - è¿é”ååº”ï¼šç”¨æˆ·åœ¨å¤šä¸ªç½‘ç«™å¤ç”¨å¯†ç ï¼Œæ³„éœ²åä¼šè¢«"æ’åº“æ”»å‡»"ï¼ˆæ”»å‡»è€…æ‹¿æ³„éœ²çš„å¯†ç å»å°è¯•ç™»å½•å…¶ä»–ç½‘ç«™ï¼‰

2. **å¯é€†åŠ å¯†å­˜å¯†ç **ï¼ˆå¦‚ AES åŠ å¯†ï¼‰ï¼š
   - é—®é¢˜ï¼šå¯†é’¥ä¸€æ—¦æ³„éœ²/è¢«è¯¯é…ç½®/è¢«å¤‡ä»½æš´éœ²ï¼Œæ”»å‡»è€…å¯ä»¥æ‰¹é‡è§£å¯†å¾—åˆ°æ˜æ–‡å¯†ç 
   - ç°å®åœºæ™¯ï¼šå¯†é’¥å’Œæ•°æ®åº“å¸¸å¸¸åœ¨åŒä¸€å°æœºå™¨/åŒä¸€ä»½å¤‡ä»½é‡Œï¼Œä¸€èµ·æ³„éœ²
   - æ ¹æœ¬çŸ›ç›¾ï¼šå¯†ç æ˜¯**è®¤è¯å‡­æ®**ï¼Œä¸æ˜¯éœ€è¦è¿˜åŸçš„æ•°æ®ï¼ˆä¸åƒèº«ä»½è¯å·éœ€è¦è§£å¯†å±•ç¤ºç»™ç”¨æˆ·ï¼‰

3. **æ­£ç¡®æ–¹å¼**ï¼š
   - ç”¨ KDFï¼ˆå¦‚ bcrypt/scrypt/Argon2/PBKDF2ï¼‰+ æ¯ç”¨æˆ· salt + åˆç†æˆæœ¬å‚æ•°
   - åŸç†ï¼šè®©æ”»å‡»è€…å³ä½¿æ‹¿åˆ°æ•°æ®åº“ä¹Ÿåªèƒ½è¿›è¡Œé«˜æˆæœ¬çŒœæµ‹ï¼ˆæ¯ä¸ªå¯†ç éœ€è¦ 100-300ms éªŒè¯ï¼‰
   - æ•ˆæœï¼š8 å­—ç¬¦å¯†ç çˆ†ç ´æ—¶é—´ä»"å‡ å°æ—¶"ï¼ˆSHA-256ï¼‰å»¶é•¿åˆ°"æ•°ç™¾å¹´"ï¼ˆbcryptï¼‰

### é¢˜ 2 å‚è€ƒç­”æ¡ˆï¼ˆå®Œæ•´å¯†ç å­˜å‚¨ç­–ç•¥ï¼‰

#### 1. ç®—æ³•é€‰æ‹©

- **é¦–é€‰**ï¼šbcryptï¼ˆwork_factor=12ï¼‰
- **å¤‡é€‰**ï¼šArgon2idï¼ˆmemory=64MB, iterations=3, parallelism=4ï¼‰
- **ç†ç”±**ï¼šå·¥ä¸šæ ‡å‡†ï¼Œåº“æˆç†Ÿï¼Œå¹¿æ³›å®¡è®¡

#### 2. salt ç­–ç•¥

- **ç”Ÿæˆæ–¹å¼**ï¼šç”± KDF è‡ªåŠ¨ç”Ÿæˆéšæœº saltï¼ˆbcrypt ä¸º 16 å­—èŠ‚éšæœºæ•°ï¼‰
- **å­˜å‚¨æ–¹å¼**ï¼šsalt åŒ…å«åœ¨ password_hash è¾“å‡ºä¸­ï¼ˆæ— éœ€å•ç‹¬å­˜å‚¨ï¼‰
- **é‡è¦æ€§**ï¼šé˜²æ­¢å½©è™¹è¡¨æ”»å‡»ï¼Œé˜²æ­¢é‡å¤å¯†ç æš´éœ²

#### 3. æˆæœ¬å‚æ•°

- **åˆå§‹è®¾å®š**ï¼šbcrypt work_factor=12ï¼ˆå•æ¬¡éªŒè¯çº¦ 250msï¼‰
- **å‡çº§ç­–ç•¥**ï¼šæ¯ 2 å¹´è¯„ä¼°ç¡¬ä»¶æ€§èƒ½ï¼Œå¿…è¦æ—¶å¢åŠ åˆ° 13ï¼ˆéªŒè¯æ—¶é—´ç¿»å€ï¼‰
- **ä¸Šé™**ï¼šå•æ¬¡éªŒè¯ä¸è¶…è¿‡ 500msï¼ˆé¿å…å½±å“ç”¨æˆ·ä½“éªŒï¼‰

#### 4. å­˜å‚¨å­—æ®µ

```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,  -- å­˜å‚¨å®Œæ•´çš„ bcrypt è¾“å‡ºï¼ˆçº¦ 60 å­—ç¬¦ï¼‰
    password_updated_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 5. éªŒè¯æµç¨‹

```python
def login(username, input_password):
    # ä»æ•°æ®åº“è·å– stored_hash
    user = db.query("SELECT password_hash FROM users WHERE username=?", username)
    if not user:
        return False  # ç”¨æˆ·ä¸å­˜åœ¨
    
    # éªŒè¯å¯†ç ï¼ˆbcrypt.checkpw ä¼šè‡ªåŠ¨æå– saltï¼‰
    is_valid = bcrypt.checkpw(input_password.encode(), user.password_hash.encode())
    
    if is_valid:
        # ï¼ˆå¯é€‰ï¼‰æ£€æŸ¥æ˜¯å¦éœ€è¦å‡çº§ work_factor
        upgrade_password_hash_if_needed(user.id, input_password, user.password_hash)
        return True
    else:
        return False
```

#### 6. è¿ç§»/å‡çº§ç­–ç•¥

- **åœºæ™¯ 1**ï¼šä»æ—§ç³»ç»Ÿè¿ç§»ï¼ˆå¦‚ MD5 å­˜å‚¨ï¼‰
  - ç”¨æˆ·ä¸‹æ¬¡ç™»å½•æˆåŠŸæ—¶ï¼Œç”¨ bcrypt é‡æ–°å“ˆå¸Œå¹¶è¦†ç›–æ—§ hash
  - è¿‡æ¸¡æœŸï¼šåŒæ—¶éªŒè¯ MD5 å’Œ bcryptï¼ˆå…¼å®¹æœªç™»å½•ç”¨æˆ·ï¼‰

- **åœºæ™¯ 2**ï¼šæå‡ work_factorï¼ˆå¦‚ä» 10 æåˆ° 12ï¼‰
  - ç”¨æˆ·ä¸‹æ¬¡ç™»å½•æˆåŠŸæ—¶ï¼Œæ£€æµ‹ work_factor æ˜¯å¦è¿‡ä½
  - å¦‚æœè¿‡ä½ï¼Œç”¨æ–°å‚æ•°é‡æ–°å“ˆå¸Œå¹¶æ›´æ–° `password_hash` å’Œ `password_updated_at`

```python
def upgrade_password_hash_if_needed(user_id, password, current_hash):
    # è§£æå½“å‰ hash çš„ work_factorï¼ˆbcrypt æ ¼å¼ï¼š$2b$10$...ï¼‰
    current_work_factor = int(current_hash.split('$')[2])
    target_work_factor = 12
    
    if current_work_factor < target_work_factor:
        # ç”¨æ–°å‚æ•°é‡æ–°å“ˆå¸Œ
        new_salt = bcrypt.gensalt(rounds=target_work_factor)
        new_hash = bcrypt.hashpw(password.encode(), new_salt).decode()
        
        # æ›´æ–°æ•°æ®åº“
        db.execute(
            "UPDATE users SET password_hash=?, password_updated_at=NOW() WHERE id=?",
            new_hash, user_id
        )
        print(f"âœ… User {user_id} password hash upgraded to work_factor={target_work_factor}")
```

### é¢˜ 3 å‚è€ƒç­”æ¡ˆï¼ˆå¯†é’¥ç´§æ€¥è½®æ¢ï¼‰

#### è§¦å‘æ¡ä»¶ï¼ˆæŒ‰ä¸¥é‡ç¨‹åº¦æ’åºï¼‰

| ä¸¥é‡åº¦ | è§¦å‘æ¡ä»¶ | å“åº”æ—¶é—´ | ç¤ºä¾‹ |
|--------|----------|----------|------|
| ğŸ”´ æé«˜ | å¯†é’¥å·²ç¡®è®¤æ³„éœ²ï¼ˆå‡ºç°åœ¨å…¬å¼€æ¸ é“ï¼‰ | 1 å°æ—¶å†… | å¯†é’¥è¢«æäº¤åˆ° GitHub å…¬å¼€ä»“åº“ |
| ğŸŸ  é«˜ | æœåŠ¡å™¨è¢«å…¥ä¾µæˆ–ç–‘ä¼¼å…¥ä¾µ | 2 å°æ—¶å†… | æ£€æµ‹åˆ°æœªæˆæƒè®¿é—®å¯†é’¥æ–‡ä»¶ |
| ğŸŸ¡ ä¸­ | æœ‰æƒé™äººå‘˜ç¦»èŒï¼ˆå°¤å…¶æ˜¯ç®¡ç†å‘˜ï¼‰ | 24 å°æ—¶å†… | DBA ç¦»èŒå‰å¯èƒ½å¤‡ä»½äº†å¯†é’¥ |
| ğŸŸ¢ ä½ | å¯†é’¥è¶…è¿‡è½®æ¢å‘¨æœŸ | 1 å‘¨å†… | å¯†é’¥å·²ä½¿ç”¨ 2 å¹´ï¼ˆæŒ‰ç­–ç•¥åº”è½®æ¢ï¼‰ |

#### æ“ä½œæ­¥éª¤ï¼ˆSOPï¼‰

```plaintext
é˜¶æ®µ 1ï¼šåº”æ€¥å“åº”ï¼ˆ0-1å°æ—¶ï¼‰
  â”œâ”€ 01. ç¡®è®¤æ³„éœ²èŒƒå›´ï¼ˆå“ªäº›å¯†é’¥ã€ä½•æ—¶æ³„éœ²ã€è°å¯èƒ½çœ‹åˆ°ï¼‰
  â”œâ”€ 02. ç«‹å³ç”Ÿæˆæ–°å¯†é’¥ key_v2ï¼ˆåœ¨ KMS ä¸­ç”Ÿæˆï¼‰
  â”œâ”€ 03. å°†æ—§å¯†é’¥ key_v1 æ ‡è®°ä¸º "compromised"ï¼ˆç«‹å³åœç”¨ï¼‰
  â””â”€ 04. é€šçŸ¥æ‰€æœ‰ç›¸å…³å›¢é˜Ÿï¼ˆå¼€å‘/è¿ç»´/å®‰å…¨ï¼‰

é˜¶æ®µ 2ï¼šç³»ç»Ÿæ›´æ–°ï¼ˆ1-4å°æ—¶ï¼‰
  â”œâ”€ 05. æ›´æ–°æ‰€æœ‰æœåŠ¡é…ç½®ï¼ˆæŒ‡å‘ key_v2ï¼‰
  â”œâ”€ 06. æ»šåŠ¨é‡å¯æœåŠ¡ï¼ˆé¿å…å…¨éƒ¨ä¸­æ–­ï¼‰
  â”œâ”€ 07. éªŒè¯æœåŠ¡å¯ç”¨æ€§ï¼ˆç›‘æ§é”™è¯¯ç‡/æˆåŠŸç‡ï¼‰
  â””â”€ 08. ç¡®è®¤æ—§å¯†é’¥ä¸å†è¢«ä½¿ç”¨ï¼ˆå®¡è®¡æ—¥å¿—ï¼‰

é˜¶æ®µ 3ï¼šå®¡è®¡ä¸è¯„ä¼°ï¼ˆ4-24å°æ—¶ï¼‰
  â”œâ”€ 09. å¯¼å‡º key_v1 çš„å†å²è®¿é—®è®°å½•
  â”œâ”€ 10. åˆ†æå“ªäº›æ•°æ®å¯èƒ½å·²è¢«è§£å¯†ï¼ˆæ—¶é—´çª—å£åˆ†æï¼‰
  â”œâ”€ 11. è¯„ä¼°ä¸šåŠ¡å½±å“ï¼ˆæ˜¯å¦éœ€è¦é€šçŸ¥ç”¨æˆ·/ç›‘ç®¡æœºæ„ï¼‰
  â””â”€ 12. å†³å®šæ˜¯å¦éœ€è¦é‡åŠ å¯†å†å²æ•°æ®

é˜¶æ®µ 4ï¼šå–„åä¸æ€»ç»“ï¼ˆ1-7å¤©ï¼‰
  â”œâ”€ 13. ç”Ÿæˆäº‹ä»¶æŠ¥å‘Šï¼ˆæ—¶é—´çº¿/å½±å“èŒƒå›´/åº”å¯¹æªæ–½ï¼‰
  â”œâ”€ 14. æ”¹è¿›æªæ–½ï¼ˆå¦‚åŠ å¼ºæƒé™æ§åˆ¶/å¢åŠ å®¡è®¡ï¼‰
  â”œâ”€ 15. å½»åº•åˆ é™¤ key_v1ï¼ˆåœ¨ä¿ç•™å®¡è®¡æœŸåï¼‰
  â””â”€ 16. å›¢é˜Ÿå¤ç›˜ä¼šè®®ï¼ˆæ€»ç»“æ•™è®­/æ›´æ–°æµç¨‹ï¼‰
```

### é¢˜ 4 å‚è€ƒç­”æ¡ˆï¼ˆHMAC vs æ•°å­—ç­¾åï¼‰

| å¯¹æ¯”ç»´åº¦ | HMAC | æ•°å­—ç­¾åï¼ˆRSA/ECDSAï¼‰ |
|----------|------|----------------------|
| **ä¿¡ä»»æ¨¡å‹** | åŒæ–¹äº’ä¿¡ï¼ˆå…±äº«å¯†é’¥ï¼‰ | å•å‘ä¿¡ä»»ï¼ˆå…¬é’¥å¯å…¬å¼€ï¼‰ |
| **å…¸å‹åœºæ™¯** | å¾®æœåŠ¡ A è°ƒç”¨å¾®æœåŠ¡ B | APP éªŒè¯æœåŠ¡å™¨å“åº” |
| **ä¸å¯å¦è®¤æ€§** | âŒ åŒæ–¹éƒ½èƒ½ç”Ÿæˆï¼Œæ— æ³•è¯æ˜æ˜¯è° | âœ… åªæœ‰ç§é’¥æŒæœ‰è€…èƒ½ç”Ÿæˆ |
| **å¯†é’¥åˆ†å‘** | å›°éš¾ï¼ˆéœ€è¦å®‰å…¨é€šé“ï¼‰ | ç®€å•ï¼ˆå…¬é’¥å¯å…¬å¼€ï¼‰ |
| **æ€§èƒ½** | å¿«ï¼ˆå‡ å¾®ç§’ï¼‰ | æ…¢ï¼ˆå‡ æ¯«ç§’ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | å†…éƒ¨ç³»ç»Ÿã€å¯¹ç§°ä¿¡ä»» | å…¬å¼€ç³»ç»Ÿã€éœ€è¦èº«ä»½è¯æ˜ |

**é€‰å‹å†³ç­–æ ‘**ï¼š

```plaintext
éœ€è¦ç­¾åçš„åœºæ™¯
  â”‚
  â”œâ”€ åŒæ–¹æ˜¯å¦äº’ä¿¡ï¼Ÿ
  â”‚   â”œâ”€ æ˜¯ï¼ˆå¦‚å¾®æœåŠ¡å†…éƒ¨è°ƒç”¨ï¼‰
  â”‚   â”‚   â””â”€ ç”¨ HMACï¼ˆæ€§èƒ½é«˜ï¼Œå®ç°ç®€å•ï¼‰
  â”‚   â””â”€ å¦ï¼ˆå¦‚ç”¨æˆ· APP â† æœåŠ¡å™¨ï¼‰
  â”‚       â””â”€ ç”¨æ•°å­—ç­¾åï¼ˆå…¬é’¥å¯å…¬å¼€åˆ†å‘ï¼‰
  â”‚
  â”œâ”€ æ˜¯å¦éœ€è¦"ä¸å¯å¦è®¤æ€§"ï¼Ÿ
  â”‚   â”œâ”€ æ˜¯ï¼ˆå¦‚åˆåŒç­¾ç½²ã€ä»£ç å‘å¸ƒï¼‰
  â”‚   â”‚   â””â”€ å¿…é¡»ç”¨æ•°å­—ç­¾åï¼ˆHMAC åŒæ–¹éƒ½èƒ½ç”Ÿæˆï¼Œæ— æ³•è¯æ˜ï¼‰
  â”‚   â””â”€ å¦ï¼ˆåªè¦é˜²ç¯¡æ”¹å³å¯ï¼‰
  â”‚       â””â”€ HMAC å³å¯
  â”‚
  â””â”€ æ˜¯å¦éœ€è¦å¤šæ–¹éªŒè¯ï¼Ÿ
      â”œâ”€ æ˜¯ï¼ˆå¦‚ JWT è¢«å¤šä¸ªå¾®æœåŠ¡éªŒè¯ï¼‰
      â”‚   â””â”€ ç”¨ RS256ï¼ˆå…¬é’¥åˆ†å‘ç®€å•ï¼‰
      â””â”€ å¦ï¼ˆåªæœ‰ä¸€ä¸ªæœåŠ¡éªŒè¯ï¼‰
          â””â”€ HS256 æˆ– RS256 éƒ½å¯ä»¥
```

**çœŸå®æ¡ˆä¾‹å¯¹æ¯”**ï¼š

1. **AWS API ç­¾å**ï¼ˆç”¨ HMACï¼‰
   - åœºæ™¯ï¼šå®¢æˆ·ç«¯è°ƒç”¨ AWS API
   - åŸå› ï¼šå®¢æˆ·ç«¯å’Œ AWS éƒ½æŒæœ‰ Access Key Secretï¼ŒåŒæ–¹äº’ä¿¡
   - ä¼˜åŠ¿ï¼šæ€§èƒ½é«˜ï¼Œæ— éœ€è¯ä¹¦ç®¡ç†

2. **Apple APNs æ¨é€**ï¼ˆç”¨æ•°å­—ç­¾åï¼‰
   - åœºæ™¯ï¼šæœåŠ¡å™¨ â†’ Apple æ¨é€æœåŠ¡ â†’ ç”¨æˆ·è®¾å¤‡
   - åŸå› ï¼šéœ€è¦è¯æ˜æ¨é€æ¥è‡ªç‰¹å®š APPï¼ˆä¸å¯å¦è®¤æ€§ï¼‰
   - ä¼˜åŠ¿ï¼šApple å¯ä»¥éªŒè¯æ¨é€æ¥æºï¼Œé˜²æ­¢ä¼ªé€ 

3. **JWT in å¾®æœåŠ¡æ¶æ„**
   - å•ä½“åº”ç”¨ï¼šç”¨ HS256ï¼ˆåªæœ‰ä¸€ä¸ªæœåŠ¡éªŒè¯ï¼Œå…±äº«å¯†é’¥ï¼‰
   - å¾®æœåŠ¡ï¼šç”¨ RS256ï¼ˆå¤šä¸ªæœåŠ¡éªŒè¯ï¼Œåˆ†å‘å…¬é’¥æ›´å®‰å…¨ï¼‰

## å­¦ä¹ æˆæœç¤ºä¾‹å¡«å†™ï¼ˆå¯ç…§æŠ„ï¼‰

### æˆªå›¾ä¸è¯æ®ï¼ˆç¤ºä¾‹ï¼‰

- `images/day013_pbkdf2_vs_sha256.png`ï¼šæ€§èƒ½å¯¹æ¯”è¾“å‡ºï¼ˆPBKDF2 æ…¢ 5000 å€ï¼‰
- `images/day013_bcrypt_demo.png`ï¼šbcrypt æ³¨å†Œ/ç™»å½•æµç¨‹è¾“å‡º

### å…³é”®å‘½ä»¤ä¸è¾“å‡ºï¼ˆç¤ºä¾‹ï¼‰

**PBKDF2 vs SHA-256 æ€§èƒ½å¯¹æ¯”**ï¼š

```
SHA-256:  8e35c2cd3bf6641bdb0e2050... time=0.0234 ms
PBKDF2:   c5a0f8e7d4b3c2a1f9e8d7c6... time=123.4567 ms

æ€§èƒ½å¯¹æ¯”ï¼šPBKDF2 æ¯” SHA-256 æ…¢ 5279 å€
âœ… è¿™å°±æ˜¯ KDF çš„ç›®çš„ï¼šè®©æ”»å‡»è€…çˆ†ç ´æˆæœ¬æŒ‡æ•°çº§ä¸Šå‡
```

**bcrypt æ¼”ç¤ºè¾“å‡º**ï¼š

```
=== æ³¨å†Œæµç¨‹ ===
å¯†ç å“ˆå¸Œ: $2b$12$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p/.CPY.tHOHEa2xFH0p3.O
è€—æ—¶: 267.89 ms
è§£æ: $2b (ç®—æ³•) / $12 (work_factor) / 22å­—ç¬¦salt / 31å­—ç¬¦hash

=== ç™»å½•æµç¨‹ï¼ˆæ­£ç¡®å¯†ç ï¼‰===
éªŒè¯ç»“æœ: âœ… å¯†ç æ­£ç¡®
è€—æ—¶: 271.23 ms

=== ç™»å½•æµç¨‹ï¼ˆé”™è¯¯å¯†ç ï¼‰===
éªŒè¯ç»“æœ: âŒ å¯†ç é”™è¯¯
è€—æ—¶: 268.45 ms

ğŸ’¡ æ³¨æ„ï¼šå³ä½¿å¯†ç é”™è¯¯ï¼ŒéªŒè¯æ—¶é—´ä¹Ÿå·®ä¸å¤šï¼ˆ268.45 msï¼‰
   è¿™æ˜¯é˜²å¾¡æªæ–½ï¼šé˜²æ­¢æ”»å‡»è€…é€šè¿‡æ—¶é—´å·®åˆ¤æ–­å¯†ç å¯¹é”™
```

### ç»“è®ºä¸åæ€ï¼ˆç¤ºä¾‹ï¼‰

**æˆ‘ä»Šå¤©ææ¸…æ¥šäº†**ï¼š

- å¯†ç å­˜å‚¨ä¸æ˜¯"åŠ å¯†å­˜"ï¼Œè€Œæ˜¯"æ…¢å“ˆå¸Œ(KDF)+salt+å‚æ•°"
- KDF çš„"æ…¢"ä¸æ˜¯ç¼ºç‚¹ï¼Œæ˜¯ç”¨æ¥æŠ—çˆ†ç ´çš„ç‰¹æ€§ï¼ˆå•æ¬¡ 100-300ms å¯¹ç”¨æˆ·æ— æ„Ÿï¼Œå¯¹æ”»å‡»è€…è‡´å‘½ï¼‰
- å¯†é’¥ç®¡ç†æ¯”ç®—æ³•é€‰æ‹©æ›´é‡è¦ï¼šå†å¼ºçš„åŠ å¯†ï¼Œå¯†é’¥ç¡¬ç¼–ç ä¹Ÿç™½æ­
- HMAC é€‚åˆåŒæ–¹äº’ä¿¡ï¼Œæ•°å­—ç­¾åé€‚åˆéœ€è¦"ä¸å¯å¦è®¤æ€§"çš„åœºæ™¯

**æˆ‘å·®ç‚¹ææ··çš„æ˜¯**ï¼š

- ä»¥ä¸º"AES åŠ å¯†å­˜å¯†ç "å°±å®‰å…¨äº†ï¼Œå…¶å®å¯†ç ä¸éœ€è¦å¯é€†ï¼ˆè®¤è¯å‡­æ® vs æ•æ„Ÿæ•°æ®ï¼‰
- ä»¥ä¸º IV è¦ä¿å¯†ï¼Œå…¶å® IV å¯ä»¥å…¬å¼€ä½†ä¸èƒ½é‡å¤
- ä»¥ä¸º HMAC å’Œæ•°å­—ç­¾åä¸€æ ·ï¼Œå…¶å® HMAC åŒæ–¹éƒ½èƒ½ç”Ÿæˆï¼ˆæ— ä¸å¯å¦è®¤æ€§ï¼‰

**æ˜å¤©æˆ‘è¦ç»§ç»­è¡¥çš„æ˜¯**ï¼š

- å¯†é’¥è½®æ¢çš„å…·ä½“å®æ–½ï¼ˆé…ç½®ä¸­å¿ƒ Vault çš„ä½¿ç”¨ï¼‰
- è¯ä¹¦é“¾éªŒè¯æµç¨‹ï¼ˆå¦‚ä½•ä»æ ¹ CA åˆ°ç½‘ç«™è¯ä¹¦ä¸€å±‚å±‚éªŒè¯ï¼‰
- å®é™…æŠ“åŒ…çœ‹ TLS æ¡æ‰‹è¿‡ç¨‹ï¼ˆClientHello/ServerHello/Certificateï¼‰

**æœ¬æ¬¡å­¦ä¹ è€—æ—¶**ï¼šçº¦ 3 å°æ—¶

**æŒæ¡ç¨‹åº¦è‡ªè¯„**ï¼š

- [x] ğŸ˜ƒ å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡å¹¶ç†è§£åŸç†
